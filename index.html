<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>クイズHP - 究極の学習パートナー</title>

    <!-- PWA関連 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="クイズHP">
    <meta name="theme-color" content="#4f46e5">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/4f46e5/ffffff?text=Q">

    <!-- 外部ライブラリとフォント -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-color-hover: #4338ca;
        }
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; -webkit-tap-highlight-color: transparent; }
        .page { display: none; }
        .page.active { display: block; }
        #focus-page.page.active { display: flex; }
        #focus-page { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid var(--primary-color); width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .primary-bg { background-color: var(--primary-color); }
        .primary-bg-hover:hover { background-color: var(--primary-color-hover); }
        .primary-text { color: var(--primary-color); }
        .toggle-checkbox { appearance: none; width: 40px; height: 20px; background: #ccc; border-radius: 20px; position: relative; cursor: pointer; transition: background .3s; }
        .toggle-checkbox:before { content: ''; position: absolute; width: 16px; height: 16px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: transform .3s; }
        .toggle-checkbox:checked { background: var(--primary-color); }
        .toggle-checkbox:checked:before { transform: translateX(20px); }
        #theme-purchase-modal, #background-purchase-modal { z-index: 60; }

        /* ミニタイマー */
        #mini-timer-container {
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.4s;
            transform: translateY(150%);
            opacity: 0;
            pointer-events: none;
        }
        #mini-timer-container.visible {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
        #mini-timer-progress-bar {
            transition: width 0.5s linear;
        }
        /* 集中モード背景 */
        .focus-view-bg {
            background-size: cover;
            background-position: center;
            transition: background-image 0.5s ease-in-out;
        }
        /* 通知日選択ボタン */
        .day-btn.selected {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        #app-container {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 overflow-hidden h-screen antialiased">

    <div id="app-container" class="h-full w-full flex flex-col max-w-lg mx-auto shadow-2xl">
        
        <header class="bg-white dark:bg-gray-800/80 backdrop-blur-sm z-30 p-4 flex items-center justify-between border-b border-gray-200 dark:border-gray-700 sticky top-0">
            <h1 id="header-title" class="text-xl font-bold text-gray-900 dark:text-white">ホーム</h1>
            <button id="lp-button" class="flex items-center space-x-2 bg-yellow-400/20 text-yellow-600 dark:text-yellow-400 rounded-full px-3 py-1 hover:bg-yellow-400/30 transition-colors">
                <i data-lucide="star" class="w-4 h-4 fill-current"></i>
                <span id="lp-display" class="font-bold text-sm">0 LP</span>
            </button>
        </header>

        <main class="flex-grow overflow-y-auto pb-20">
            <div id="home-page" class="page active p-4 space-y-6">
                <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm text-center">
                    <p id="today-date" class="text-lg font-semibold text-gray-600 dark:text-gray-300"></p>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 flex items-center"><i data-lucide="calendar-clock" class="w-5 h-5 mr-2 primary-text"></i> カウントダウン</h2>
                        <button id="add-countdown-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                    <div id="countdown-list" class="space-y-3"></div>
                </div>
                <div>
                    <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 flex items-center mb-3"><i data-lucide="calendar-check-2" class="w-5 h-5 mr-2 primary-text"></i> 今日の復習</h2>
                    <div id="review-list" class="space-y-3"></div>
                </div>
                 <div>
                    <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 flex items-center mb-3"><i data-lucide="award" class="w-5 h-5 mr-2 primary-text"></i> 最近獲得した称号</h2>
                    <div id="recent-titles" class="flex space-x-3 overflow-x-auto pb-2"></div>
                </div>
            </div>

            <div id="study-page" class="page p-4">
                <div class="mb-6">
                    <h2 class="text-lg font-semibold mb-3 text-gray-700 dark:text-gray-300 flex items-center"><i data-lucide="pin" class="w-5 h-5 mr-2 primary-text"></i> ピン留め</h2>
                    <div id="pinned-quizzes" class="grid grid-cols-1 gap-3"></div>
                </div>
                <div>
                    <h2 class="text-lg font-semibold mb-3 text-gray-700 dark:text-gray-300 flex items-center"><i data-lucide="book-marked" class="w-5 h-5 mr-2 primary-text"></i> すべてのクイズ</h2>
                    <div id="filter-container" class="flex space-x-2 mb-4 overflow-x-auto pb-2"></div>
                    <div id="all-quizzes" class="grid grid-cols-1 gap-3"></div>
                </div>
            </div>             
            <div id="focus-page" class="page p-4 flex flex-col h-full"> 
                <div class="flex-shrink-0 mb-4">
                    <div class="flex bg-gray-200 dark:bg-gray-700 rounded-lg p-1">
                        <button class="focus-mode-btn flex-1 p-2 rounded-md text-sm font-semibold" data-mode="timer">タイマー</button>
                        <button class="focus-mode-btn flex-1 p-2 rounded-md text-sm font-semibold" data-mode="stopwatch">ストップウォッチ</button>
                    </div>
                </div>

                <div id="timer-view" class="focus-view-bg flex-grow flex flex-col items-center justify-center text-center relative text-white rounded-lg">
                    <div class="absolute inset-0 bg-black/50 rounded-lg"></div>
                    <div class="relative z-10 p-4">
                        <div class="flex items-center justify-center space-x-2 mb-4">
                            <button class="timer-duration-btn bg-white/20 px-3 py-1 rounded-full text-sm" data-time="300">5分</button>
                            <button class="timer-duration-btn bg-white/20 px-3 py-1 rounded-full text-sm" data-time="900">15分</button>
                            <button class="timer-duration-btn bg-white/40 px-3 py-1 rounded-full text-sm" data-time="1500">25分</button>
                            <button class="timer-duration-btn bg-white/20 px-3 py-1 rounded-full text-sm" data-time="2700">45分</button>
                        </div>
                         <div class="flex justify-center items-center space-x-2 mb-6">
                            <input id="custom-time-input" type="number" min="1" class="w-24 bg-white/20 text-white placeholder-white/70 text-center font-bold p-2 rounded-lg" placeholder="分">
                            <button id="set-custom-time-btn" class="bg-white/30 hover:bg-white/40 text-white font-bold p-2 rounded-lg"><i data-lucide="check" class="w-6 h-6"></i></button>
                        </div>
                        <div id="focus-timer-display" class="text-7xl font-bold tabular-nums mb-6">25:00</div>
                        <button id="focus-start-btn" class="primary-bg primary-bg-hover text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg flex items-center mx-auto"><i data-lucide="play" class="w-6 h-6 mr-2"></i>集中モード開始</button>
                        <div id="focus-controls" class="hidden flex flex-wrap items-center justify-center gap-4">
                            <button id="focus-pause-btn" class="bg-gray-500/70 hover:bg-gray-600/70 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg flex items-center"><i data-lucide="pause" class="w-6 h-6 mr-2"></i>一時停止</button>
                            <button id="focus-end-btn" class="bg-red-500/70 hover:bg-red-600/70 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg flex items-center"><i data-lucide="stop-circle" class="w-6 h-6 mr-2"></i>終了</button>
                        </div>
                    </div>
                </div>

                <div id="stopwatch-view" class="focus-view-bg hidden flex-grow flex-col items-center justify-center text-center relative text-white rounded-lg">
                     <div class="absolute inset-0 bg-black/50 rounded-lg"></div>
                     <div class="relative z-10 p-4">
                        <div id="stopwatch-display" class="text-7xl font-bold tabular-nums mb-6">00:00:00</div>
                         <button id="stopwatch-start-btn" class="primary-bg primary-bg-hover text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg flex items-center mx-auto"><i data-lucide="play" class="w-6 h-6 mr-2"></i>スタート</button>
                        <div id="stopwatch-controls" class="hidden flex flex-wrap items-center justify-center gap-4">
                            <button id="stopwatch-pause-btn" class="bg-gray-500/70 hover:bg-gray-600/70 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg flex items-center"><i data-lucide="pause" class="w-6 h-6 mr-2"></i>一時停止</button>
                            <button id="stopwatch-end-btn" class="bg-red-500/70 hover:bg-red-600/70 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg flex items-center"><i data-lucide="flag" class="w-6 h-6 mr-2"></i>記録して終了</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="my-chart-page" class="page p-4 space-y-6">
                <div>
                    <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 flex items-center mb-3"><i data-lucide="bar-chart-3" class="w-5 h-5 mr-2 primary-text"></i> 週間学習レポート</h2>
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow"><canvas id="study-time-chart"></canvas></div>
                </div>
                <div>
                    <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 flex items-center mb-3"><i data-lucide="pie-chart" class="w-5 h-5 mr-2 primary-text"></i> 教科別 理解度カルテ</h2>
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow"><canvas id="subject-radar-chart"></canvas></div>
                </div>
                <div>
                    <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 flex items-center mb-3"><i data-lucide="target" class="w-5 h-5 mr-2 primary-text"></i> 弱点克服リスト</h2>
                    <div id="weakness-list" class="space-y-3"></div>
                </div>
            </div>

            <div id="settings-page" class="page p-4 space-y-4">
                <h2 class="text-2xl font-bold mb-2">設定</h2>
                <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                    <h3 class="font-semibold mb-2">通知設定</h3>
                    <button id="notification-permission-btn" class="w-full primary-bg primary-bg-hover text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center mb-4"><i data-lucide="bell-ring" class="w-5 h-5 mr-2"></i>ブラウザ通知を許可</button>
                    <div class="flex items-center justify-between"><p>復習リマインダー通知</p><input type="checkbox" id="review-notification-toggle" class="toggle-checkbox"></div>
                </div>
                <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                     <h3 class="font-semibold mb-2">テーマカラーを選択</h3>
                     <div id="theme-selector" class="grid grid-cols-4 gap-4"></div>
                </div>
                <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                    <h3 class="font-semibold mb-2">アプリの壁紙を選択</h3>
                    <div id="background-selector" class="grid grid-cols-3 gap-4"></div>
                    <hr class="my-4 border-gray-200 dark:border-gray-600">
                    <div class="flex items-center justify-between">
                        <p class="font-semibold">壁紙をアプリ全体に適用</p>
                        <input type="checkbox" id="background-scope-toggle" class="toggle-checkbox">
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                    <h3 class="font-semibold mb-2">外観</h3>
                    <div id="manual-theme-container" class="hidden">
                        <div class="flex items-center justify-between">
                            <p>ダークモード</p>
                            <input type="checkbox" id="manual-dark-mode-toggle" class="toggle-checkbox">
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                    <h3 class="font-semibold mb-2">アプリのインストール</h3>
                    <button id="install-button" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center hidden"><i data-lucide="download-cloud" class="w-5 h-5 mr-2"></i>ホーム画面に追加</button>
                </div>
            </div>
        </main>

        <div id="mini-timer-container" class="fixed bottom-20 left-0 right-0 max-w-lg mx-auto px-4 z-20">
             <div id="mini-timer-bar" class="w-full bg-gray-800/90 backdrop-blur-sm rounded-lg shadow-lg flex items-center p-2 space-x-3 cursor-pointer">
                <div class="flex items-center space-x-3 flex-grow min-w-0">
                    <i data-lucide="timer" class="w-5 h-5 primary-text flex-shrink-0"></i>
                    <span id="mini-timer-text" class="text-sm font-mono text-white truncate"></span>
                </div>
                <div class="w-1/3 h-1.5 bg-gray-600 rounded-full overflow-hidden flex-shrink-0">
                    <div id="mini-timer-progress-bar" class="h-full primary-bg rounded-full"></div>
                </div>
                <button id="close-mini-timer-btn" class="p-1 text-gray-400 hover:text-white flex-shrink-0">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <nav class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto h-16 bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm border-t border-gray-200 dark:border-gray-700 flex justify-around items-center shadow-top z-20">
            <button class="tab-btn flex flex-col items-center justify-center w-full h-full primary-text" data-page="home-page" data-title="ホーム"><i data-lucide="home" class="w-6 h-6"></i><span class="text-xs mt-1">ホーム</span></button>
            <button class="tab-btn flex flex-col items-center justify-center w-full h-full text-gray-500" data-page="study-page" data-title="学習"><i data-lucide="book-marked" class="w-6 h-6"></i><span class="text-xs mt-1">学習</span></button>
            <button class="tab-btn flex flex-col items-center justify-center w-full h-full text-gray-500" data-page="focus-page" data-title="集中"><i data-lucide="timer" class="w-6 h-6"></i><span class="text-xs mt-1">集中</span></button>
            <button class="tab-btn flex flex-col items-center justify-center w-full h-full text-gray-500" data-page="my-chart-page" data-title="マイカルテ"><i data-lucide="clipboard-list" class="w-6 h-6"></i><span class="text-xs mt-1">マイカルテ</span></button>
            <button class="tab-btn flex flex-col items-center justify-center w-full h-full text-gray-500" data-page="settings-page" data-title="設定"><i data-lucide="settings" class="w-6 h-6"></i><span class="text-xs mt-1">設定</span></button>
        </nav>
    </div>

    <!-- ===== モーダル ===== -->
    <div id="quiz-modal" class="fixed inset-0 bg-black/70 z-50 flex-col hidden"><div class="w-full h-full max-w-lg mx-auto bg-gray-100 dark:bg-gray-900 flex flex-col"><header class="p-3 flex items-center justify-between shadow-md bg-white dark:bg-gray-800"><h2 id="quiz-modal-title" class="truncate font-bold"></h2><button class="close-modal-btn p-1" data-modal="quiz-modal"><i data-lucide="x"></i></button></header><div class="flex-grow relative"><div class="absolute inset-0 flex items-center justify-center"><div id="loader"></div></div><iframe id="quiz-iframe" class="w-full h-full border-0 invisible" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe></div></div></div>
    <div id="assessment-modal" class="fixed inset-0 bg-black/70 z-50 items-center justify-center hidden p-4"><div class="bg-white dark:bg-gray-700 rounded-lg shadow-xl w-full max-w-sm p-6 text-center"><h2 class="text-xl font-bold mb-4">お疲れ様でした！</h2><p class="mb-6">このクイズの理解度を記録しよう</p><div class="flex justify-around"><button class="assessment-btn p-2" data-level="3"><i data-lucide="award" class="w-10 h-10 text-yellow-400"></i><p>完璧！</p></button><button class="assessment-btn p-2" data-level="2"><i data-lucide="thumbs-up" class="w-10 h-10 text-green-400"></i><p>まあまあ</p></button><button class="assessment-btn p-2" data-level="1"><i data-lucide="book-open-check" class="w-10 h-10 text-blue-400"></i><p>要復習</p></button></div></div></div>
    <div id="theme-purchase-modal" class="fixed inset-0 bg-black/70 z-50 items-center justify-center hidden p-4">
    <div class="bg-white dark:bg-gray-700 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
        <h2 id="theme-purchase-title" class="text-xl font-bold mb-2"></h2>
        <div id="theme-preview" class="w-20 h-20 rounded-full mx-auto my-4 border-4 border-gray-200 dark:border-gray-600 shadow-inner"></div>
        <p id="theme-purchase-cost" class="mb-6"></p>
        <div class="flex justify-center space-x-4">
            <button id="theme-purchase-cancel" class="bg-gray-200 dark:bg-gray-600 px-6 py-2 rounded-lg">やめる</button>
            <button id="theme-purchase-confirm" class="primary-bg primary-bg-hover text-white px-6 py-2 rounded-lg transition-colors disabled:bg-gray-400 dark:disabled:bg-gray-500 disabled:cursor-not-allowed">交換する</button>
        </div>
    </div>
</div>

<div id="background-purchase-modal" class="fixed inset-0 bg-black/70 z-50 items-center justify-center hidden p-4">
    <div class="bg-white dark:bg-gray-700 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
        <h2 id="background-purchase-title" class="text-xl font-bold mb-2"></h2>
        <div id="background-preview" class="w-full aspect-[8/16] rounded-lg mx-auto my-4 bg-gray-200 dark:bg-gray-800 bg-cover bg-center shadow-inner"></div>
        <p id="background-purchase-cost" class="mb-6"></p>
        <div class="flex justify-center space-x-4">
            <button id="background-purchase-cancel" class="bg-gray-200 dark:bg-gray-600 px-6 py-2 rounded-lg">やめる</button>
            <button id="background-purchase-confirm" class="primary-bg primary-bg-hover text-white px-6 py-2 rounded-lg transition-colors disabled:bg-gray-400 dark:disabled:bg-gray-500 disabled:cursor-not-allowed">交換する</button>
        </div>
    </div>
</div>
    
    <div id="countdown-modal" class="fixed inset-0 bg-black/70 z-50 items-center justify-center hidden p-4"><div class="bg-white dark:bg-gray-700 rounded-lg shadow-xl w-full max-w-sm p-6"><h2 id="countdown-modal-title" class="text-xl font-bold mb-4">カウントダウン設定</h2><div class="space-y-4"><input id="countdown-name" type="text" placeholder="イベント名 (例: 期末テスト)" class="w-full p-2 border rounded dark:bg-gray-800 dark:border-gray-600"><input id="countdown-date" type="date" class="w-full p-2 border rounded dark:bg-gray-800 dark:border-gray-600"></div><div class="mt-6"><h3 class="font-semibold mb-2">通知設定</h3><div class="bg-gray-100 dark:bg-gray-800 p-3 rounded-lg space-y-3"><div class="flex items-center justify-between"><p>通知をオンにする</p><input type="checkbox" id="countdown-notification-toggle" class="toggle-checkbox"></div><div id="countdown-notification-details" class="space-y-3"><div class="flex items-center justify-between"><p>通知時刻</p><input id="countdown-notification-time" type="time" class="p-1 border rounded dark:bg-gray-600 dark:border-gray-500"></div><div><p class="mb-2">通知するタイミング (複数選択可)</p><div id="countdown-notification-days" class="flex flex-wrap gap-2"></div></div></div></div></div><div class="flex justify-between items-center mt-6"><button id="countdown-delete-btn" class="text-red-500 hover:text-red-700 font-semibold p-2 hidden"><i data-lucide="trash-2" class="w-5 h-5 inline-block mr-1"></i>削除</button><div class="flex space-x-2"><button id="countdown-cancel-btn" class="bg-gray-200 dark:bg-gray-600 px-6 py-2 rounded-lg">キャンセル</button><button id="countdown-save-btn" class="primary-bg primary-bg-hover text-white px-6 py-2 rounded-lg">保存</button></div></div></div></div>

    <div id="point-details-modal" class="fixed inset-0 bg-black/70 z-50 items-center justify-center hidden p-4"><div class="bg-white dark:bg-gray-700 rounded-lg shadow-xl w-full max-w-sm p-6"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">マイステータス</h2><button id="close-point-modal-btn" class="p-1"><i data-lucide="x"></i></button></div><div class="space-y-6"><div class="text-center"><p class="text-sm text-gray-500">現在の学習ポイント</p><p class="text-4xl font-bold primary-text" id="modal-lp-display"></p></div><div><h3 class="font-semibold mb-2">アイテム交換所</h3><div id="modal-theme-selector" class="grid grid-cols-4 gap-4"></div></div><div><h3 class="font-semibold mb-2">壁紙 交換所</h3><div id="modal-background-selector" class="grid grid-cols-3 gap-2"></div></div><div><h3 class="font-semibold mb-2">獲得した称号</h3><div id="modal-titles-list" class="flex flex-wrap gap-2"></div></div></div></div></div>
    <div id="toast" class="fixed top-5 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-all duration-300 z-50 transform -translate-y-10"></div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const initialData = {
                quizzes: [
                    { id: 'math1', title: "数学 - 正負の数", subject: "数学", genre: "中1", tags: ['english1'], url: "https://docs.google.com/forms/d/e/1FAIpQLScsC0BFa_3gY-f-u4pW8Q22o_l3c0T-t_9c3z-q8pY6X-u8qQ/viewform?usp=sf_link" },
                    { id: 'english1', title: "英語 - be動詞", subject: "英語", genre: "中1", tags: ['math1', 'history1'], url: "https://docs.google.com/forms/d/e/1FAIpQLSfB_iJ3-s-W-hT5pQ8bF_cK6dL_xG9z-u0bM-pC7oR8sT-w_w/viewform?usp=sf_link" },
                    { id: 'science1', title: "理科 - 植物のつくり", subject: "理科", genre: "中1", tags: [], url: "https://docs.google.com/forms/d/e/1FAIpQLSfp-24sW_4xT8d_aK_b_nL5e-pX7a-j8vN-qA9rR_cT_uL-vQ/viewform?usp=sf_link" },
                    { id: 'japanese1', title: "国語 - 枕草子", subject: "国語", genre: "古典", tags: ['history1'], url: "https://docs.google.com/forms/d/e/1FAIpQLSe-0P7p_L-rT9c-yS_eD-wA9iR_bO8kM-nL-u_V-iE7xS-tQ/viewform?usp=sf_link" },
                    { id: 'history1', title: "社会 - 鎌倉時代", subject: "社会", genre: "歴史", tags: ['japanese1'], url: "https://docs.google.com/forms/d/e/1FAIpQLSdi-tYv_zW-a_c_iR_s-vI_oN-eL_a-yP-sN_e-rB_c_uK_wQ/viewform?usp=sf_link" },
                ],
                titles: [
                    { id: 'math_master', name: '数学マスター', condition: (s) => initialData.quizzes.filter(q => q.subject === '数学' && s.progress[q.id]?.level === 3).length >= 1 },
                    { id: 'perfect_day', name: 'パーフェクトデイ', condition: (s) => Object.values(s.progress).filter(p => new Date(p.date).toDateString() === new Date().toDateString() && p.level === 3).length >= 3 },
                    { id: 'focus_1hr', name: '集中力の初星', condition: (s) => s.focus.totalTime >= 3600 },
                ],
                themes: {
                    default: { name: 'デフォルト', color: '#4f46e5', hover: '#4338ca', cost: 0 },
                    green: { name: 'フォレスト', color: '#16a34a', hover: '#15803d', cost: 100 },
                    red: { name: 'サンセット', color: '#dc2626', hover: '#b91c1c', cost: 150 },
                    orange: { name: 'ビタミン', color: '#f97316', hover: '#ea580c', cost: 200 },
                    purple: { name: 'ミッドナイト', color: '#7c3aed', hover: '#6d28d9', cost: 250 },
                    pink: { name: 'チェリー', color: '#db2777', hover: '#be185d', cost: 300 },
                    teal: { name: 'オーシャン', color: '#0d9488', hover: '#0f766e', cost: 350 },
                },
                backgrounds: {
                    default: { name: 'デフォルト', url: '', cost: 0 , tone: 'system' },
                    sky: { name: '青空と流れ星', url: 'okumono_hosisoratate8.png', cost: 500, tone: 'light' },
                    night: { name: '手書きゆるドット', url: 'https://sozaino.site/wp-content/uploads/2022/01/yurudot32.png', cost: 700, tone: 'light' },
                    sdotb: { name: 'シャワードット(ブルー)', url: 'https://sozaino.site/wp-content/uploads/2020/11/sai-4.png', cost: 700, tone: 'light' },
                    utyuu: { name: '壮大な宇宙', url: 'https://sozaino.site/wp-content/uploads/2021/02/utyuu.jpg', cost: 700, tone: 'dark' },
                    jyanguru: { name: 'ジャングル', url: 'https://sozaino.site/wp-content/uploads/2025/07/okumono_jungle1.png', cost: 700, tone: 'dark' },
                    wapop: { name: '和ポップ（ピンク）', url: 'okumono_wapop3.png', cost: 700, tone: 'dark' },
                }
            };

            let state;
            let chartInstances = {};
            let focusTimer = { interval: null, defaultTime: 1500, timeLeft: 1500, isRunning: false, isPaused: false };
            let stopwatch = { interval: null, startTime: 0, elapsedTime: 0, isRunning: false, isPaused: false };
            let quizTimer = { startTime: null };

            const $ = (s) => document.querySelector(s);
            const $$ = (s) => document.querySelectorAll(s);

            const loadState = () => {
                const defaultState = {
                    profile: { 
                        lp: 0, 
                        unlockedThemes: ['default'], 
                        earnedTitles: [], 
                        activeTheme: 'default',
                        unlockedBackgrounds: ['default'],
                        activeBackground: 'default'
                    },
                    progress: {},
                    reviewSchedule: [],
                    pinnedQuizzes: [],
                    countdowns: [],
                    focus: { totalTime: 0, mode: 'timer' },
                    studyLog: {}, 
                    settings: { reviewNotifications: true, backgroundScopeGlobal: true , manualDarkMode: false },
                    lastLogin: null,
                    lastNotificationCheck: new Date().toISOString(),
                };
                state = JSON.parse(localStorage.getItem('quizAppUltimateV8')) || defaultState;
                if(state.lastLogin !== new Date().toDateString()){
                    addLP(10000, 'ログインボーナス', false);
                    state.lastLogin = new Date().toDateString();
                    saveState();
                }
            };
            const saveState = () => localStorage.setItem('quizAppUltimateV8', JSON.stringify(state));
            
           // 既存の updateAppearance 関数を、この新しいコードで完全に置き換えてください。
            
            const updateAppearance = () => {
                const appContainer = $('#app-container');
                const activeBgId = state.profile.activeBackground;
                const activeBg = initialData.backgrounds[activeBgId];
                const isGlobal = state.settings.backgroundScopeGlobal;
                const hasImage = activeBg && activeBg.url;
            
                // --- 1. テーマ決定ロジック ---
                let effectiveTone;
            
                // 手動テーマ設定が有効になる条件（＝トグルが表示される条件）を定義
                const isManualThemeMode = (activeBgId === 'default' || !isGlobal);
            
                if (isManualThemeMode) {
                    // 条件に合致する場合、手動設定トグルの状態に従う (trueならdark, falseならlight)
                    effectiveTone = state.settings.manualDarkMode ? 'dark' : 'light';
                } else {
                    // 条件外（カスタム壁紙で「全体適用」オン）の場合、壁紙のtoneに従う
                    effectiveTone = activeBg.tone;
                }
            
                // --- 2. 決定したテーマをHTML要素に適用 ---
                document.documentElement.classList.remove('dark');
                if (effectiveTone === 'dark') {
                    document.documentElement.classList.add('dark');
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    document.documentElement.setAttribute('data-theme', 'light');
                }
            
                // --- 3. 背景画像の適用ロジック ---
                if (isGlobal && hasImage) {
                    appContainer.style.backgroundImage = `url(${activeBg.url})`;
                } else {
                    appContainer.style.backgroundImage = 'none';
                }
            };

            const updateLpDisplay = () => {
                $('#lp-display').textContent = `${state.profile.lp} LP`;
                if ($('#point-details-modal').style.display === 'flex') {
                    $('#modal-lp-display').textContent = state.profile.lp;
                }
            };

            const renderEngine = {
                pages: {
                    'home-page': () => {
                        const today = new Date();
                        $('#today-date').textContent = `${today.getFullYear()}年 ${today.getMonth() + 1}月 ${today.getDate()}日 (${'日月火水木金土'[today.getDay()]}曜日)`;

                        const countdownContainer = $('#countdown-list');
                        countdownContainer.innerHTML = state.countdowns.length ? state.countdowns.map(cd => {
                            const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                            const targetStart = new Date(cd.date);
                            targetStart.setHours(0,0,0,0);
                            const diffTime = targetStart - todayStart;
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            const dayText = diffDays > 0 ? `あと <span class="text-2xl font-bold primary-text">${diffDays}</span> 日` : diffDays === 0 ? `<span class="text-xl font-bold text-red-500">今日です！</span>` : `<span class="text-gray-500">終了</span>`;
                            return `<div class="bg-white dark:bg-gray-700 rounded-lg shadow-sm p-3 flex items-center justify-between"><div><h3 class="font-semibold text-gray-800 dark:text-gray-200">${cd.name}</h3><p class="text-sm text-gray-500 dark:text-gray-400">${cd.date.replace(/-/g, '/')}</p></div><div class="flex items-center"><div class="mr-4">${dayText}</div><button class="edit-countdown-btn p-2 text-gray-400 hover:text-gray-600" data-id="${cd.id}"><i data-lucide="edit" class="w-4 h-4"></i></button></div></div>`;
                        }).join('') : `<p class="text-sm text-gray-500 text-center">右上の「+」ボタンでテストなどの日程を追加できます。</p>`;

                        const reviewContainer = $('#review-list');
                        const reviews = state.reviewSchedule.filter(r => new Date(r.reviewDate) <= today);
                        reviewContainer.innerHTML = reviews.length ? reviews.map(r => createQuizCard(initialData.quizzes.find(q => q.id === r.quizId), false, true)).join('') : `<p class="text-sm text-gray-500">今日の復習はありません。素晴らしい！</p>`;
                        
                        const titlesContainer = $('#recent-titles');
                        titlesContainer.innerHTML = state.profile.earnedTitles.slice(-5).reverse().map(tid => {
                             const title = initialData.titles.find(t => t.id === tid);
                             return `<div class="bg-white dark:bg-gray-700 p-2 rounded-lg shadow-sm text-center min-w-[100px]"><i data-lucide="award" class="mx-auto w-8 h-8 text-yellow-500"></i><p class="text-xs font-semibold mt-1">${title.name}</p></div>`;
                        }).join('') || `<p class="text-sm text-gray-500">称号を獲得してここに表示しよう！</p>`;
                    },
                    'study-page': () => {
                        const allContainer = $('#all-quizzes');
                        const pinnedContainer = $('#pinned-quizzes');
                        const subjects = ['all', ...new Set(initialData.quizzes.map(q => q.subject))];
                        const activeFilter = $('#filter-container .active')?.dataset.filter || 'all';
                        $('#filter-container').innerHTML = subjects.map(s => `<button class="filter-btn ${s === activeFilter ? 'active primary-bg text-white' : 'bg-gray-200 dark:bg-gray-600'} px-4 py-1.5 rounded-full text-sm font-medium whitespace-nowrap" data-filter="${s}">${s === 'all' ? 'すべて' : s}</button>`).join('');
                        
                        const quizzes = initialData.quizzes.filter(q => activeFilter === 'all' || q.subject === activeFilter);
                        allContainer.innerHTML = quizzes.map(q => createQuizCard(q, state.pinnedQuizzes.includes(q.id))).join('');
                        
                        const pinnedQuizzes = state.pinnedQuizzes.map(id => initialData.quizzes.find(q => q.id === id)).filter(Boolean);
                        pinnedContainer.innerHTML = pinnedQuizzes.length ? pinnedQuizzes.map(q => createQuizCard(q, true)).join('') : `<p class="text-sm text-gray-500">クイズをピン留めしてすぐアクセス！</p>`;
                    },
                    // 変更後
                  'focus-page': () => {
                        const activeBg = initialData.backgrounds[state.profile.activeBackground];
                        const hasImage = activeBg && activeBg.url;
                        const isGlobal = state.settings.backgroundScopeGlobal;
                        
                        $$('.focus-view-bg').forEach(el => {
                            // 「全体適用」がオフで、かつ画像がある場合のみ、集中モードの要素に直接背景を設定
                            if (!isGlobal && hasImage) {
                                el.style.backgroundImage = `url(${activeBg.url})`;
                            } else {
                                // 「全体適用」がオンの場合は、#app-containerの背景が見えるように自身の背景を消す
                                el.style.backgroundImage = 'none';
                            }
                        });
                    },
                    'my-chart-page': () => {
                        const subjects = [...new Set(initialData.quizzes.map(q => q.subject))];
                        const radarData = subjects.map(sub => {
                            const quizzesInSub = initialData.quizzes.filter(q => q.subject === sub);
                            const totalLevels = quizzesInSub.reduce((acc, q) => acc + (state.progress[q.id]?.level || 0), 0);
                            const completedCount = quizzesInSub.filter(q => state.progress[q.id]).length;
                            return completedCount > 0 ? (totalLevels / completedCount) / 3 * 100 : 0;
                        });
                        renderChart('subject-radar-chart', 'radar', { labels: subjects, datasets: [{ label: '理解度 (%)', data: radarData, backgroundColor: 'rgba(79, 70, 229, 0.2)', borderColor: 'rgba(79, 70, 229, 1)', borderWidth: 2 }] }, { scales: { r: { beginAtZero: true, max: 100 } } });

                        const weaknessContainer = $('#weakness-list');
                        const weaknesses = Object.keys(state.progress).filter(id => state.progress[id].level === 1).map(id => initialData.quizzes.find(q => q.id === id));
                        weaknessContainer.innerHTML = weaknesses.length ? weaknesses.map(q => createQuizCard(q, false)).join('') : `<p class="text-sm text-gray-500">弱点は見つかりませんでした。素晴らしい！</p>`;

                        const labels = [];
                        const data = [];
                        for (let i = 6; i >= 0; i--) {
                            const d = new Date();
                            d.setDate(d.getDate() - i);
                            const day = d.toISOString().split('T')[0];
                            labels.push(`${d.getMonth()+1}/${d.getDate()}`);
                            const log = state.studyLog[day] || { focus: 0, quiz: 0 };
                            data.push((log.focus + log.quiz) / 60); // in minutes
                        }
                        renderChart('study-time-chart', 'bar', { labels, datasets: [{ label: '学習時間 (分)', data, backgroundColor: 'rgba(79, 70, 229, 0.5)', borderColor: 'rgba(79, 70, 229, 1)', borderWidth: 1 }] }, { scales: { y: { beginAtZero: true } } });
                    },
                    'settings-page': () => {
                        const manualThemeContainer = $('#manual-theme-container');
                        const activeBgId = state.profile.activeBackground;
                        const isGlobal = state.settings.backgroundScopeGlobal;
                    
                        // デフォルト壁紙、または「全体適用」がオフの時にだけトグルを表示する
                        if (activeBgId === 'default' || !isGlobal) {
                            manualThemeContainer.classList.remove('hidden');
                            $('#manual-dark-mode-toggle').checked = state.settings.manualDarkMode;
                        } else {
                            manualThemeContainer.classList.add('hidden');
                        }

                        $('#review-notification-toggle').checked = state.settings.reviewNotifications;
                        
                        $('#theme-selector').innerHTML = state.profile.unlockedThemes.map(id => {
                            const theme = initialData.themes[id];
                            const isActive = state.profile.activeTheme === id;
                            return `<div class="text-center">
                                <button class="theme-btn w-12 h-12 rounded-full border-4 ${isActive ? 'border-blue-500' : 'border-transparent'} relative" style="background-color: ${theme.color}" data-theme="${id}"></button>
                                <p class="text-xs mt-1">${theme.name}</p>
                            </div>`;
                        }).join('') || `<p class="text-sm text-gray-500">マイステータスからテーマを交換できます。</p>`;

                        $('#background-selector').innerHTML = state.profile.unlockedBackgrounds.map(id => {
                            const bg = initialData.backgrounds[id];
                            const isActive = state.profile.activeBackground === id;
                             return `<div class="text-center">
                                <button class="background-btn w-full h-20 rounded-lg border-4 ${isActive ? 'border-blue-500' : 'border-transparent'} relative bg-gray-500 bg-cover bg-center" style="background-image: ${bg.url ? `url(${bg.url})` : 'none'}" data-bg="${id}"></button>
                                <p class="text-xs mt-1">${bg.name}</p>
                            </div>`;
                        }).join('') || `<p class="text-sm text-gray-500">マイステータスから背景を交換できます。</p>`;
                    }
                },
                renderAll: () => {
                    for(const pageId in renderEngine.pages){
                        if($(`#${pageId}`).classList.contains('active')){
                            renderEngine.pages[pageId]();
                        }
                    }
                    updateLpDisplay();
                    const activeTheme = initialData.themes[state.profile.activeTheme];
                    document.documentElement.style.setProperty('--primary-color', activeTheme.color);
                    document.documentElement.style.setProperty('--primary-color-hover', activeTheme.hover);
                    lucide.createIcons();
                }
            };
            
            const createQuizCard = (quiz, isPinned, isReview = false) => {
                if(!quiz) return '';
                const progress = state.progress[quiz.id];
                const levelIcons = { 1: 'book-open-check', 2: 'thumbs-up', 3: 'award'};
                return `<div class="bg-white dark:bg-gray-700 rounded-lg shadow-sm p-3 flex items-center justify-between quiz-card" data-id="${quiz.id}"><div class="flex items-center min-w-0"><div class="w-5 h-5 mr-3 flex-shrink-0">${isReview ? `<i data-lucide="bell-ring" class="text-red-500"></i>` : progress ? `<i data-lucide="${levelIcons[progress.level]}" class="text-yellow-500"></i>` : ``}</div><div class="truncate"><h3 class="font-semibold text-gray-800 dark:text-gray-200 truncate">${quiz.title}</h3><p class="text-sm text-gray-500 dark:text-gray-400">${quiz.subject} - ${quiz.genre}</p></div></div><button class="pin-btn p-2 -mr-2 flex-shrink-0" data-id="${quiz.id}"><i data-lucide="pin" class="w-5 h-5 ${isPinned ? 'primary-text fill-current' : 'text-gray-400'}"></i></button></div>`;
            };
            
            const renderChart = (canvasId, type, data, options) => {
                const ctx = $(`#${canvasId}`).getContext('2d');
                if(chartInstances[canvasId]) chartInstances[canvasId].destroy();
                chartInstances[canvasId] = new Chart(ctx, { type, data, options });
            };

            const showToast = (message) => {
                const toast = $('#toast'); toast.textContent = message; toast.classList.remove('opacity-0', '-translate-y-10');
                setTimeout(() => toast.classList.add('opacity-0', '-translate-y-10'), 2000);
            };

            const addLP = (amount, reason, show = true) => {
                state.profile.lp += amount;
                if(show) showToast(`${reason}で ${amount} LP 獲得！`);
                updateLpDisplay();
            };
            const checkTitles = () => initialData.titles.forEach(t => !state.profile.earnedTitles.includes(t.id) && t.condition(state) && (state.profile.earnedTitles.push(t.id), showToast(`称号「${t.name}」獲得！`)));
            const scheduleReview = (quizId) => [1, 3, 7].forEach(days => state.reviewSchedule.push({ quizId, reviewDate: new Date(Date.now() + days * 86400000).toISOString() }));

            const formatTime = (s) => {
                const totalSeconds = Math.floor(s);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                if (hours > 0) return `${hours}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
                return `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
            };
            
            const formatStopwatchTime = (s) => {
                const totalSeconds = s;
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = Math.floor(totalSeconds % 60);
                const ms = Math.floor((totalSeconds * 100) % 100);
                return `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}:${ms.toString().padStart(2,'0')}`;
            };

            const logStudyTime = (type, seconds) => {
                const today = new Date().toISOString().split('T')[0];
                if (!state.studyLog[today]) state.studyLog[today] = { focus: 0, quiz: 0 };
                state.studyLog[today][type] += seconds;
            };

            document.body.addEventListener('click', e => {
                const quizCard = e.target.closest('.quiz-card');
                if (quizCard && !e.target.closest('.pin-btn')) {
                    const quiz = initialData.quizzes.find(q => q.id === quizCard.dataset.id);
                    $('#quiz-modal-title').textContent = quiz.title;
                    $('#quiz-iframe').classList.add('invisible');
                    $('#quiz-modal').dataset.currentQuiz = quiz.id;
                    $('#quiz-modal').style.display = 'flex';
                    quizTimer.startTime = Date.now();
                    setTimeout(() => {
                        $('#quiz-iframe').src = quiz.url;
                        $('#quiz-iframe').onload = () => $('#quiz-iframe').classList.remove('invisible');
                    }, 100);
                }

                const pinBtn = e.target.closest('.pin-btn');
                if(pinBtn) {
                    const quizId = pinBtn.dataset.id;
                    state.pinnedQuizzes.includes(quizId) ? state.pinnedQuizzes = state.pinnedQuizzes.filter(id => id !== quizId) : state.pinnedQuizzes.push(quizId);
                    saveState(); renderEngine.pages['study-page'](); lucide.createIcons();
                }
                
                const filterBtn = e.target.closest('.filter-btn');
                if(filterBtn) {
                     $$('#filter-container .filter-btn').forEach(b => {
                         b.classList.remove('active', 'primary-bg', 'text-white');
                         b.classList.add('bg-gray-200', 'dark:bg-gray-600');
                     });
                     filterBtn.classList.add('active', 'primary-bg', 'text-white');
                     filterBtn.classList.remove('bg-gray-200', 'dark:bg-gray-600');
                     renderEngine.pages['study-page']();
                     lucide.createIcons();
                }

                const closeModalBtn = e.target.closest('.close-modal-btn');
                if (closeModalBtn) {
                    const modal = $(`#${closeModalBtn.dataset.modal}`);
                    modal.style.display = 'none';
                    if (closeModalBtn.dataset.modal === 'quiz-modal') {
                        $('#assessment-modal').dataset.quizId = modal.dataset.currentQuiz;
                        $('#assessment-modal').style.display = 'flex';
                        if(quizTimer.startTime) {
                            const elapsed = Math.round((Date.now() - quizTimer.startTime) / 1000);
                            logStudyTime('quiz', elapsed);
                            quizTimer.startTime = null;
                            saveState();
                        }
                    }
                }
                
                const assessmentBtn = e.target.closest('.assessment-btn');
                if(assessmentBtn) {
                    const level = parseInt(assessmentBtn.dataset.level);
                    const quizId = $('#assessment-modal').dataset.quizId;
                    state.progress[quizId] = { level, date: new Date().toISOString() };
                    addLP(level * 5, 'クイズ評価');
                    scheduleReview(quizId); checkTitles(); saveState();
                    renderEngine.renderAll();
                    $('#assessment-modal').style.display = 'none';
                }

                const themeBtn = e.target.closest('.theme-btn');
                if(themeBtn){
                    const themeId = themeBtn.dataset.theme;
                    if(state.profile.unlockedThemes.includes(themeId)) {
                        state.profile.activeTheme = themeId;
                        saveState();
                        renderEngine.renderAll();
                    } else {
                        const theme = initialData.themes[themeId];
                        const confirmBtn = $('#theme-purchase-confirm');
                        
                        $('#theme-purchase-title').textContent = `「${theme.name}」を交換しますか？`;
                        $('#theme-purchase-cost').textContent = `必要なポイント: ${theme.cost} LP`;
                        
                        // プレビュー表示
                        $('#theme-preview').style.backgroundColor = theme.color;
                
                        // ポイントが足りるかチェック
                        if (state.profile.lp >= theme.cost) {
                            confirmBtn.disabled = false;
                        } else {
                            confirmBtn.disabled = true;
                        }
                
                        confirmBtn.dataset.itemId = themeId;
                        confirmBtn.dataset.itemType = 'theme';
                        $('#theme-purchase-modal').style.display = 'flex';
                    }
                }

                const backgroundBtn = e.target.closest('.background-btn');
                if(backgroundBtn){
                    const bgId = backgroundBtn.dataset.bg;
                    if(state.profile.unlockedBackgrounds.includes(bgId)) {
                        state.profile.activeBackground = bgId;
                        saveState();
                        updateAppearance();
                        renderEngine.pages['settings-page']();
                        lucide.createIcons();
                    } else {
                        const bg = initialData.backgrounds[bgId];
                        const confirmBtn = $('#background-purchase-confirm');
                
                        $('#background-purchase-title').textContent = `「${bg.name}」を交換しますか？`;
                        $('#background-purchase-cost').textContent = `必要なポイント: ${bg.cost} LP`;
                
                        // プレビュー表示
                        const previewEl = $('#background-preview');
                        if (bg.url) {
                            previewEl.style.backgroundImage = `url(${bg.url})`;
                            previewEl.classList.remove('hidden');
                        } else {
                            previewEl.classList.add('hidden'); // デフォルトなど画像がない場合は非表示
                        }
                        
                        // ポイントが足りるかチェック
                        if (state.profile.lp >= bg.cost) {
                            confirmBtn.disabled = false;
                        } else {
                            confirmBtn.disabled = true;
                        }
                
                        confirmBtn.dataset.itemId = bgId;
                        confirmBtn.dataset.itemType = 'background';
                        $('#background-purchase-modal').style.display = 'flex';
                    }
                }

                const editCountdownBtn = e.target.closest('.edit-countdown-btn');
                if(editCountdownBtn){
                    const id = editCountdownBtn.dataset.id;
                    openCountdownModal(id);
                }

                const focusModeBtn = e.target.closest('.focus-mode-btn');
                if(focusModeBtn) {
                    const mode = focusModeBtn.dataset.mode;
                    state.focus.mode = mode;
                    updateFocusModeUI();
                }

                const timerDurationBtn = e.target.closest('.timer-duration-btn');
                if(timerDurationBtn && !focusTimer.isRunning) {
                    const time = parseInt(timerDurationBtn.dataset.time);
                    setTimer(time);
                     $$('.timer-duration-btn').forEach(btn => btn.classList.replace('bg-white/40', 'bg-white/20'));
                    timerDurationBtn.classList.replace('bg-white/20', 'bg-white/40');
                }
            });

            $('#manual-dark-mode-toggle').addEventListener('change', (e) => {
                state.settings.manualDarkMode = e.target.checked;
                saveState();
                updateAppearance(); // 外観を即時更新
            });
            
            /* 変更後 (新しいイベントリスナーとして追加) */
            $('#background-scope-toggle').addEventListener('change', (e) => {
                state.settings.backgroundScopeGlobal = e.target.checked;
                saveState();
                updateAppearance();
                // 集中タブが表示されている場合に備えて再描画
                if ($('#focus-page').classList.contains('active')) {
                    renderEngine.pages['focus-page']();
                }
            });
            
            $('#lp-button').addEventListener('click', () => {
                $('#modal-lp-display').textContent = state.profile.lp;
                
                $('#modal-theme-selector').innerHTML = Object.entries(initialData.themes).map(([id, theme]) => {
                    const isUnlocked = state.profile.unlockedThemes.includes(id);
                    return `<div class="text-center">
                        <button class="theme-btn w-12 h-12 rounded-full border-2 ${isUnlocked ? 'border-green-400' : 'border-transparent'} relative" style="background-color: ${theme.color}" data-theme="${id}">
                            ${!isUnlocked ? `<i data-lucide="lock" class="w-6 h-6 text-white absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"></i>` : ''}
                        </button>
                        <p class="text-xs mt-1">${isUnlocked ? theme.name : `${theme.cost} LP`}</p>
                    </div>`;
                }).join('');

                $('#modal-background-selector').innerHTML = Object.entries(initialData.backgrounds).map(([id, bg]) => {
                     const isUnlocked = state.profile.unlockedBackgrounds.includes(id);
                     return `<div class="text-center">
                                <button class="background-btn w-full h-16 rounded-lg border-2 ${isUnlocked ? 'border-green-400' : 'border-transparent'} relative bg-gray-500 bg-cover bg-center" style="background-image: ${bg.url ? `url(${bg.url})` : 'none'}" data-bg="${id}">
                                     ${!isUnlocked ? `<div class="absolute inset-0 bg-black/60 flex items-center justify-center rounded-md"><i data-lucide="lock" class="w-6 h-6 text-white"></i></div>` : ''}
                                </button>
                                <p class="text-xs mt-1">${isUnlocked ? bg.name : `${bg.cost} LP`}</p>
                            </div>`;
                }).join('');
                
                const titlesList = $('#modal-titles-list');
                const earnedTitles = state.profile.earnedTitles.map(id => initialData.titles.find(t => t.id === id));
                titlesList.innerHTML = earnedTitles.length ? earnedTitles.map(t => `<span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-0.5 rounded-full dark:bg-yellow-900 dark:text-yellow-300">${t.name}</span>`).join('') : '<p class="text-sm text-gray-500">まだ称号はありません</p>';

                $('#point-details-modal').style.display = 'flex';
                lucide.createIcons();
            });

            $('#close-point-modal-btn').addEventListener('click', () => $('#point-details-modal').style.display = 'none');
            
            // Countdown Modal
            $('#add-countdown-btn').addEventListener('click', () => openCountdownModal());
            $('#countdown-cancel-btn').addEventListener('click', () => $('#countdown-modal').style.display = 'none');
            $('#countdown-notification-toggle').addEventListener('change', (e) => {
                $('#countdown-notification-details').style.display = e.target.checked ? 'block' : 'none';
            });
            $('#countdown-save-btn').addEventListener('click', saveCountdown);
            $('#countdown-delete-btn').addEventListener('click', deleteCountdown);
            
            // Generic Purchase Logic
            $('#theme-purchase-confirm').addEventListener('click', handlePurchase);
            $('#background-purchase-confirm').addEventListener('click', handlePurchase);
            $('#theme-purchase-cancel').addEventListener('click', () => $('#theme-purchase-modal').style.display = 'none');
            $('#background-purchase-cancel').addEventListener('click', () => $('#background-purchase-modal').style.display = 'none');

            function handlePurchase(e) {
                const { itemId, itemType } = e.target.dataset;
                const itemData = initialData[itemType + 's'][itemId];
                
                if (state.profile.lp >= itemData.cost) {
                    addLP(-itemData.cost, `アイテム「${itemData.name}」交換`);
                    state.profile[`unlocked${itemType.charAt(0).toUpperCase() + itemType.slice(1)}s`].push(itemId);
                    showToast(`「${itemData.name}」を解放しました！`);
                    saveState();
                    renderEngine.renderAll();
                } else {
                    showToast('LPが足りません！');
                }
                $(`#${itemType}-purchase-modal`).style.display = 'none';
            }
            
            // --- Focus Page Logic ---
            const updateMiniTimer = () => {
                const container = $('#mini-timer-container');
                const bar = $('#mini-timer-bar');
                if ((focusTimer.isRunning || stopwatch.isRunning) && !$('#focus-page').classList.contains('active')) {
                    container.classList.add('visible');
                    if(focusTimer.isRunning){
                        const progress = (focusTimer.defaultTime - focusTimer.timeLeft) / focusTimer.defaultTime * 100;
                        $('#mini-timer-text').textContent = `タイマー: ${formatTime(focusTimer.timeLeft)}`;
                        $('#mini-timer-progress-bar').style.width = `${progress}%`;
                    } else { // stopwatch
                         $('#mini-timer-text').textContent = `計測中: ${formatStopwatchTime(stopwatch.elapsedTime)}`;
                         $('#mini-timer-progress-bar').style.width = `100%`;
                    }
                } else {
                    container.classList.remove('visible');
                }
            };
            
            const timerTick = () => {
                focusTimer.timeLeft--;
                $('#focus-timer-display').textContent = formatTime(focusTimer.timeLeft);
                updateMiniTimer();
                if (focusTimer.timeLeft <= 0) {
                    clearInterval(focusTimer.interval);
                    showToast('集中モード完了！お疲れ様でした！');
                    if (Notification.permission === 'granted') {
                        new Notification('集中モード完了！', { body: 'お疲れ様でした！少し休憩しましょう。', icon: 'https://placehold.co/180x180/4f46e5/ffffff?text=Q' });
                    }
                    const elapsed = focusTimer.defaultTime;
                    logStudyTime('focus', elapsed);
                    addLP(Math.floor(elapsed/60), 'タイマー完了');
                    state.focus.totalTime += elapsed;
                    checkTitles(); 
                    saveState(); 
                    resetTimerUI();
                }
            };
            
            const stopwatchTick = () => {
                stopwatch.elapsedTime = (Date.now() - stopwatch.startTime) / 1000;
                $('#stopwatch-display').textContent = formatStopwatchTime(stopwatch.elapsedTime);
                updateMiniTimer();
            };

            const pauseFocusTimer = () => {
                if (!focusTimer.isRunning || focusTimer.isPaused) return;
                focusTimer.isPaused = true;
                clearInterval(focusTimer.interval);
                $('#focus-pause-btn').innerHTML = `<i data-lucide="play" class="w-6 h-6 mr-2"></i>再開`;
                lucide.createIcons();
            };

            const resumeFocusTimer = () => {
                if (!focusTimer.isRunning || !focusTimer.isPaused) return;
                focusTimer.isPaused = false;
                focusTimer.interval = setInterval(timerTick, 1000);
                $('#focus-pause-btn').innerHTML = `<i data-lucide="pause" class="w-6 h-6 mr-2"></i>一時停止`;
                lucide.createIcons();
            };

            const pauseStopwatch = () => {
                if (!stopwatch.isRunning || stopwatch.isPaused) return;
                stopwatch.isPaused = true;
                clearInterval(stopwatch.interval);
                $('#stopwatch-pause-btn').innerHTML = `<i data-lucide="play" class="w-6 h-6 mr-2"></i>再開`;
                lucide.createIcons();
            };

            const resumeStopwatch = () => {
                if (!stopwatch.isRunning || !stopwatch.isPaused) return;
                stopwatch.isPaused = false;
                stopwatch.startTime = Date.now() - stopwatch.elapsedTime * 1000;
                stopwatch.interval = setInterval(stopwatchTick, 100);
                $('#stopwatch-pause-btn').innerHTML = `<i data-lucide="pause" class="w-6 h-6 mr-2"></i>一時停止`;
                lucide.createIcons();
            };

            const updateFocusModeUI = () => {
                const isTimer = state.focus.mode === 'timer';
                $('#timer-view').style.display = isTimer ? 'flex' : 'none';
                $('#stopwatch-view').style.display = isTimer ? 'none' : 'flex';
                $$('.focus-mode-btn').forEach(btn => {
                    btn.classList.toggle('primary-bg', btn.dataset.mode === state.focus.mode);
                    btn.classList.toggle('text-white', btn.dataset.mode === state.focus.mode);
                });
            };

            const resetTimerUI = () => {
                clearInterval(focusTimer.interval);
                focusTimer.isRunning = false; focusTimer.isPaused = false;
                focusTimer.timeLeft = focusTimer.defaultTime;
                $('#focus-timer-display').textContent = formatTime(focusTimer.defaultTime);
                $('#focus-start-btn').classList.remove('hidden');
                $('#focus-controls').classList.add('hidden');
                updateMiniTimer();
            };

            const resetStopwatchUI = () => {
                clearInterval(stopwatch.interval);
                stopwatch.isRunning = false; stopwatch.isPaused = false;
                stopwatch.elapsedTime = 0;
                $('#stopwatch-display').textContent = formatStopwatchTime(0);
                $('#stopwatch-start-btn').classList.remove('hidden');
                $('#stopwatch-controls').classList.add('hidden');
                updateMiniTimer();
            };

            const endFocusTimer = () => {
                if (!focusTimer.isRunning) return;
                const elapsed = focusTimer.defaultTime - focusTimer.timeLeft;
                if (elapsed > 0) { logStudyTime('focus', elapsed); addLP(Math.floor(elapsed / 60), '集中モード'); state.focus.totalTime += elapsed; checkTitles(); saveState(); }
                resetTimerUI();
            };

            const endStopwatch = () => {
                if (!stopwatch.isRunning) return;
                const elapsed = Math.round(stopwatch.elapsedTime);
                if (elapsed > 0) { logStudyTime('focus', elapsed); addLP(Math.floor(elapsed / 60), 'ストップウォッチ'); state.focus.totalTime += elapsed; checkTitles(); saveState(); }
                resetStopwatchUI();
            };
            
            const setTimer = (seconds) => {
                 focusTimer.defaultTime = seconds; focusTimer.timeLeft = seconds;
                 $('#focus-timer-display').textContent = formatTime(seconds);
                 $('#custom-time-input').value = '';
            };
            
            $('#set-custom-time-btn').addEventListener('click', () => {
                const minutes = parseInt($('#custom-time-input').value);
                if (minutes > 0) { setTimer(minutes * 60); $$('.timer-duration-btn').forEach(btn => btn.classList.replace('bg-white/40', 'bg-white/20')); }
            });

            $('#focus-start-btn').addEventListener('click', () => {
                focusTimer.isRunning = true; focusTimer.isPaused = false;
                focusTimer.interval = setInterval(timerTick, 1000);
                $('#focus-start-btn').classList.add('hidden');
                $('#focus-controls').classList.remove('hidden');
                updateMiniTimer();
            });
            $('#focus-pause-btn').addEventListener('click', () => { if (focusTimer.isPaused) resumeFocusTimer(); else pauseFocusTimer(); });
            $('#focus-end-btn').addEventListener('click', endFocusTimer);

            $('#stopwatch-start-btn').addEventListener('click', () => {
                stopwatch.isRunning = true; stopwatch.isPaused = false;
                stopwatch.startTime = Date.now() - stopwatch.elapsedTime * 1000;
                stopwatch.interval = setInterval(stopwatchTick, 100);
                $('#stopwatch-start-btn').classList.add('hidden');
                $('#stopwatch-controls').classList.remove('hidden');
                updateMiniTimer();
            });
            $('#stopwatch-pause-btn').addEventListener('click', () => { if (stopwatch.isPaused) resumeStopwatch(); else pauseStopwatch(); });
            $('#stopwatch-end-btn').addEventListener('click', endStopwatch);
            
            $('#notification-permission-btn').addEventListener('click', async () => {
                if (!('Notification' in window)) { showToast('お使いのブラウザは通知に対応していません。'); return; }
                const permission = await Notification.requestPermission();
                if (permission === 'granted') { showToast('通知が許可されました！'); new Notification('クイズHPへようこそ！', { body: '通知設定がオンになりました。' }); } 
                else { showToast('通知が拒否されました。設定から変更できます。'); }
            });

            $$('.tab-btn').forEach(btn => btn.addEventListener('click', e => {
                const pageId = e.currentTarget.dataset.page;
                
                $$('.page').forEach(p => p.classList.remove('active'));
                $(`#${pageId}`).classList.add('active');
                
                $$('.tab-btn').forEach(b => b.classList.replace('primary-text', 'text-gray-500'));
                e.currentTarget.classList.replace('text-gray-500', 'primary-text');
                $('#header-title').textContent = e.currentTarget.dataset.title;
                if(renderEngine.pages[pageId]) { renderEngine.pages[pageId](); }
                
                updateMiniTimer();
                lucide.createIcons();
            }));

            $('#mini-timer-bar').addEventListener('click', (e) => {
                if (e.target.closest('#close-mini-timer-btn')) return;
                document.querySelector('.tab-btn[data-page="focus-page"]').click();
            });

            $('#close-mini-timer-btn').addEventListener('click', () => {
                if (focusTimer.isRunning) endFocusTimer();
                if (stopwatch.isRunning) endStopwatch();
            });

            // --- Countdown Logic ---
            function openCountdownModal(id = null) {
                const modal = $('#countdown-modal');
                modal.dataset.editingId = id || '';
                const title = $('#countdown-modal-title');
                const deleteBtn = $('#countdown-delete-btn');
                const nameInput = $('#countdown-name');
                const dateInput = $('#countdown-date');
                const notifToggle = $('#countdown-notification-toggle');
                const notifTime = $('#countdown-notification-time');
                const notifDaysContainer = $('#countdown-notification-days');
                
                const daysOptions = [1, 2, 3, 7, 14, 30];
                notifDaysContainer.innerHTML = daysOptions.map(d => 
                    `<button class="day-btn border rounded-full px-3 py-1 text-sm" data-day="${d}">${d}日前</button>`
                ).join('');

                if (id) {
                    title.textContent = 'カウントダウンの編集';
                    deleteBtn.classList.remove('hidden');
                    const countdown = state.countdowns.find(c => c.id === id);
                    nameInput.value = countdown.name;
                    dateInput.value = countdown.date;
                    notifToggle.checked = countdown.notifications.enabled;
                    notifTime.value = countdown.notifications.time;
                    $$('.day-btn').forEach(btn => {
                        if (countdown.notifications.daysBefore.includes(parseInt(btn.dataset.day))) {
                            btn.classList.add('selected');
                        }
                    });
                } else {
                    title.textContent = 'カウントダウンの追加';
                    deleteBtn.classList.add('hidden');
                    nameInput.value = '';
                    dateInput.value = '';
                    notifToggle.checked = true;
                    notifTime.value = '07:00';
                    $$('.day-btn').forEach(btn => btn.classList.remove('selected'));
                    $(`.day-btn[data-day='1']`).classList.add('selected');
                }
                
                $('#countdown-notification-details').style.display = notifToggle.checked ? 'block' : 'none';
                modal.style.display = 'flex';
                lucide.createIcons();

                $$('.day-btn').forEach(btn => {
                    btn.onclick = () => btn.classList.toggle('selected');
                });
            }

            function saveCountdown() {
                const id = $('#countdown-modal').dataset.editingId;
                const name = $('#countdown-name').value.trim();
                const date = $('#countdown-date').value;

                if (!name || !date) {
                    showToast('イベント名と日付を入力してください');
                    return;
                }

                const enabled = $('#countdown-notification-toggle').checked;
                const time = $('#countdown-notification-time').value;
                const daysBefore = [...$$('.day-btn.selected')].map(btn => parseInt(btn.dataset.day));

                const countdownData = {
                    name,
                    date,
                    notifications: { enabled, time, daysBefore }
                };

                if (id) {
                    const index = state.countdowns.findIndex(c => c.id === id);
                    state.countdowns[index] = { ...state.countdowns[index], ...countdownData };
                } else {
                    countdownData.id = `cd_${Date.now()}`;
                    state.countdowns.push(countdownData);
                }

                state.countdowns.sort((a, b) => new Date(a.date) - new Date(b.date));
                saveState();
                renderEngine.pages['home-page']();
                lucide.createIcons();
                $('#countdown-modal').style.display = 'none';
            }
            
            function deleteCountdown() {
                const id = $('#countdown-modal').dataset.editingId;
                state.countdowns = state.countdowns.filter(c => c.id !== id);
                saveState();
                renderEngine.pages['home-page']();
                lucide.createIcons();
                $('#countdown-modal').style.display = 'none';
            }
            
            // --- Notification Check ---
            function checkCountdownNotifications() {
                if (Notification.permission !== 'granted') return;
                
                const now = new Date();
                const lastCheck = new Date(state.lastNotificationCheck);

                state.countdowns.forEach(cd => {
                    if (!cd.notifications.enabled) return;
                    
                    const eventDate = new Date(cd.date);
                    const [hours, minutes] = cd.notifications.time.split(':');
                    
                    cd.notifications.daysBefore.forEach(day => {
                        const notifDate = new Date(eventDate.getTime());
                        notifDate.setDate(notifDate.getDate() - day);
                        notifDate.setHours(hours, minutes, 0, 0);

                        if (notifDate > lastCheck && notifDate <= now) {
                            new Notification(`【${day}日前】${cd.name}`, {
                                body: `イベント「${cd.name}」が${day}日後に迫っています！`,
                                icon: 'https://placehold.co/180x180/4f46e5/ffffff?text=Q'
                            });
                        }
                    });
                });
                
                state.lastNotificationCheck = now.toISOString();
                saveState();
            }

            const init = () => {
                loadState();
                checkCountdownNotifications();
                renderEngine.renderAll();
                updateFocusModeUI();
                setTimer(1500);
                
                const reviewsToday = state.reviewSchedule.filter(r => new Date(r.reviewDate) <= new Date()).length;
                if(reviewsToday > 0) { showToast(`今日やるべき復習が ${reviewsToday} 件あります！`); }

                let deferredPrompt;
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault(); deferredPrompt = e;
                    const installBtn = $('#install-button');
                    installBtn.classList.remove('hidden');
                    installBtn.onclick = () => deferredPrompt.prompt();
                });
                $('#background-scope-toggle').checked = state.settings.backgroundScopeGlobal;
                updateAppearance();
            };
            init();
        });
    </script>
</body>
</html>
