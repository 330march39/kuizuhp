<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>クイズHP - 究極の学習パートナー</title>

    <!-- PWA関連 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="クイズHP">
    <meta name="theme-color" content="#4f46e5">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/4f46e5/ffffff?text=Q">

    <!-- 外部ライブラリとフォント -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class' // ここでダークモードの制御方法を'class'に指定します
      }
    </script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-color-hover: #4338ca;
        }
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; -webkit-tap-highlight-color: transparent; }
        .page { display: none; }
        .page.active { display: block; }
        #focus-page.page.active { display: flex; }
        #focus-page { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid var(--primary-color); width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .primary-bg { background-color: var(--primary-color); }
        .primary-bg-hover:hover { background-color: var(--primary-color-hover); }
        .primary-text { color: var(--primary-color); }
        .toggle-checkbox { appearance: none; width: 40px; height: 20px; background: #ccc; border-radius: 20px; position: relative; cursor: pointer; transition: background .3s; }
        .toggle-checkbox:before { content: ''; position: absolute; width: 16px; height: 16px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: transform .3s; }
        .toggle-checkbox:checked { background: var(--primary-color); }
        .toggle-checkbox:checked:before { transform: translateX(20px); }
        #theme-purchase-modal, #background-purchase-modal { z-index: 60; }

        /* ミニタイマー */
        #mini-timer-container {
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.4s;
            transform: translateY(150%);
            opacity: 0;
            pointer-events: none;
        }
        #mini-timer-container.visible {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
        #mini-timer-progress-bar {
            transition: width 0.5s linear;
        }
        /* 集中モード背景 */
        .focus-view-bg {
            background-size: cover;
            background-position: center;
            transition: background-image 0.5s ease-in-out;
        }
        /* 通知日選択ボタン */
        .day-btn.selected {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        #app-container {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .break-content-btn {
            background-color: rgba(255, 255, 255, 0.1);
            color: #edfcff;
            padding: 16px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .break-content-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        .sortable-ghost {
            opacity: 0.4;
            background-color: #e2e8f0; /* light gray */
        }
        .dark .sortable-ghost {
            background-color: #374151; /* dark gray */
        }
        .task-item .task-text-input {
            border-bottom: 1px solid transparent;
            transition: all 0.2s;
        }
        .task-item:hover .task-text-input {
            background-color: rgba(0,0,0,0.03);
        }
        .dark .task-item:hover .task-text-input {
            background-color: rgba(255,255,255,0.05);
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 overflow-hidden h-screen antialiased">

    <div id="app-container" class="h-full w-full flex flex-col max-w-lg mx-auto shadow-2xl">
        
        <header class="bg-white dark:bg-gray-800/80 backdrop-blur-sm z-30 p-4 flex items-center justify-between border-b border-gray-200 dark:border-gray-700 sticky top-0">
            <h1 id="header-title" class="text-xl font-bold text-gray-900 dark:text-white">ホーム</h1>
            <button id="lp-button" class="flex items-center space-x-2 bg-yellow-400/20 text-yellow-600 dark:text-yellow-400 rounded-full px-3 py-1 hover:bg-yellow-400/30 transition-colors">
                <i data-lucide="star" class="w-4 h-4 fill-current"></i>
                <span id="lp-display" class="font-bold text-sm">0 LP</span>
            </button>
        </header>

        <main class="flex-grow overflow-y-auto pb-20">
            <div id="home-page" class="page active p-4 space-y-6">
                <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm text-center">
                    <p id="today-date" class="text-lg font-semibold text-gray-600 dark:text-gray-300"></p>
                </div>

                 <div>
                    <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 flex items-center mb-3">
                        <i data-lucide="check-square" class="w-5 h-5 mr-2 primary-text"></i> 今日の予定
                    </h2>
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm">
                        <div id="home-task-list" class="space-y-2">
                            <p class="text-center text-sm text-gray-500">今日の予定はありません。</p>
                        </div>
                        <div class="flex items-center space-x-2 mt-4 pt-3 border-t border-gray-200 dark:border-gray-600">
                            <span id="new-task-number" class="font-bold w-6 text-center text-gray-500 dark:text-gray-400">1</span>
                            <input type="text" id="new-task-input" placeholder="新しいタスクを追加 (Enterで確定)" class="flex-grow bg-transparent p-1 border-b-2 border-gray-300 dark:border-gray-600 focus:border-indigo-500 focus:outline-none transition-colors">
                        </div>
                    </div>
                </div>
                
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 flex items-center"><i data-lucide="calendar-clock" class="w-5 h-5 mr-2 primary-text"></i> カウントダウン</h2>
                        <button id="add-countdown-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                    <div id="countdown-list" class="space-y-3"></div>
                </div>
                
                 <div>
                    <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 flex items-center mb-3"><i data-lucide="award" class="w-5 h-5 mr-2 primary-text"></i> 最近獲得した称号</h2>
                    <div id="recent-titles" class="flex space-x-3 overflow-x-auto pb-2"></div>
                </div>
            </div>

            <div id="study-page" class="page p-4">
                <div class="mb-6">
                    <h2 class="text-lg font-semibold mb-3 text-gray-700 dark:text-gray-300 flex items-center"><i data-lucide="pin" class="w-5 h-5 mr-2 primary-text"></i> ピン留め</h2>
                    <div id="pinned-quizzes" class="grid grid-cols-1 gap-3"></div>
                </div>
                <div>
                    <h2 class="text-lg font-semibold mb-3 text-gray-700 dark:text-gray-300 flex items-center"><i data-lucide="book-marked" class="w-5 h-5 mr-2 primary-text"></i> すべてのクイズ</h2>
                    <div id="filter-container" class="flex space-x-2 mb-4 overflow-x-auto pb-2"></div>
                    <div id="all-quizzes" class="grid grid-cols-1 gap-3"></div>
                </div>
            </div>             
            <div id="focus-page" class="page relative flex flex-col h-full">
                
                <div id="focus-main-view" class="flex flex-col h-full p-4">
                    <div class="flex-shrink-0 mb-4 space-y-4">
                        <button id="show-quest-btn" class="w-full p-3 rounded-lg font-bold text-lg shadow-md flex items-center justify-center space-x-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" data-mode="quest">
                            <i data-lucide="award" class="w-6 h-6"></i>
                            <span>クエスト</span>
                        </button>
                        
                        <div class="flex bg-gray-200 dark:bg-gray-700 rounded-lg p-1">
                            <button class="focus-mode-btn flex-1 p-2 rounded-md text-sm font-semibold" data-mode="timer">タイマー</button>
                            <button class="focus-mode-btn flex-1 p-2 rounded-md text-sm font-semibold" data-mode="stopwatch">ストップウォッチ</button>
                        </div>
                    </div>
            
                    <div id="timer-view" class="focus-view-bg flex-grow flex flex-col items-center justify-center text-center relative text-white rounded-lg">
                        <div class="absolute inset-0 bg-black/50 rounded-lg"></div>
                        <div class="relative z-10 p-4">
                            <div id="timer-settings-container">
                                <div class="flex items-center justify-center space-x-2 mb-6">
                                    <button class="time-add-btn bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full" data-time="60">1分</button>
                                    <button class="time-add-btn bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full" data-time="300">5分</button>
                                    <button class="time-add-btn bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full" data-time="1800">30分</button>
                                    <button class="time-add-btn bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full" data-time="3600">60分</button>
                                    <button id="timer-reset-btn" class="bg-white/20 hover:bg-white/30 w-10 h-10 rounded-full flex items-center justify-center">
                                        <i data-lucide="rotate-cw" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="focus-timer-display" class="text-7xl font-bold tabular-nums mb-6">30:00</div>
                            <button id="focus-start-btn" class="primary-bg primary-bg-hover text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg flex items-center mx-auto"><i data-lucide="play" class="w-6 h-6 mr-2"></i>スタート</button>
                            <div id="focus-controls" class="hidden flex flex-wrap items-center justify-center gap-4">
                                <button id="focus-pause-btn" class="bg-gray-500/70 hover:bg-gray-600/70 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg flex items-center"><i data-lucide="pause" class="w-6 h-6 mr-2"></i>一時停止</button>
                                <button id="focus-end-btn" class="bg-red-500/70 hover:bg-red-600/70 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg flex items-center"><i data-lucide="stop-circle" class="w-6 h-6 mr-2"></i>終了</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="stopwatch-view" class="focus-view-bg hidden flex-grow flex-col items-center justify-center text-center relative text-white rounded-lg">
                        <div class="absolute inset-0 bg-black/50 rounded-lg"></div>
                        <div class="relative z-10 p-4">
                            <div id="stopwatch-display" class="text-7xl font-bold tabular-nums mb-6">00:00</div>
                            <button id="stopwatch-start-btn" class="primary-bg primary-bg-hover text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg flex items-center mx-auto"><i data-lucide="play" class="w-6 h-6 mr-2"></i>スタート</button>
                            <div id="stopwatch-controls" class="hidden flex flex-wrap items-center justify-center gap-4">
                                <button id="stopwatch-pause-btn" class="bg-gray-500/70 hover:bg-gray-600/70 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg flex items-center"><i data-lucide="pause" class="w-6 h-6 mr-2"></i>一時停止</button>
                                <button id="stopwatch-end-btn" class="bg-red-500/70 hover:bg-red-600/70 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg flex items-center"><i data-lucide="flag" class="w-6 h-6 mr-2"></i>記録して終了</button>
                            </div>
                        </div>
                    </div>
                </div>
            
                <div id="quest-view" class="hidden absolute inset-0 z-10 flex-col p-4">
                    
                    <div class="flex-shrink-0 flex items-center justify-between mb-4">
                        <button id="quest-back-btn" class="p-2 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full">
                            <i data-lucide="chevron-left" class="w-6 h-6"></i>
                        </button>
                        <h2 class="text-xl font-bold text-gray-900 dark:text-white">クエスト設定</h2>
                        <div class="w-10"></div> </div>
                    
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm mb-4">
                        <button id="load-tasks-btn" class="w-full mb-2 primary-bg primary-bg-hover text-white py-2 px-4 rounded-lg font-bold flex items-center justify-center space-x-2">
                            <i data-lucide="check-square" class="w-5 h-5"></i>
                            <span>「今日の予定」を読み込む</span>
                        </button>
                        <hr class="my-3 border-gray-200 dark:border-gray-600">
                        
                        <div class="flex items-center space-x-2 text-sm">
                            <input type="number" id="break-interval-input" value="2" class="w-16 p-1 border rounded dark:bg-gray-800 dark:border-gray-600">
                            <span>セクションごとに</span>
                            <input type="number" id="break-duration-input" value="5" class="w-16 p-1 border rounded dark:bg-gray-800 dark:border-gray-600">
                            <span>分休憩</span>
                        </div>
                        <button id="add-breaks-btn" class="mt-2 text-sm bg-gray-200 dark:bg-gray-600 px-3 py-1 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition">休憩を自動挿入</button>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm flex-grow overflow-y-auto pb-20"> <div id="quest-plan-list" class="space-y-2">
                            </div>
                        
                        <div class="flex justify-between mt-4">
                            <button id="add-section-btn" class="text-sm bg-gray-200 dark:bg-gray-600 px-3 py-1 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition">セクション追加</button>
                            <button id="add-break-btn" class="text-sm bg-gray-200 dark:bg-gray-600 px-3 py-1 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition">休憩追加</button>
                        </div>
                    </div>
                    
                    <div class="fixed bottom-16 left-0 right-0 max-w-lg mx-auto p-4">
                        <button id="start-quest-btn" class="w-full primary-bg primary-bg-hover text-white py-3 px-4 rounded-lg font-bold text-lg shadow-md hover:scale-105 transition-transform transform flex items-center justify-center space-x-2">
                            <i data-lucide="play" class="w-6 h-6"></i>
                            <span>クエストを開始する</span>
                        </button>
                    </div>
            
                </div>
            </div>
            <div id="my-chart-page" class="page p-4 space-y-6">
                <div>
                    <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 flex items-center mb-3"><i data-lucide="bar-chart-3" class="w-5 h-5 mr-2 primary-text"></i> 週間学習レポート</h2>
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow"><canvas id="study-time-chart"></canvas></div>
                </div>
                <div>
                    <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 flex items-center mb-3"><i data-lucide="pie-chart" class="w-5 h-5 mr-2 primary-text"></i> 教科別 理解度カルテ</h2>
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow"><canvas id="subject-radar-chart"></canvas></div>
                </div>
                
            </div>

            <div id="settings-page" class="page p-4 space-y-4">
                <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                    <h3 class="font-semibold mb-2">通知設定</h3>
                    <button id="notification-permission-btn" class="w-full primary-bg primary-bg-hover text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center mb-4"><i data-lucide="bell-ring" class="w-5 h-5 mr-2"></i>ブラウザ通知を許可</button>
                </div>
                <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                     <h3 class="font-semibold mb-2">テーマカラーを選択</h3>
                     <div id="theme-selector" class="grid grid-cols-4 gap-4"></div>
                </div>
                <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                    <h3 class="font-semibold mb-2">壁紙を選択</h3>
                    <div id="background-selector" class="grid grid-cols-3 gap-4"></div>
                    <hr class="my-4 border-gray-200 dark:border-gray-600">
                    <div class="flex items-center justify-between">
                        <p class="font-semibold">壁紙をアプリ全体に適用</p>
                        <input type="checkbox" id="background-scope-toggle" class="toggle-checkbox">
                    </div>
                </div>
            </div>
        </main>

        <div id="mini-timer-container" class="fixed bottom-20 left-0 right-0 max-w-lg mx-auto px-4 z-20">
             <div id="mini-timer-bar" class="w-full bg-gray-800/90 backdrop-blur-sm rounded-lg shadow-lg flex items-center p-2 space-x-3 cursor-pointer">
                <div class="flex items-center space-x-3 flex-grow min-w-0">
                    <i data-lucide="timer" class="w-5 h-5 primary-text flex-shrink-0"></i>
                    <span id="mini-timer-text" class="text-sm font-bold tabular-nums text-white truncate"></span>
                </div>
                <div class="w-1/3 h-1.5 bg-gray-600 rounded-full overflow-hidden flex-shrink-0">
                    <div id="mini-timer-progress-bar" class="h-full primary-bg rounded-full"></div>
                </div>
                <button id="close-mini-timer-btn" class="p-1 text-gray-400 hover:text-white flex-shrink-0">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <nav class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto h-16 bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm border-t border-gray-200 dark:border-gray-700 flex justify-around items-center shadow-top z-20">
            <button class="tab-btn flex flex-col items-center justify-center w-full h-full primary-text" data-page="home-page" data-title="ホーム"><i data-lucide="home" class="w-6 h-6"></i><span class="text-xs mt-1">ホーム</span></button>
            <button class="tab-btn flex flex-col items-center justify-center w-full h-full text-gray-500" data-page="study-page" data-title="学習"><i data-lucide="book-marked" class="w-6 h-6"></i><span class="text-xs mt-1">学習</span></button>
            <button class="tab-btn flex flex-col items-center justify-center w-full h-full text-gray-500" data-page="focus-page" data-title="集中"><i data-lucide="timer" class="w-6 h-6"></i><span class="text-xs mt-1">集中</span></button>
            <button class="tab-btn flex flex-col items-center justify-center w-full h-full text-gray-500" data-page="my-chart-page" data-title="マイカルテ"><i data-lucide="clipboard-list" class="w-6 h-6"></i><span class="text-xs mt-1">マイカルテ</span></button>
            <button class="tab-btn flex flex-col items-center justify-center w-full h-full text-gray-500" data-page="settings-page" data-title="設定"><i data-lucide="settings" class="w-6 h-6"></i><span class="text-xs mt-1">設定</span></button>
        </nav>
    </div>

    <!-- ===== モーダル ===== -->
    <div id="quiz-modal" class="fixed inset-0 bg-black/70 z-50 flex-col hidden"><div class="w-full h-full max-w-lg mx-auto bg-gray-100 dark:bg-gray-900 flex flex-col"><header class="p-3 flex items-center justify-between shadow-md bg-white dark:bg-gray-800"><h2 id="quiz-modal-title" class="truncate font-bold"></h2><button class="close-modal-btn p-1" data-modal="quiz-modal"><i data-lucide="x"></i></button></header><div class="flex-grow relative"><div class="absolute inset-0 flex items-center justify-center"><div id="loader"></div></div><iframe id="quiz-iframe" class="w-full h-full border-0 invisible" sandbox="allow-scripts allow-forms allow-popups"></iframe></div></div></div>
    <div id="assessment-modal" class="fixed inset-0 bg-black/70 z-50 items-center justify-center hidden p-4">
            <div class="bg-white dark:bg-gray-700 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
                <h2 class="text-xl font-bold mb-4">お疲れ様でした！</h2>
                <p class="mb-6">このクイズの理解度を記録しよう</p>
                <div class="flex justify-around">
                    <button class="assessment-btn p-2 w-24 flex flex-col items-center" data-level="3"><i data-lucide="award" class="w-10 h-10 text-yellow-400 mb-1 mx-auto"></i><p>完 璧</p></button>
                    <button class="assessment-btn p-2 w-24 flex flex-col items-center" data-level="2"><i data-lucide="thumbs-up" class="w-10 h-10 text-green-400 mb-1 mx-auto"></i><p>まあまあ</p></button>
                    <button class="assessment-btn p-2 w-24 flex flex-col items-center" data-level="1"><i data-lucide="book-open-check" class="w-10 h-10 text-blue-400 mb-1 mx-auto"></i><p>要復習</p></button>
                </div>
            </div>    </div><div id="theme-purchase-modal" class="fixed inset-0 bg-black/70 z-50 items-center justify-center hidden p-4">
    <div class="bg-white dark:bg-gray-700 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
        <h2 id="theme-purchase-title" class="text-xl font-bold mb-2"></h2>
        <div id="theme-preview" class="w-20 h-20 rounded-full mx-auto my-4 border-4 border-gray-200 dark:border-gray-600 shadow-inner"></div>
        <p id="theme-purchase-cost" class="mb-6"></p>
        <div class="flex justify-center space-x-4">
            <button id="theme-purchase-cancel" class="bg-gray-200 dark:bg-gray-600 px-6 py-2 rounded-lg">やめる</button>
            <button id="theme-purchase-confirm" class="primary-bg primary-bg-hover text-white px-6 py-2 rounded-lg transition-colors disabled:bg-gray-400 dark:disabled:bg-gray-500 disabled:cursor-not-allowed">交換する</button>
        </div>
    </div>
</div>

<div id="background-purchase-modal" class="fixed inset-0 bg-black/70 z-50 items-center justify-center hidden p-4">
    <div class="bg-white dark:bg-gray-700 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
        <h2 id="background-purchase-title" class="text-xl font-bold mb-2"></h2>
        <div id="background-preview" class="w-5/6 aspect-[8/16] rounded-lg mx-auto my-4 bg-gray-200 dark:bg-gray-800 bg-cover bg-center shadow-inner"></div>
        <p id="background-purchase-cost" class="mb-6"></p>
        <div class="flex justify-center space-x-4">
            <button id="background-purchase-cancel" class="bg-gray-200 dark:bg-gray-600 px-6 py-2 rounded-lg">やめる</button>
            <button id="background-purchase-confirm" class="primary-bg primary-bg-hover text-white px-6 py-2 rounded-lg transition-colors disabled:bg-gray-400 dark:disabled:bg-gray-500 disabled:cursor-not-allowed">交換する</button>
        </div>
    </div>
</div>
    
    <div id="countdown-modal" class="fixed inset-0 bg-black/70 z-50 items-center justify-center hidden p-4"><div class="bg-white dark:bg-gray-700 rounded-lg shadow-xl w-full max-w-sm p-6"><h2 id="countdown-modal-title" class="text-xl font-bold mb-4">カウントダウン設定</h2><div class="space-y-4"><input id="countdown-name" type="text" placeholder="イベント名 (例: 期末テスト)" class="w-full p-2 border rounded dark:bg-gray-800 dark:border-gray-600"><input id="countdown-date" type="date" class="w-full block p-2 border rounded dark:bg-gray-800 dark:border-gray-600"></div><div class="mt-6"><h3 class="font-semibold mb-2">通知設定</h3><div class="bg-gray-100 dark:bg-gray-800 p-3 rounded-lg space-y-3"><div class="flex items-center justify-between"><p>通知をオンにする</p><input type="checkbox" id="countdown-notification-toggle" class="toggle-checkbox"></div><div id="countdown-notification-details" class="space-y-3"><div class="flex items-center justify-between"><p>通知時刻</p><input id="countdown-notification-time" type="time" class="p-1 border rounded dark:bg-gray-600 dark:border-gray-500"></div><div><p class="mb-2">通知するタイミング (複数選択可)</p><div id="countdown-notification-days" class="flex flex-wrap gap-2"></div></div></div></div></div><div class="flex justify-between items-center mt-6"><button id="countdown-delete-btn" class="text-red-500 hover:text-red-700 font-semibold p-2 hidden"><i data-lucide="trash-2" class="w-5 h-5 inline-block mr-1"></i>削除</button><div class="flex space-x-2"><button id="countdown-cancel-btn" class="bg-gray-200 dark:bg-gray-600 px-6 py-2 rounded-lg">キャンセル</button><button id="countdown-save-btn" class="primary-bg primary-bg-hover text-white px-6 py-2 rounded-lg">保存</button></div></div></div></div>

    <div id="point-details-modal" class="fixed inset-0 bg-black/70 z-50 items-center justify-center hidden p-4"><div class="bg-white dark:bg-gray-700 rounded-lg shadow-xl w-full max-w-sm p-6 flex flex-col max-h-[90vh]"><div class="flex justify-between items-center mb-4 flex-shrink-0"><h2 class="text-xl font-bold">マイステータス</h2><button id="close-point-modal-btn" class="p-1"><i data-lucide="x"></i></button></div><div class="space-y-6 overflow-y-auto"><div class="text-center"><p class="text-sm text-gray-500">現在の学習ポイント</p><p class="text-4xl font-bold primary-text" id="modal-lp-display"></p></div><div><h3 class="font-semibold mb-2">テーマカラー</h3><div id="modal-theme-selector" class="grid grid-cols-4 gap-4"></div></div><div><h3 class="font-semibold mb-2">壁紙</h3><div id="modal-background-selector" class="grid grid-cols-3 gap-2"></div></div><div><h3 class="font-semibold mb-2">獲得した称号</h3><div id="modal-titles-list" class="flex flex-wrap gap-2"></div></div></div></div></div>
    <div id="toast" class="fixed top-5 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-all duration-300 z-50 transform -translate-y-10"></div>
        
    <div id="quest-active-screen" class="hidden fixed inset-0 bg-gray-900 dark:bg-black text-gray-100 z-50 flex flex-col items-center justify-center p-4">
        <button id="end-quest-btn" class="absolute top-6 right-6 text-gray-300 p-2 rounded-full hover:bg-gray-700 transition-colors">
            <i data-lucide="x" class="w-8 h-8"></i>
        </button>
                
        <div id="quest-content-area" class="w-full h-full flex flex-col items-center justify-center">
            <div id="quest-section-view" class="hidden text-center">
                <h2 id="quest-section-title" class="text-2xl md:text-3xl font-bold mb-2 text-gray-400"></h2>
                <p class="text-7xl md:text-9xl font-mono font-extrabold" id="quest-timer">25:00</p>
                <p id="quest-progress" class="mt-4 text-lg text-gray-400"></p>
            </div>
    
            <div id="quest-break-view" class="hidden w-full h-full flex flex-col items-center pt-16">
                <div class="text-center mb-8">
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-400">☕ ブレイクタイム</h2>
                    <p class="text-5xl md:text-7xl font-mono font-extrabold" id="break-timer">05:00</p>
                </div>
                
                <div id="break-content-selector" class="grid grid-cols-2 gap-4 w-full max-w-sm">
                    <button class="break-content-btn" data-type="sns">
                        <i data-lucide="smartphone" class="w-10 h-10"></i>
                        <span>SNS</span>
                    </button>
                    <button class="break-content-btn" data-type="game">
                        <i data-lucide="gamepad-2" class="w-10 h-10"></i>
                        <span>ゲーム</span>
                    </button>
                </div>
                
                <div id="break-sns-selector" class="hidden grid grid-cols-3 gap-4 w-full max-w-sm mt-4">
                    <button class="break-content-btn" data-url="https://x.com">X</button>
                    <button class="break-content-btn" data-url="https://instagram.com">Instagram</button>
                    <button class="break-content-btn" data-url="https://youtube.com">YouTube</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="iframe-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[60] flex flex-col">
        <div class="bg-gray-800 p-2 flex justify-end">
            <button id="close-iframe-btn" class="text-gray-300 p-1 rounded-full hover:bg-gray-700">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        <iframe id="break-iframe" class="w-full h-full" src="about:blank"></iframe>
    </div>
    
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[70] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-700 rounded-xl shadow-2xl p-6 w-full max-w-sm text-center">
            <h3 id="modal-title" class="text-lg font-bold text-gray-900 dark:text-white mb-4">クエストを終了しますか？</h3>
            <div class="flex justify-center space-x-4">
                <button id="modal-cancel-btn" class="px-6 py-2 rounded-lg bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 font-semibold hover:bg-gray-300 dark:hover:bg-gray-500 transition">キャンセル</button>
                <button id="modal-confirm-btn" class="px-6 py-2 rounded-lg bg-red-500 text-white font-semibold hover:bg-red-600 transition">終了</button>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const initialData = {
                quizzes: [
                    { id: 'math1', title: "数学 - 正負の数", subject: "数学", genre: "中1", tags: ['english1'], url: "https://docs.google.com/forms/d/e/1FAIpQLScsC0BFa_3gY-f-u4pW8Q22o_l3c0T-t_9c3z-q8pY6X-u8qQ/viewform?usp=sf_link" },
                    { id: 'english1', title: "英語 - be動詞", subject: "英語", genre: "中1", tags: ['math1', 'history1'], url: "https://docs.google.com/forms/d/e/1FAIpQLSfvtBwi1Tb1z6YEQOclBi4J7pxOc8lEILZ-OPZ4k6aebFJmTg/viewform" },
                    { id: 'science1', title: "理科 - 植物のつくり", subject: "理科", genre: "中1", tags: [], url: "https://docs.google.com/forms/d/e/1FAIpQLSfp-24sW_4xT8d_aK_b_nL5e-pX7a-j8vN-qA9rR_cT_uL-vQ/viewform?usp=sf_link" },
                    { id: 'japanese1', title: "国語 - 枕草子", subject: "国語", genre: "古典", tags: ['history1'], url: "https://docs.google.com/forms/d/e/1FAIpQLSe-0P7p_L-rT9c-yS_eD-wA9iR_bO8kM-nL-u_V-iE7xS-tQ/viewform?usp=sf_link" },
                    { id: 'history1', title: "社会 - 鎌倉時代", subject: "社会", genre: "歴史", tags: ['japanese1'], url: "https://docs.google.com/forms/d/e/1FAIpQLSeLprqPbZCZv2ufQ2qYqltnRiUE1FsBYODa_eNwOVO1NqZwBw/viewform?usp=pp_url" },
                ],
                titles: [
                    { id: 'math_master', name: '数学マスター', condition: (s) => initialData.quizzes.filter(q => q.subject === '数学' && s.progress[q.id]?.level === 3).length >= 1 },
                    { id: 'perfect_day', name: 'パーフェクトデイ', condition: (s) => Object.values(s.progress).filter(p => new Date(p.date).toDateString() === new Date().toDateString() && p.level === 3).length >= 3 },
                    { id: 'focus_1hr', name: '集中力の初星', condition: (s) => s.focus.totalTime >= 3600 },
                ],
                themes: {
                    default: { name: 'デフォルト', color: '#4f46e5', hover: '#4338ca', cost: 0 },
                    green: { name: 'フォレスト', color: '#16a34a', hover: '#15803d', cost: 100 },
                    red: { name: 'サンセット', color: '#dc2626', hover: '#b91c1c', cost: 150 },
                    orange: { name: 'ビタミン', color: '#f97316', hover: '#ea580c', cost: 200 },
                    purple: { name: 'ミッドナイト', color: '#7c3aed', hover: '#6d28d9', cost: 250 },
                    pink: { name: 'チェリー', color: '#db2777', hover: '#be185d', cost: 300 },
                    teal: { name: 'オーシャン', color: '#0d9488', hover: '#0f766e', cost: 350 },
                },
                backgrounds: {
                    default: { name: 'デフォルト', url: '', cost: 0 , tone: 'system' },
                    sky: { name: '青空と流れ星', url: 'okumono_hosisoratate8.png', cost: 500, tone: 'light' },
                    night: { name: '手書きゆるドット', url: 'https://sozaino.site/wp-content/uploads/2022/01/yurudot32.png', cost: 700, tone: 'light' },
                    sdotb: { name: 'シャワードット(ブルー)', url: 'https://sozaino.site/wp-content/uploads/2020/11/sai-4.png', cost: 700, tone: 'light' },
                    utyuu: { name: '壮大な宇宙', url: 'https://sozaino.site/wp-content/uploads/2021/02/utyuu.jpg', cost: 700, tone: 'dark' },
                    jyanguru: { name: 'ジャングル', url: 'https://sozaino.site/wp-content/uploads/2025/07/okumono_jungle1.png', cost: 700, tone: 'dark' },
                    wapop: { name: '和ポップ（ピンク）', url: 'okumono_wapop3.png', cost: 700, tone: 'dark' },
                }
            };

            let state;
            let chartInstances = {};
            let focusTimer = { interval: null, defaultTime: 0, timeLeft: 0, isRunning: false, isPaused: false };
            let stopwatch = { interval: null, startTime: 0, elapsedTime: 0, isRunning: false, isPaused: false };
            let miniTimerTemporarilyHidden = false;
            let quizTimer = { startTime: null };

            const $ = (s) => document.querySelector(s);
            const $$ = (s) => document.querySelectorAll(s);
            
            let homeTaskListEl, newTaskInput, newTaskNumberEl;

            let quest = {
                plan: [], // { id, type: 'section' | 'break', text?, duration }
                active: false,
                currentIndex: -1,
                timerInterval: null,
                timeLeft: 0,
            };

            // クエスト用 DOM要素
            const questView = $('#quest-view');
            const questPlanListEl = $('#quest-plan-list');
            const startQuestBtn = $('#start-quest-btn');
            const addBreaksBtn = $('#add-breaks-btn');
            const addSectionBtn = $('#add-section-btn');
            const addBreakBtn = $('#add-break-btn');
            
            const questActiveScreen = $('#quest-active-screen');
            const questSectionView = $('#quest-section-view');
            const questBreakView = $('#quest-break-view');
            const questSectionTitle = $('#quest-section-title');
            const questTimerEl = $('#quest-timer');
            const breakTimerEl = $('#break-timer');
            const questProgressEl = $('#quest-progress');
            const endQuestBtn = $('#end-quest-btn');

            const confirmationModal = $('#confirmation-modal');
            const modalConfirmBtn = $('#modal-confirm-btn');
            const modalCancelBtn = $('#modal-cancel-btn');

            const iframeOverlay = $('#iframe-overlay');
            const breakIframe = $('#break-iframe');
            const closeIframeBtn = $('#close-iframe-btn');
            const breakContentSelector = $('#break-content-selector');
            const breakSnsSelector = $('#break-sns-selector');

            const loadState = () => {
                const defaultState = {
                    profile: { 
                        lp: 0, 
                        unlockedThemes: ['default'], 
                        earnedTitles: [], 
                        activeTheme: 'default',
                        unlockedBackgrounds: ['default'],
                        activeBackground: 'default',
                        tasksLastUpdated: null
                    },
                    tasks: [],
                    progress: {},
                    pinnedQuizzes: [],
                    countdowns: [],
                    focus: { 
                        totalTime: 0, 
                        mode: 'timer',
                        isRunning: false, // 実行中かどうかのフラグ
                        startTime: null,  // 開始時刻のタイムスタンプ
                        duration: 0       // タイマーの総時間
                    },
                    studyLog: {}, 
                    settings: { backgroundScopeGlobal: true , manualDarkMode: false },
                    lastLogin: null,
                    //lastNotificationCheck: new Date().toISOString(),＜削除する
                };
                
                // --- ▼▼▼ 修正箇所 ▼▼▼ ---
                
                // 1. 読み込み先の変数を `let` で宣言
                let loaded = {};
                try {
                    // 2. 保存されたデータを取得
                    const savedData = localStorage.getItem('quizAppUltimateV8');
                    // 3. データが null や空文字でない場合のみ、JSONとしてパース（解析）する
                    if (savedData) {
                        loaded = JSON.parse(savedData);
                    }
                } catch (e) {
                    // 4. パースに失敗（データが破損）した場合
                    console.error("ローカルストレージの読み込みに失敗しました。データをリセットします:", e);
                    // 5. 破損したデータを削除し、`loaded` は空のままにする
                    localStorage.removeItem('quizAppUltimateV8');
                }
                
                // 6. デフォルト値をベースに、読み込んだ値で上書き（ネストされたオブジェクトも安全にマージ）
                // (ここは元のコードと同じ)
                state = {
                    ...defaultState,
                    ...loaded,
                    profile: { ...defaultState.profile, ...(loaded.profile || {}) },
                    focus: { ...defaultState.focus, ...(loaded.focus || {}) },
                    settings: { ...defaultState.settings, ...(loaded.settings || {}) }
                };
                // --- ▲▲▲ 修正ここまで ▲▲▲ ---

                // 3. ログインボーナス処理 (元のロジックをそのまま流用)
                if(state.lastLogin !== new Date().toDateString()){
                    addLP(10000, 'ログインボーナス', false);
                    state.lastLogin = new Date().toDateString();
                    saveState(); // stateが完全に構築された後に保存
                }

                // 4. 今日の予定リセット処理
                const today = new Date().toDateString();
                if (state.profile.tasksLastUpdated !== today) {
                    console.log('日付が変わったため、タスクをリセットします。');
                    state.tasks = []; // タスクを空にする
                    state.profile.tasksLastUpdated = today; // 更新日を今日に設定
                }
            };
            
            const saveState = () => localStorage.setItem('quizAppUltimateV8', JSON.stringify(state));
            
           // 既存の updateAppearance 関数を、この新しいコードで完全に置き換えてください。
            
            const updateAppearance = () => {
                const appContainer = $('#app-container');
                const activeBgId = state.profile.activeBackground;
                const activeBg = initialData.backgrounds[activeBgId] || initialData.backgrounds['default'];
                const isGlobal = state.settings.backgroundScopeGlobal;
                const hasImage = activeBg && activeBg.url;
                
                // --- 1. テーマ決定ロジック ---
                let effectiveTone = activeBg.tone;
                
                if (effectiveTone === 'system') {
                    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                        effectiveTone = 'dark';
                    } else {
                        effectiveTone = 'light';
                    }
                }
                
                // --- 2. 決定したテーマをHTML要素に適用 (修正済みのロジック) ---
                if (effectiveTone === 'dark') {
                    document.documentElement.classList.add('dark');
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    document.documentElement.setAttribute('data-theme', 'light');
                }
                
                // --- 3. 背景画像の適用ロジック ---
                if (isGlobal && hasImage) {
                    appContainer.style.backgroundImage = `url(${activeBg.url})`;
                } else {
                    appContainer.style.backgroundImage = 'none';
                }
            };

            const updateLpDisplay = () => {
                $('#lp-display').textContent = `${state.profile.lp} LP`;
                if ($('#point-details-modal').style.display === 'flex') {
                    $('#modal-lp-display').textContent = state.profile.lp;
                }
            };

            const renderEngine = {
                pages: {
                    'home-page': () => {
                        const today = new Date();
                        $('#today-date').textContent = `${today.getFullYear()}年 ${today.getMonth() + 1}月 ${today.getDate()}日 (${'日月火水木金土'[today.getDay()]}曜日)`;

                        const countdownContainer = $('#countdown-list');
                        countdownContainer.innerHTML = state.countdowns.length ? state.countdowns.map(cd => {
                            const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                            const targetStart = new Date(cd.date);
                            targetStart.setHours(0,0,0,0);
                            const diffTime = targetStart - todayStart;
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            const dayText = diffDays > 0 ? `あと <span class="text-2xl font-bold primary-text">${diffDays}</span> 日` : diffDays === 0 ? `<span class="text-xl font-bold text-red-500">今日です！</span>` : `<span class="text-gray-500">終了</span>`;
                            return `<div class="bg-white dark:bg-gray-700 rounded-lg shadow-sm p-3 flex items-center justify-between"><div><h3 class="font-semibold text-gray-800 dark:text-gray-200">${cd.name}</h3><p class="text-sm text-gray-500 dark:text-gray-400">${cd.date.replace(/-/g, '/')}</p></div><div class="flex items-center"><div class="mr-4">${dayText}</div><button class="edit-countdown-btn p-2 text-gray-400 hover:text-gray-600" data-id="${cd.id}"><i data-lucide="edit" class="w-4 h-4"></i></button></div></div>`;
                        }).join('') : `<p class="text-sm text-gray-500 text-center">右上の「+」ボタンでテストなどの日程を追加できます。</p>`;

                        
                        const titlesContainer = $('#recent-titles');
                        // 1. 称号オブジェクトの配列を取得
                        const titles = state.profile.earnedTitles
                            .slice(-5)
                            .reverse()
                            .map(tid => initialData.titles.find(t => t.id === tid))
                            .filter(Boolean); // <-- 【重要】ここで undefined を取り除く

                        // 2. 取得できた称号が1件以上ある場合のみ描画
                        titlesContainer.innerHTML = titles.length 
                          ? titles.map(title => { // 安全な配列を map する
                              return `<div class="bg-white dark:bg-gray-700 p-2 rounded-lg shadow-sm text-center min-w-[100px]"><i data-lucide="award" class="mx-auto w-8 h-8 text-yellow-500"></i><p class="text-xs font-semibold mt-1">${title.name}</p></div>`;
                          }).join('') 
                          : `<p class="text-sm text-gray-500">称号を獲得してここに表示しよう！</p>`;
                        renderHomeTasks();
                    },
                    'study-page': () => {
                        const pinnedContainer = $('#pinned-quizzes');
                        const pinnedSectionContainer = pinnedContainer.parentElement;
                    
                        if (state.pinnedQuizzes.length > 0) {
                            pinnedSectionContainer.style.display = 'block';
                            const pinnedQuizzes = state.pinnedQuizzes.map(id => initialData.quizzes.find(q => q.id === id)).filter(Boolean);
                            pinnedContainer.innerHTML = pinnedQuizzes.map(q => createQuizCard(q, true)).join('');
                        } else {
                            pinnedSectionContainer.style.display = 'none';
                        }
                    
                        const allContainer = $('#all-quizzes');
                        const subjects = ['all', ...new Set(initialData.quizzes.map(q => q.subject))];
                        const activeFilter = $('#filter-container .active')?.dataset.filter || 'all';
                        $('#filter-container').innerHTML = subjects.map(s => `<button class="filter-btn ${s === activeFilter ? 'active primary-bg text-white' : 'bg-gray-200 dark:bg-gray-600'} px-4 py-1.5 rounded-full text-sm font-medium whitespace-nowrap" data-filter="${s}">${s === 'all' ? 'すべて' : s}</button>`).join('');
                    
                        const quizzes = initialData.quizzes.filter(q => activeFilter === 'all' || q.subject === activeFilter);
                        allContainer.innerHTML = quizzes.map(q => createQuizCard(q, state.pinnedQuizzes.includes(q.id))).join('');
                    },
                    // 変更後
                  'focus-page': () => {
                      updateFocusModeUI();
                        const activeBg = initialData.backgrounds[state.profile.activeBackground] || initialData.backgrounds['default'];
                        const hasImage = activeBg && activeBg.url;
                        const isGlobal = state.settings.backgroundScopeGlobal;
                        
                        $$('.focus-view-bg').forEach(el => {
                            // 「全体適用」がオフで、かつ画像がある場合のみ、集中モードの要素に直接背景を設定
                            if (!isGlobal && hasImage) {
                                el.style.backgroundImage = `url(${activeBg.url})`;
                            } else {
                                // 「全体適用」がオンの場合は、#app-containerの背景が見えるように自身の背景を消す
                                el.style.backgroundImage = 'none';
                            }
                        });
                    },
                    'my-chart-page': () => {
                        const activeTheme = initialData.themes[state.profile.activeTheme] || initialData.themes['default'];
                        const activeThemeColor = activeTheme.color;
                        const rgb = hexToRgb(activeThemeColor);
                        const chartAreaColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.2)`;
                        const chartBarColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.5)`;
                        const chartBorderColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 1)`;
                        const subjects = [...new Set(initialData.quizzes.map(q => q.subject))];
                        const radarData = subjects.map(sub => {
                            const quizzesInSub = initialData.quizzes.filter(q => q.subject === sub);
                            const totalLevels = quizzesInSub.reduce((acc, q) => acc + (state.progress[q.id]?.level || 0), 0);
                            const completedCount = quizzesInSub.filter(q => state.progress[q.id]).length;
                            return completedCount > 0 ? (totalLevels / completedCount) / 3 * 100 : 0;
                        });
                        renderChart('subject-radar-chart', 'radar', { labels: subjects, datasets: [{ label: '理解度 (%)', data: radarData, backgroundColor: chartAreaColor, borderColor: chartBorderColor, borderWidth: 2 }] }, { scales: { r: { beginAtZero: true, max: 100 } } });

                    
                        const labels = [];
                        const data = [];
                        for (let i = 6; i >= 0; i--) {
                            const d = new Date();
                            d.setDate(d.getDate() - i);
                            const day = d.toISOString().split('T')[0];
                            labels.push(`${d.getMonth()+1}/${d.getDate()}`);
                            const log = state.studyLog[day] || { focus: 0, quiz: 0 };
                            data.push((log.focus + log.quiz) / 60); // in minutes
                        }
                        renderChart('study-time-chart', 'bar', { labels, datasets: [{ label: '学習時間 (分)', data, backgroundColor: chartBarColor, borderColor: chartBorderColor, borderWidth: 1 }] }, { scales: { y: { beginAtZero: true } } });
                    },
                    'settings-page': () => {
                        
                        $('#theme-selector').innerHTML = state.profile.unlockedThemes.map(id => {
                            const theme = initialData.themes[id];
                            const isActive = state.profile.activeTheme === id;
                            return `<div class="text-center">
                                <button class="theme-btn w-12 h-12 rounded-full border-4 ${isActive ? 'border-blue-500' : 'border-transparent'} relative" style="background-color: ${theme.color}" data-theme="${id}"></button>
                                <p class="text-xs mt-1">${theme.name}</p>
                            </div>`;
                        }).join('') || `<p class="text-sm text-gray-500">マイステータスからテーマを交換できます。</p>`;

                        $('#background-selector').innerHTML = state.profile.unlockedBackgrounds.map(id => {
                            const bg = initialData.backgrounds[id];
                            const isActive = state.profile.activeBackground === id;
                             return `<div class="text-center">
                                <button class="background-btn w-full h-20 rounded-lg border-4 ${isActive ? 'border-blue-500' : 'border-transparent'} relative bg-gray-500 bg-cover bg-center" style="background-image: ${bg.url ? `url(${bg.url})` : 'none'}" data-bg="${id}"></button>
                                <p class="text-xs mt-1">${bg.name}</p>
                            </div>`;
                        }).join('') || `<p class="text-sm text-gray-500">マイステータスから背景を交換できます。</p>`;
                    }
                },
                renderAll: () => {
                    for(const pageId in renderEngine.pages){
                        if($(`#${pageId}`).classList.contains('active')){
                            renderEngine.pages[pageId]();
                        }
                    }
                    updateLpDisplay();
                    const activeTheme = initialData.themes[state.profile.activeTheme] || initialData.themes['default'];
                    document.documentElement.style.setProperty('--primary-color', activeTheme.color);
                    document.documentElement.style.setProperty('--primary-color-hover', activeTheme.hover);
                }
            };
            
           const createQuizCard = (quiz, isPinned) => {
                if(!quiz) return '';
                const progress = state.progress[quiz.id];
                const levelIcons = { 1: 'book-open-check', 2: 'thumbs-up', 3: 'award'};
                return `<div class="bg-white dark:bg-gray-700 rounded-lg shadow-sm p-3 flex items-center justify-between quiz-card" data-id="${quiz.id}"><div class="flex items-center min-w-0"><div class="w-5 h-5 mr-3 flex-shrink-0">${progress ? `<i data-lucide="${levelIcons[progress.level]}" class="text-yellow-500"></i>` : ``}</div><div class="truncate"><h3 class="font-semibold text-gray-800 dark:text-gray-200 truncate">${quiz.title}</h3><p class="text-sm text-gray-500 dark:text-gray-400">${quiz.subject} - ${quiz.genre}</p></div></div><button class="pin-btn p-2 -mr-2 flex-shrink-0" data-id="${quiz.id}"><i data-lucide="pin" class="w-5 h-5 ${isPinned ? 'primary-text fill-current' : 'text-gray-400'}"></i></button></div>`;
            };
            
            const renderChart = (canvasId, type, data, options) => {
                const ctx = $(`#${canvasId}`).getContext('2d');
                if(chartInstances[canvasId]) chartInstances[canvasId].destroy();
                chartInstances[canvasId] = new Chart(ctx, { type, data, options });
            };

            const showToast = (message) => {
                const toast = $('#toast'); toast.textContent = message; toast.classList.remove('opacity-0', '-translate-y-10');
                setTimeout(() => toast.classList.add('opacity-0', '-translate-y-10'), 2000);
            };

            const addLP = (amount, reason, show = true) => {
                state.profile.lp += amount;
                if(show) showToast(`${reason}で ${amount} LP 獲得！`);
                updateLpDisplay();
            };
            const checkTitles = () => initialData.titles.forEach(t => !state.profile.earnedTitles.includes(t.id) && t.condition(state) && (state.profile.earnedTitles.push(t.id), showToast(`称号「${t.name}」獲得！`)));
            
            const formatTime = (s) => {
                const totalSeconds = Math.floor(s);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                if (hours > 0) return `${hours}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
                return `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
            };

            // 【追加】タイマーに時間を加算する関数
            const addTimerTime = (seconds) => {
                if (focusTimer.isRunning) return; // 実行中は時間を変更できないようにする
                focusTimer.timeLeft += seconds;
                $('#focus-timer-display').textContent = formatTime(focusTimer.timeLeft);
            };
            
            // 【追加】タイマー表示をリセットする関数
            const resetTimerDisplay = () => {
                if (focusTimer.isRunning) return;
                focusTimer.timeLeft = 0;
                $('#focus-timer-display').textContent = formatTime(0);
            };
            
            const formatStopwatchTime = (s) => {
                const totalSeconds = s;
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = Math.floor(totalSeconds % 60);
                // const ms = ... の行を削除
                return `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`; // 返り値からmsを削除
            };

            const hexToRgb = (hex) => {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : null;
            };

            const logStudyTime = (type, seconds) => {
                const today = new Date().toISOString().split('T')[0];
                if (!state.studyLog[today]) state.studyLog[today] = { focus: 0, quiz: 0 };
                state.studyLog[today][type] += seconds;
            };

            const renderHomeTasks = () => {
                if (!homeTaskListEl) return; // init前は実行しない
    
                if (!state.tasks || state.tasks.length === 0) {
                    homeTaskListEl.innerHTML = `<p class="text-center text-sm text-gray-500">今日の予定はありません。</p>`;
                } else {
                    homeTaskListEl.innerHTML = ''; // 一旦クリア
                    state.tasks.forEach((task, index) => {
                        const taskEl = document.createElement('div');
                        taskEl.className = 'flex items-center space-x-2 group task-item';
                        taskEl.dataset.id = task.id;
                        taskEl.innerHTML = `
                            <span class="font-bold w-6 text-center text-gray-600 dark:text-gray-400">${index + 1}</span>
                            <input type="text" value="${task.text}" class="task-text-input flex-grow bg-transparent p-1 focus:outline-none rounded">
                            <button class="task-handle cursor-move text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-opacity">
                                <i data-lucide="grip-vertical" class="w-5 h-5"></i>
                            </button>
                            <button class="delete-task-btn text-gray-400 hover:text-red-500 transition-opacity">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        `;
                        homeTaskListEl.appendChild(taskEl);
                        
                        // テキスト変更イベント
                        taskEl.querySelector('.task-text-input').addEventListener('change', (e) => {
                            const taskToUpdate = state.tasks.find(t => t.id == taskEl.dataset.id);
                            if (taskToUpdate) {
                                taskToUpdate.text = e.target.value;
                                saveState();
                            }
                        });
                    });
                }
                newTaskNumberEl.textContent = state.tasks.length + 1;
                lucide.createIcons();
            };

            document.body.addEventListener('click', e => {
                const quizCard = e.target.closest('.quiz-card');
                if (quizCard && !e.target.closest('.pin-btn')) {
                    const quiz = initialData.quizzes.find(q => q.id === quizCard.dataset.id);
                    $('#quiz-modal-title').textContent = quiz.title;
                    
                    // ★★★ ローダーを再表示する処理を追加 ★★★
                    $('#loader').parentElement.style.display = 'flex'; 
                
                    $('#quiz-iframe').classList.add('invisible');
                    $('#quiz-modal').dataset.currentQuiz = quiz.id;
                    $('#quiz-modal').style.display = 'flex';
                    quizTimer.startTime = Date.now();
                    setTimeout(() => {
                        $('#quiz-iframe').src = quiz.url;
                        $('#quiz-iframe').onload = () => {
                            $('#loader').parentElement.style.display = 'none'; 
                            $('#quiz-iframe').classList.remove('invisible');
                        };
                    }, 100);
                }
                const pinBtn = e.target.closest('.pin-btn');
                if(pinBtn) {
                    const quizId = pinBtn.dataset.id;
                    state.pinnedQuizzes.includes(quizId) ? state.pinnedQuizzes = state.pinnedQuizzes.filter(id => id !== quizId) : state.pinnedQuizzes.push(quizId);
                    saveState(); renderEngine.pages['study-page'](); lucide.createIcons();
                }
                
                const filterBtn = e.target.closest('.filter-btn');
                if(filterBtn) {
                     $$('#filter-container .filter-btn').forEach(b => {
                         b.classList.remove('active', 'primary-bg', 'text-white');
                         b.classList.add('bg-gray-200', 'dark:bg-gray-600');
                     });
                     filterBtn.classList.add('active', 'primary-bg', 'text-white');
                     filterBtn.classList.remove('bg-gray-200', 'dark:bg-gray-600');
                     renderEngine.pages['study-page']();
                     lucide.createIcons();
                }

                const closeModalBtn = e.target.closest('.close-modal-btn');
                if (closeModalBtn) {
                    const modal = $(`#${closeModalBtn.dataset.modal}`);
                    modal.style.display = 'none';
                    if (closeModalBtn.dataset.modal === 'quiz-modal') {
                        $('#assessment-modal').dataset.quizId = modal.dataset.currentQuiz;
                        $('#assessment-modal').style.display = 'flex';
                        if(quizTimer.startTime) {
                            const elapsed = Math.round((Date.now() - quizTimer.startTime) / 1000);
                            logStudyTime('quiz', elapsed);
                            quizTimer.startTime = null;
                            saveState();
                        }
                    }
                }
                
                const assessmentBtn = e.target.closest('.assessment-btn');
                if(assessmentBtn) {
                    const level = parseInt(assessmentBtn.dataset.level);
                    const quizId = $('#assessment-modal').dataset.quizId;
                    state.progress[quizId] = { level, date: new Date().toISOString() };
                    addLP(level * 5, 'クイズ評価');
                    checkTitles(); saveState();
                    renderEngine.renderAll();
                    $('#assessment-modal').style.display = 'none';
                }

                const themeBtn = e.target.closest('.theme-btn');
                if(themeBtn){
                    const themeId = themeBtn.dataset.theme;
                    if(state.profile.unlockedThemes.includes(themeId)) {
                        state.profile.activeTheme = themeId;
                        saveState();
                        renderEngine.renderAll();
                    } else {
                        const theme = initialData.themes[themeId];
                        const confirmBtn = $('#theme-purchase-confirm');
                        
                        $('#theme-purchase-title').textContent = `「${theme.name}」を交換しますか？`;
                        $('#theme-purchase-cost').textContent = `必要なポイント: ${theme.cost} LP`;
                        
                        // プレビュー表示
                        $('#theme-preview').style.backgroundColor = theme.color;
                
                        // ポイントが足りるかチェック
                        if (state.profile.lp >= theme.cost) {
                            confirmBtn.disabled = false;
                        } else {
                            confirmBtn.disabled = true;
                        }
                
                        confirmBtn.dataset.itemId = themeId;
                        confirmBtn.dataset.itemType = 'theme';
                        $('#theme-purchase-modal').style.display = 'flex';
                    }
                }

                const backgroundBtn = e.target.closest('.background-btn');
                if(backgroundBtn){
                    const bgId = backgroundBtn.dataset.bg;
                    if(state.profile.unlockedBackgrounds.includes(bgId)) {
                        state.profile.activeBackground = bgId;
                        saveState();
                        updateAppearance();
                        renderEngine.pages['settings-page']();
                        lucide.createIcons();
                    } else {
                        const bg = initialData.backgrounds[bgId];
                        const confirmBtn = $('#background-purchase-confirm');
                
                        $('#background-purchase-title').textContent = `「${bg.name}」を交換しますか？`;
                        $('#background-purchase-cost').textContent = `必要なポイント: ${bg.cost} LP`;
                
                        // プレビュー表示
                        const previewEl = $('#background-preview');
                        if (bg.url) {
                            previewEl.style.backgroundImage = `url(${bg.url})`;
                            previewEl.classList.remove('hidden');
                        } else {
                            previewEl.classList.add('hidden'); // デフォルトなど画像がない場合は非表示
                        }
                        
                        // ポイントが足りるかチェック
                        if (state.profile.lp >= bg.cost) {
                            confirmBtn.disabled = false;
                        } else {
                            confirmBtn.disabled = true;
                        }
                
                        confirmBtn.dataset.itemId = bgId;
                        confirmBtn.dataset.itemType = 'background';
                        $('#background-purchase-modal').style.display = 'flex';
                    }
                }

                const editCountdownBtn = e.target.closest('.edit-countdown-btn');
                if(editCountdownBtn){
                    const id = editCountdownBtn.dataset.id;
                    openCountdownModal(id);
                }

                // ▼▼▼ 集中モードボタン（タイマー/SW）のリスナー修正 ▼▼▼
                const focusModeBtn = e.target.closest('.focus-mode-btn');
                if(focusModeBtn) {
                    const mode = focusModeBtn.dataset.mode;
                    state.focus.mode = mode; // 'timer' か 'stopwatch' が入る
                    updateFocusModeUI(); // UIを更新
                }
                // ▲▲▲ 修正ここまで ▲▲▲

                // ▼▼▼ クエスト表示ボタンのリスナーを「新規追加」 ▼▼▼
                const showQuestBtn = e.target.closest('#show-quest-btn');
                if (showQuestBtn) {
                    $('#focus-main-view').style.display = 'none';
                    $('#quest-view').style.display = 'flex';
                    // クエストプランをレンダリング
                    renderQuestPlan();
                    lucide.createIcons();
                }

                // ▼▼▼ クエスト戻るボタンのリスナーを「新規追加」 ▼▼▼
                const questBackBtn = e.target.closest('#quest-back-btn');
                if (questBackBtn) {
                    $('#focus-main-view').style.display = 'flex';
                    $('#quest-view').style.display = 'none';
                    // 念のためタイマー/SWの表示を更新
                    updateFocusModeUI();
                }

                // 時間加算ボタンの処理
                const timeAddBtn = e.target.closest('.time-add-btn');
                if(timeAddBtn) {
                    const time = parseInt(timeAddBtn.dataset.time);
                    addTimerTime(time);
                }
                
                // リセットボタンの処理
                const timerResetBtn = e.target.closest('#timer-reset-btn');
                if(timerResetBtn) {
                    resetTimerDisplay();
                }
            });
            
            /* 変更後 (新しいイベントリスナーとして追加) */
            $('#background-scope-toggle').addEventListener('change', (e) => {
                state.settings.backgroundScopeGlobal = e.target.checked;
                saveState();
                updateAppearance();
                // 集中タブが表示されている場合に備えて再描画
                if ($('#focus-page').classList.contains('active')) {
                    renderEngine.pages['focus-page']();
                }
            });
            
            $('#lp-button').addEventListener('click', () => {
                // 1. LPポイントの表示を更新
                $('#modal-lp-display').textContent = state.profile.lp;
                
                // 2. テーマと壁紙のリストを描画（関数呼び出し）
                renderPointModalContent(); 
                
                // 3. 称号リストを描画
                const titlesList = $('#modal-titles-list');
                const earnedTitles = state.profile.earnedTitles.map(id => initialData.titles.find(t => t.id === id));
                titlesList.innerHTML = earnedTitles.length ? earnedTitles.map(t => `<span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-0.5 rounded-full dark:bg-yellow-900 dark:text-yellow-300">${t.name}</span>`).join('') : '<p class="text-sm text-gray-500">まだ称号はありません</p>';
            
                // 4. モーダルを表示
                $('#point-details-modal').style.display = 'flex';
                lucide.createIcons();
            });

            function handlePurchase(e) {
                const { itemId, itemType } = e.target.dataset;
                const itemData = initialData[itemType + 's'][itemId];
            
                if (state.profile.lp >= itemData.cost) {
                    addLP(-itemData.cost, `アイテム「${itemData.name}」交換`);
                    state.profile[`unlocked${itemType.charAt(0).toUpperCase() + itemType.slice(1)}s`].push(itemId);
                    showToast(`「${itemData.name}」を解放しました！`);
                    saveState();
                    renderPointModalContent();
                    if ($('#settings-page').classList.contains('active')) {
                        renderEngine.pages['settings-page']();
                    }
                } else { // ← if文の中に正しく入れる
                    showToast('LPが足りません！');
                }
                $(`#${itemType}-purchase-modal`).style.display = 'none';
            }
            
            // --- Focus Page Logic ---
            const updateMiniTimer = () => {
                if (miniTimerTemporarilyHidden) {
                    $('#mini-timer-container').classList.remove('visible');
                    return;
                }
                const container = $('#mini-timer-container');
                const bar = $('#mini-timer-bar');
                if ((focusTimer.isRunning || stopwatch.isRunning) && !$('#focus-page').classList.contains('active')) {
                    container.classList.add('visible');
                    if(focusTimer.isRunning){
                        const progress = (focusTimer.defaultTime - focusTimer.timeLeft) / focusTimer.defaultTime * 100;
                        $('#mini-timer-text').textContent = formatTime(focusTimer.timeLeft);
                        $('#mini-timer-progress-bar').style.width = `${progress}%`;
                    } else { // stopwatch
                         $('#mini-timer-text').textContent = formatStopwatchTime(stopwatch.elapsedTime);
                         $('#mini-timer-progress-bar').style.width = `100%`;
                    }
                } else {
                    container.classList.remove('visible');
                }
            };
            
            const timerTick = () => {
                focusTimer.timeLeft--;
                $('#focus-timer-display').textContent = formatTime(focusTimer.timeLeft);
                updateMiniTimer();
                if (focusTimer.timeLeft <= 0) {
                    clearInterval(focusTimer.interval);
                    // showToast と new Notification は Service Worker が担当するためコメントアウトまたは削除
                    // showToast('集中モード完了！お疲れ様でした！');
                    // if (Notification.permission === 'granted') { ... }
            
                    const elapsed = focusTimer.defaultTime;
                    logStudyTime('focus', elapsed);
                    addLP(Math.floor(elapsed/60), 'タイマー完了');
                    state.focus.totalTime += elapsed;
                    checkTitles();
                    saveState();
                    resetTimerUI();
            
                    // 【追加】Service Workerにタイマー停止を通知（完了時）
                    if (navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({ command: 'stopTimer' });
                    }
                }
            };
            
            const stopwatchTick = () => {
                stopwatch.elapsedTime = (Date.now() - stopwatch.startTime) / 1000;
                $('#stopwatch-display').textContent = formatStopwatchTime(stopwatch.elapsedTime);
                updateMiniTimer();
            };

            const pauseFocusTimer = () => {
                if (!focusTimer.isRunning || focusTimer.isPaused) return;
                focusTimer.isPaused = true;
                clearInterval(focusTimer.interval);
                $('#focus-pause-btn').innerHTML = `<i data-lucide="play" class="w-6 h-6 mr-2"></i>再開`;
                lucide.createIcons();
            };

            const resumeFocusTimer = () => {
                if (!focusTimer.isRunning || !focusTimer.isPaused) return;
                focusTimer.isPaused = false;
                focusTimer.interval = setInterval(timerTick, 1000);
                $('#focus-pause-btn').innerHTML = `<i data-lucide="pause" class="w-6 h-6 mr-2"></i>一時停止`;
                lucide.createIcons();
            };

            const pauseStopwatch = () => {
                if (!stopwatch.isRunning || stopwatch.isPaused) return;
                stopwatch.isPaused = true;
                clearInterval(stopwatch.interval);
                $('#stopwatch-pause-btn').innerHTML = `<i data-lucide="play" class="w-6 h-6 mr-2"></i>再開`;
                lucide.createIcons();
            };

            const resumeStopwatch = () => {
                if (!stopwatch.isRunning || !stopwatch.isPaused) return;
                stopwatch.isPaused = false;
                stopwatch.startTime = Date.now() - stopwatch.elapsedTime * 1000;
                stopwatch.interval = setInterval(stopwatchTick, 100);
                $('#stopwatch-pause-btn').innerHTML = `<i data-lucide="pause" class="w-6 h-6 mr-2"></i>一時停止`;
                lucide.createIcons();
            };

            const updateFocusModeUI = () => {
                const mode = state.focus.mode;
                
                // メインビュー内の表示切替
                $('#timer-view').style.display = (mode === 'timer') ? 'flex' : 'none';
                $('#stopwatch-view').style.display = (mode === 'stopwatch') ? 'flex' : 'none';
    
                // ボタンのハイライト処理
                const timerBtn = $('.focus-mode-btn[data-mode="timer"]');
                const stopwatchBtn = $('.focus-mode-btn[data-mode="stopwatch"]');
                
                if (mode === 'timer') {
                    timerBtn.classList.add('primary-bg', 'text-white');
                    stopwatchBtn.classList.remove('primary-bg', 'text-white');
                } else if (mode === 'stopwatch') {
                    timerBtn.classList.remove('primary-bg', 'text-white');
                    stopwatchBtn.classList.add('primary-bg', 'text-white');
                }
            };

            const resetTimerUI = () => {
                clearInterval(focusTimer.interval);
                focusTimer.isRunning = false; focusTimer.isPaused = false;
                focusTimer.timeLeft = focusTimer.defaultTime; // defaultTimeからリセット
                $('#focus-timer-display').textContent = formatTime(focusTimer.defaultTime);
                $('#focus-start-btn').classList.remove('hidden');
                $('#focus-controls').classList.add('hidden');
                $('#timer-settings-container').classList.remove('hidden');
                updateMiniTimer();
            };

            const resetStopwatchUI = () => {
                clearInterval(stopwatch.interval);
                stopwatch.isRunning = false; stopwatch.isPaused = false;
                stopwatch.elapsedTime = 0;
                $('#stopwatch-display').textContent = formatStopwatchTime(0);
                $('#stopwatch-start-btn').classList.remove('hidden');
                $('#stopwatch-controls').classList.add('hidden');
                updateMiniTimer();
            };

            const endFocusTimer = () => {
                if (!focusTimer.isRunning) return;
                const elapsed = focusTimer.defaultTime - focusTimer.timeLeft;
                if (elapsed > 0) { logStudyTime('focus', elapsed); addLP(Math.floor(elapsed / 60), '集中モード'); state.focus.totalTime += elapsed; checkTitles(); saveState(); }
                resetTimerUI();
            
                // 【追加】Service Workerにタイマー停止を通知
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({ command: 'stopTimer' });
                }
                // ▼▼▼【追加】ここから▼▼▼
                state.focus.isRunning = false;
                state.focus.startTime = null;
                saveState();
                // ▲▲▲【追加】ここまで▲▲▲
            };

            const endStopwatch = () => {
                if (!stopwatch.isRunning) return;
                const elapsed = Math.round(stopwatch.elapsedTime);
                if (elapsed > 0) { logStudyTime('focus', elapsed); addLP(Math.floor(elapsed / 60), 'ストップウォッチ'); state.focus.totalTime += elapsed; checkTitles(); saveState(); }
                resetStopwatchUI();
                // ▼▼▼【追加】ここから▼▼▼
                state.focus.isRunning = false;
                state.focus.startTime = null;
                saveState();
                // ▲▲▲【追加】ここまで▲▲▲
            };
            
            const setTimer = (seconds) => {
                focusTimer.defaultTime = seconds; // defaultTimeも更新
                focusTimer.timeLeft = seconds;
                $('#focus-timer-display').textContent = formatTime(seconds);
            };

           $('#focus-start-btn').addEventListener('click', () => {
                if (focusTimer.timeLeft <= 0) {
                    showToast('時間を設定してください');
                    return;
                }
                focusTimer.defaultTime = focusTimer.timeLeft;
                focusTimer.isRunning = true;
                focusTimer.isPaused = false;
                state.focus.isRunning = true;
                state.focus.startTime = Date.now(); // 現在時刻のタイムスタンプを保存
                state.focus.duration = focusTimer.timeLeft;
                saveState();
                focusTimer.interval = setInterval(timerTick, 1000);
                $('#focus-start-btn').classList.add('hidden');
                $('#focus-controls').classList.remove('hidden');
                $('#timer-settings-container').classList.add('hidden');
                updateMiniTimer();
            
                // 【追加】Service Workerにタイマー開始を通知
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        command: 'startTimer',
                        timeLeft: focusTimer.timeLeft
                    });
                }
            });
            /* ▼▼▼ 追加: クエスト機能のイベントリスナー ▼▼▼ */

            // クエスト設定ビューのボタン
            addSectionBtn.addEventListener('click', () => {
                quest.plan.push({
                    id: Date.now(),
                    type: 'section',
                    text: '新しいセクション',
                    duration: 25 * 60
                });
                renderQuestPlan();
            });

            addBreakBtn.addEventListener('click', () => {
                quest.plan.push({
                    id: Date.now(),
                    type: 'break',
                    duration: 5 * 60
                });
                renderQuestPlan();
            });

            addBreaksBtn.addEventListener('click', () => {
                const interval = parseInt($('#break-interval-input').value) || 2;
                const duration = parseInt($('#break-duration-input').value) || 5;
                const newPlan = [];
                let sectionCount = 0;
                
                // 休憩を除いたセクションのみのリストを元にする
                const sections = quest.plan.filter(item => item.type === 'section');

                sections.forEach((item, index) => {
                    newPlan.push(item);
                    sectionCount++;
                    // 最後のセクション以外で、intervalの倍数番目なら休憩を追加
                    if (sectionCount % interval === 0 && index !== sections.length - 1) {
                        newPlan.push({
                            id: Date.now() + Math.random(),
                            type: 'break',
                            duration: duration * 60
                        });
                    }
                });
                
                quest.plan = newPlan;
                renderQuestPlan();
            });

            startQuestBtn.addEventListener('click', startQuest);

            // クエスト実行画面のボタン
            endQuestBtn.addEventListener('click', () => {
                confirmationModal.style.display = 'flex';
            });

            modalConfirmBtn.addEventListener('click', () => endQuest(false));
            modalCancelBtn.addEventListener('click', () => {
                confirmationModal.style.display = 'none';
            });

            // 休憩中のコンテンツ
            breakContentSelector.addEventListener('click', (e) => {
                const btn = e.target.closest('.break-content-btn');
                if (!btn) return;
                const type = btn.dataset.type;
                if (type === 'sns') {
                    breakContentSelector.style.display = 'none';
                    breakSnsSelector.style.display = 'grid';
                } else if (type === 'game') {
                    openIframe('https://www.google.com/search?q=pacman+doodle'); // 例
                }
            });

            breakSnsSelector.addEventListener('click', (e) => {
                const btn = e.target.closest('.break-content-btn');
                if (btn && btn.dataset.url) {
                    openIframe(btn.dataset.url);
                }
            });

            closeIframeBtn.addEventListener('click', closeIframe);

            /* ▲▲▲ 追加: クエスト機能のイベントリスナー ▲▲▲ */
            
            $('#focus-pause-btn').addEventListener('click', () => { if (focusTimer.isPaused) resumeFocusTimer(); else pauseFocusTimer(); });
            $('#focus-end-btn').addEventListener('click', endFocusTimer);

            $('#stopwatch-start-btn').addEventListener('click', () => {
                stopwatch.isRunning = true; stopwatch.isPaused = false;
                // 修正：保存された時間ではなく、常に現在の時刻から開始
                stopwatch.startTime = Date.now() - stopwatch.elapsedTime * 1000;
            
                // ▼▼▼【追加】ここから▼▼▼
                state.focus.isRunning = true;
                // ストップウォッチの場合、開始時刻のみ保存
                state.focus.startTime = stopwatch.startTime; 
                saveState();
                stopwatch.interval = setInterval(stopwatchTick, 100);
                $('#stopwatch-start-btn').classList.add('hidden');
                $('#stopwatch-controls').classList.remove('hidden');
                updateMiniTimer();
            });
            $('#stopwatch-pause-btn').addEventListener('click', () => { if (stopwatch.isPaused) resumeStopwatch(); else pauseStopwatch(); });
            $('#stopwatch-end-btn').addEventListener('click', endStopwatch);
            
            $('#notification-permission-btn').addEventListener('click', async () => {
                if (!('Notification' in window)) { showToast('お使いのブラウザは通知に対応していません。'); return; }
                const permission = await Notification.requestPermission();
                if (permission === 'granted') { showToast('通知が許可されました！'); new Notification('クイズHPへようこそ！', { body: '通知設定がオンになりました。' }); } 
                else { showToast('通知が拒否されました。設定から変更できます。'); }
            });

            $$('.tab-btn').forEach(btn => btn.addEventListener('click', e => {
                const pageId = e.currentTarget.dataset.page;
                
                $$('.page').forEach(p => p.classList.remove('active'));
                $(`#${pageId}`).classList.add('active');
                
                $$('.tab-btn').forEach(b => b.classList.replace('primary-text', 'text-gray-500'));
                e.currentTarget.classList.replace('text-gray-500', 'primary-text');
                $('#header-title').textContent = e.currentTarget.dataset.title;
                if(renderEngine.pages[pageId]) { renderEngine.pages[pageId](); }
                if (pageId === 'focus-page') {
                    miniTimerTemporarilyHidden = false;
                }
                updateMiniTimer();
                lucide.createIcons();
            }));

            $('#mini-timer-bar').addEventListener('click', (e) => {
                if (e.target.closest('#close-mini-timer-btn')) return;
                document.querySelector('.tab-btn[data-page="focus-page"]').click();
            });

            $('#close-mini-timer-btn').addEventListener('click', () => {
                miniTimerTemporarilyHidden = true; // フラグを立てる
                $('#mini-timer-container').classList.remove('visible'); // 非表示にする
            });

            // --- Countdown Logic ---
            function openCountdownModal(id = null) {
                const modal = $('#countdown-modal');
                modal.dataset.editingId = id || '';
                const title = $('#countdown-modal-title');
                const deleteBtn = $('#countdown-delete-btn');
                const nameInput = $('#countdown-name');
                const dateInput = $('#countdown-date');
                const notifToggle = $('#countdown-notification-toggle');
                const notifTime = $('#countdown-notification-time');
                const notifDaysContainer = $('#countdown-notification-days');
                
                const daysOptions = [1, 2, 3, 7, 14, 30];
                notifDaysContainer.innerHTML = daysOptions.map(d => 
                    `<button class="day-btn border rounded-full px-3 py-1 text-sm" data-day="${d}">${d}日前</button>`
                ).join('');

                if (id) {
                    title.textContent = 'カウントダウンの編集';
                    deleteBtn.classList.remove('hidden');
                    const countdown = state.countdowns.find(c => c.id === id);
                    nameInput.value = countdown.name;
                    dateInput.value = countdown.date;
                    notifToggle.checked = countdown.notifications.enabled;
                    notifTime.value = countdown.notifications.time;
                    $$('.day-btn').forEach(btn => {
                        if (countdown.notifications.daysBefore.includes(parseInt(btn.dataset.day))) {
                            btn.classList.add('selected');
                        }
                    });
               } else {
                    title.textContent = 'カウントダウンの追加';
                    deleteBtn.classList.add('hidden');
                    nameInput.value = '';
                    
                    // 14日後の日付を計算して設定
                    const defaultDate = new Date();
                    defaultDate.setDate(defaultDate.getDate() + 14);
                    dateInput.value = defaultDate.toISOString().split('T')[0];
                
                    notifToggle.checked = true;
                    notifTime.value = '07:00';
                    $$('.day-btn').forEach(btn => btn.classList.remove('selected'));
                    $(`.day-btn[data-day='1']`).classList.add('selected');
                }
                
                $('#countdown-notification-details').style.display = notifToggle.checked ? 'block' : 'none';
                modal.style.display = 'flex';
                lucide.createIcons();

                $$('.day-btn').forEach(btn => {
                    btn.onclick = () => btn.classList.toggle('selected');
                });
            }

            function saveCountdown() {
                const id = $('#countdown-modal').dataset.editingId;
                const name = $('#countdown-name').value.trim();
                const date = $('#countdown-date').value;

                if (!name || !date) {
                    showToast('イベント名と日付を入力してください');
                    return;
                }

                const enabled = $('#countdown-notification-toggle').checked;
                const time = $('#countdown-notification-time').value;
                const daysBefore = [...$$('.day-btn.selected')].map(btn => parseInt(btn.dataset.day));

                const countdownData = {
                    name,
                    date,
                    notifications: { enabled, time, daysBefore }
                };

                if (id) {
                    const index = state.countdowns.findIndex(c => c.id === id);
                    state.countdowns[index] = { ...state.countdowns[index], ...countdownData };
                } else {
                    countdownData.id = `cd_${Date.now()}`;
                    state.countdowns.push(countdownData);
                }

                state.countdowns.sort((a, b) => new Date(a.date) - new Date(b.date));
                saveState();
                renderEngine.pages['home-page']();
                lucide.createIcons();
                $('#countdown-modal').style.display = 'none';
            }
            
            function deleteCountdown() {
                // 確認ダイアログを追加
                if (!confirm('本当にこのカウントダウンを削除してもよろしいですか？')) {
                    return; // キャンセルされたら、ここで処理を終了
                }
            
                const id = $('#countdown-modal').dataset.editingId;
                state.countdowns = state.countdowns.filter(c => c.id !== id);
                saveState();
                renderEngine.pages['home-page']();
                lucide.createIcons();
                $('#countdown-modal').style.display = 'none';
            }

            /* ▼▼▼ 追加: クエスト機能の関数群 ▼▼▼ */

        // クエストプランのリストをレンダリングする関数
        function renderQuestPlan() {
            questPlanListEl.innerHTML = '';
            if (quest.plan.length === 0) {
                questPlanListEl.innerHTML = `<p class="text-center text-sm text-gray-500">「今日の予定」を読み込むか、<br>「セクション追加」を押してください。</p>`;
            }
            let sectionCounter = 1; // 1. セクションカウンターを初期化
            quest.plan.forEach((item, index) => {
                const itemEl = document.createElement('div');
                itemEl.className = 'flex items-center space-x-2 group bg-gray-100 dark:bg-gray-800 p-2 rounded-lg';
                itemEl.dataset.id = item.id;
                            
                let content = '';
                if (item.type === 'section') {
                    content = `
                        <span class="font-bold w-6 text-center">${sectionCounter}</span>
                        <input type="text" value="${item.text}" data-original-id="${item.originalTaskId || ''}" class="quest-item-text flex-grow bg-transparent p-1 rounded border border-transparent focus:border-gray-400 dark:focus:border-gray-500 focus:outline-none min-w-0 truncate">
                        <input type="number" value="${item.duration / 60}" class="quest-item-duration w-16 p-1 border rounded text-center dark:bg-gray-600 dark:border-gray-500">
                        <span class="text-sm">分</span>
                    `;
                    sectionCounter++; // 3. セクションの場合のみインクリメント
                } else { // break
                    content = `
                        <span class="font-bold w-6 text-center">☕</span>
                        <span class="flex-grow p-1 text-gray-500 dark:text-gray-400 font-semibold">ブレイクタイム</span>
                        <input type="number" value="${item.duration / 60}" class="quest-item-duration w-16 p-1 border rounded text-center dark:bg-gray-600 dark:border-gray-500">
                        <span class="text-sm">分</span>
                    `;
                }

                itemEl.innerHTML = `
                    ${content}
                    <button class="quest-handle cursor-move text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-opacity">
                        <i data-lucide="grip-vertical" class="w-5 h-5"></i>
                    </button>
                    <button class="delete-item-btn text-gray-400 hover:text-red-500 transition-opacity">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                `;
                questPlanListEl.appendChild(itemEl);

                // イベントリスナー
                itemEl.querySelector('.quest-item-text')?.addEventListener('change', (e) => {
                    item.text = e.target.value;
                    item.originalTaskId = e.target.dataset.originalId || null;
                });
                itemEl.querySelector('.quest-item-duration').addEventListener('change', (e) => {
                    item.duration = parseInt(e.target.value) * 60;
                });
                itemEl.querySelector('.delete-item-btn').addEventListener('click', () => {
                    quest.plan = quest.plan.filter(p => p.id !== item.id);
                    renderQuestPlan();
                });
            });
            lucide.createIcons();
        };

        // クエスト用のタイマーを開始する関数
        function startQuestTimer(duration, onTick, onEnd) {
            quest.timeLeft = duration;
            onTick(quest.timeLeft);
            quest.timerInterval = setInterval(() => {
                quest.timeLeft--;
                onTick(quest.timeLeft);
                if (quest.timeLeft <= 0) {
                    clearInterval(quest.timerInterval);
                    onEnd();
                }
            }, 1000);
        };

        // 次のクエストステップを実行する関数
        function runNextQuestStep() {
            quest.currentIndex++;
            if (quest.currentIndex >= quest.plan.length) {
                endQuest(true); // クエスト完了
                return;
            }

            const currentStep = quest.plan[quest.currentIndex];
            
            // アプリ2のトースト関数とNotification APIを使用
            const showQuestNotification = (title, body) => {
                showToast(body);
                if (Notification.permission === "granted") {
                    new Notification(title, { body });
                }
            };

            if (currentStep.type === 'section') {
                showQuestNotification('セクション開始', `「${currentStep.text}」を始めましょう！`);
                questSectionView.style.display = 'block';
                questBreakView.style.display = 'none';
                questSectionTitle.textContent = currentStep.text;
                questProgressEl.textContent = `${quest.currentIndex + 1} / ${quest.plan.length}`;
                startQuestTimer(
                    currentStep.duration,
                    (timeLeft) => { questTimerEl.textContent = formatTime(timeLeft); }, // 既存のformatTimeを流用
                    () => {
                        const elapsed = currentStep.duration;
                        if (elapsed > 0) {
                            logStudyTime('focus', elapsed); // 学習ログに記録
                            addLP(Math.floor(elapsed / 60), 'クエストセクション'); // LPを付与
                            state.focus.totalTime += elapsed; // 総集中時間に追加
                            if (currentStep.originalTaskId) {
                                const taskId = parseInt(currentStep.originalTaskId);
                                state.tasks = state.tasks.filter(t => t.id !== taskId);
                                console.log(`タスクID ${taskId} を完了として削除しました。`);
                            }
                            checkTitles(); // 称号をチェック
                            saveState(); // 状態を保存
                        }
                        showQuestNotification('セクション終了', 'お疲れ様でした！休憩に入ります。');
                        runNextQuestStep();
                    }
                );
            } else { // break
                showQuestNotification('休憩時間', '少し休みましょう！');
                questSectionView.style.display = 'none';
                questBreakView.style.display = 'block';
                breakContentSelector.style.display = 'grid'; // 常に初期表示
                breakSnsSelector.style.display = 'none';
                startQuestTimer(
                    currentStep.duration,
                    (timeLeft) => { breakTimerEl.textContent = formatTime(timeLeft); },
                    () => {
                        showQuestNotification('休憩終了', '次のセクションを始めましょう！');
                        closeIframe();
                        runNextQuestStep();
                    }
                );
            }
            lucide.createIcons();
        };

        // クエストを開始する関数
        function startQuest() {
            if (quest.plan.length === 0) {
                showToast('クエストの予定がありません。');
                return;
            }
            quest.active = true;
            quest.currentIndex = -1;
            questActiveScreen.style.display = 'flex';
            
            // アプリ2のヘッダーとタブバーを隠す
            $('header').style.display = 'none';
            $('nav').style.display = 'none';
            $('#mini-timer-container').classList.remove('visible'); // ミニタイマーも隠す

            document.body.style.overflow = 'hidden';
            runNextQuestStep();
        };

        // クエストを終了する関数
        function endQuest(completed = false) {
            clearInterval(quest.timerInterval);
            if (!completed && quest.currentIndex >= 0 && quest.currentIndex < quest.plan.length) {
                const currentStep = quest.plan[quest.currentIndex];
                // 現在のステップが 'section' (学習中) の場合のみ記録
                if (currentStep.type === 'section') {
                    const elapsed = currentStep.duration - quest.timeLeft; // 経過時間
                    if (elapsed > 0) {
                        logStudyTime('focus', elapsed);
                        addLP(Math.floor(elapsed / 60), 'クエスト（中断）');
                        state.focus.totalTime += elapsed;
                        checkTitles();
                        saveState();
                        showToast(`セクションの ${formatTime(elapsed)} を記録しました。`);
                    }
                }
            }
            quest.active = false;
            questActiveScreen.style.display = 'none';

            // アプリ2のヘッダーとタブバーを再表示
            $('header').style.display = 'flex';
            $('nav').style.display = 'flex';

            document.body.style.overflow = 'auto';
            confirmationModal.style.display = 'none';
            closeIframe();
            if (completed) {
                showToast('クエスト完了！お疲れ様でした！');
            }
        };

        // 休憩用iframeを開く/閉じる関数
        function openIframe(url) {
            breakIframe.src = url;
            iframeOverlay.style.display = 'flex';
            lucide.createIcons(); // ボタンのアイコンを描画
        };

        function closeIframe() {
            breakIframe.src = 'about:blank';
            iframeOverlay.style.display = 'none';
        };

        /* ▲▲▲ 追加: クエスト機能の関数群 ▲▲▲ */
        
            
            const restoreFocusState = () => {
            // 保存された実行中のタイマー/SWがなければ何もしない
            if (!state.focus.isRunning || !state.focus.startTime) {
                setTimer(1500); // デフォルトの25分をセット
                return;
            }
        
            const elapsed = Math.floor((Date.now() - state.focus.startTime) / 1000); // 経過時間（秒）
        
            // 復元するモードに合わせてUIを更新
            updateFocusModeUI();
        
            if (state.focus.mode === 'timer') {
                const timeLeft = state.focus.duration - elapsed;
        
                if (timeLeft <= 0) {
                    // 復元時にはタイマーが既に終了している場合
                    showToast('タイマーは終了しました');
                    logStudyTime('focus', state.focus.duration);
                    addLP(Math.floor(state.focus.duration / 60), 'タイマー完了');
                    resetTimerUI();
                    // 状態をクリア
                    state.focus.isRunning = false;
                    state.focus.startTime = null;
                    saveState();
                    setTimer(1500); // 次のためにリセット
                } else {
                    // タイマーを復元
                    focusTimer.timeLeft = timeLeft;
                    focusTimer.defaultTime = state.focus.duration;
                    focusTimer.isRunning = true;
        
                    $('#focus-timer-display').textContent = formatTime(timeLeft);
                    $('#focus-start-btn').classList.add('hidden');
                    $('#focus-controls').classList.remove('hidden');
                    $('#timer-settings-container').classList.add('hidden');
        
                    focusTimer.interval = setInterval(timerTick, 1000);
                    updateMiniTimer();
                }
            } else { // ストップウォッチの場合
                stopwatch.elapsedTime = elapsed;
                stopwatch.startTime = state.focus.startTime;
                stopwatch.isRunning = true;
        
                $('#stopwatch-display').textContent = formatStopwatchTime(elapsed);
                $('#stopwatch-start-btn').classList.add('hidden');
                $('#stopwatch-controls').classList.remove('hidden');
        
                stopwatch.interval = setInterval(stopwatchTick, 100);
                updateMiniTimer();
            }
        };

            const init = () => {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('sw.js')
                        .then(registration => console.log('Service Worker登録成功:', registration))
                        .catch(error => console.log('Service Worker登録失敗:', error));
                }
                
                loadState();

                // 1. 新しいDOM要素を変数に割り当て
                homeTaskListEl = $('#home-task-list');
                newTaskInput = $('#new-task-input');
                newTaskNumberEl = $('#new-task-number');
                
                // ページ描画の前にタイマーの状態を復元・設定する
                restoreFocusState();
                
                // 全てのページを描画
                renderEngine.renderAll();
                
                // 2. Sortable.js の初期化 (今日の予定)
                if (homeTaskListEl) {
                    Sortable.create(homeTaskListEl, {
                        handle: '.task-handle', // 三本線アイコンでドラッグ
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        onEnd: (evt) => {
                            // state.tasks 配列を並び替え
                            const item = state.tasks.splice(evt.oldIndex, 1)[0];
                            state.tasks.splice(evt.newIndex, 0, item);
                            saveState();
                            renderHomeTasks(); // 番号を振り直すために再描画
                        }
                    });

                    // 3. タスク削除のイベントリスナー (イベント委任)
                    homeTaskListEl.addEventListener('click', (e) => {
                        const deleteBtn = e.target.closest('.delete-task-btn');
                        if (deleteBtn) {
                            const taskItem = deleteBtn.closest('.task-item');
                            const taskId = parseInt(taskItem.dataset.id);
                            state.tasks = state.tasks.filter(t => t.id !== taskId);
                            saveState();
                            renderHomeTasks();
                        }
                    });
                }

                // 4. 新規タスク追加 (Enterキー)
                if (newTaskInput) {
                    newTaskInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && e.target.value.trim() !== '') {
                            state.tasks.push({ id: Date.now(), text: e.target.value.trim() });
                            e.target.value = '';
                            saveState();
                            renderHomeTasks();
                        }
                    });
                }

                 // Sortable.js の初期化 (クエストプラン)
                    if (questPlanListEl) { // questPlanListEl はグローバルスコープで定義済み
                        Sortable.create(questPlanListEl, {
                            handle: '.quest-handle', // クエストのハンドル
                            animation: 150,
                            ghostClass: 'sortable-ghost',
                            onEnd: (evt) => {
                                // quest.plan 配列を並び替え
                                // (quest.plan は state に保存されない一時的なもの)
                                const item = quest.plan.splice(evt.oldIndex, 1)[0];
                                quest.plan.splice(evt.newIndex, 0, item);
                                renderQuestPlan(); // 番号を振り直すために再描画
                            }
                        });
                    }
                
                // 5. 「今日の予定」読み込みボタン
                const loadTasksBtn = $('#load-tasks-btn');
                if (loadTasksBtn) {
                    loadTasksBtn.addEventListener('click', () => {
                        if (state.tasks.length === 0) {
                            showToast('「今日の予定」にタスクがありません。');
                            quest.plan = []; // プランをクリア
                        } else {
                            // state.tasks を quest.plan にマッピング
                            quest.plan = state.tasks.map(task => ({
                                id: Date.now() + Math.random(), // クエスト用の一時ID
                                type: 'section',
                                text: task.text,
                                duration: 25 * 60, // デフォルト25分
                                originalTaskId: task.id // ★元のタスクIDを保持
                            }));
                            showToast(`「今日の予定」から ${state.tasks.length} 件のタスクを読み込みました。`);
                        }
                        // クエストプランのUIを再描画
                        renderQuestPlan();
                    });
                }
                
                // 最後に外観を更新
                $('#background-scope-toggle').checked = state.settings.backgroundScopeGlobal;
                updateAppearance();
                // ▼▼▼ 変更（initの最後にlucideを1回実行） ▼▼▼
                lucide.createIcons();
            };
            const renderPointModalContent = () => {
            const themeContainer = $('#modal-theme-selector');
            themeContainer.innerHTML = Object.entries(initialData.themes).map(([id, theme]) => {
                const isUnlocked = state.profile.unlockedThemes.includes(id);
                if (isUnlocked) {
                    return `<div class="text-center">
                        <button class="theme-btn w-12 h-12 rounded-full border-4 ${state.profile.activeTheme === id ? 'border-blue-500' : 'border-transparent'} relative" style="background-color: ${theme.color}" data-theme="${id}">
                            <div class="absolute inset-0 flex items-center justify-center rounded-full"><i data-lucide="check" class="w-6 h-6 text-white"></i></div>
                        </button>
                        <p class="text-xs mt-1">${theme.name}</p>
                    </div>`;
                } else {
                    return `<div class="text-center">
                        <button class="theme-btn w-12 h-12 rounded-full border-4 border-transparent relative" style="background-color: ${theme.color}" data-theme="${id}">
                            <div class="absolute inset-0 bg-black/60 flex flex-col items-center justify-center rounded-full text-white">
                                <i data-lucide="lock" class="w-5 h-5"></i>
                                <span class="text-[10px] font-bold">${theme.cost}</span>
                            </div>
                        </button>
                        <p class="text-xs mt-1">${theme.name}</p>
                    </div>`;
                }
            }).join('');

            const backgroundContainer = $('#modal-background-selector');
            backgroundContainer.innerHTML = Object.entries(initialData.backgrounds).map(([id, bg]) => {
                const isUnlocked = state.profile.unlockedBackgrounds.includes(id);
                const style = bg.url ? `background-image: url(${bg.url})` : 'background-color: #6b7280;';
                if (isUnlocked) {
                    return `<div class="text-center">
                        <button class="background-btn w-full h-20 rounded-lg border-4 ${state.profile.activeBackground === id ? 'border-blue-500' : 'border-transparent'} relative bg-cover bg-center" style="${style}" data-bg="${id}">
                             <div class="absolute inset-0 flex items-center justify-center rounded-md"><i data-lucide="check" class="w-8 h-8 text-white"></i></div>
                        </button>
                         <p class="text-xs mt-1">${bg.name}</p>
                    </div>`;
                } else {
                     return `<div class="text-center">
                        <button class="background-btn w-full h-20 rounded-lg border-4 border-transparent relative bg-cover bg-center" style="${style}" data-bg="${id}">
                             <div class="absolute inset-0 bg-black/60 flex flex-col items-center justify-center rounded-md text-white">
                                <i data-lucide="lock" class="w-6 h-6"></i>
                                <span class="text-sm font-bold">${bg.cost}</span>
                            </div>
                        </button>
                         <p class="text-xs mt-1">${bg.name}</p>
                    </div>`;
                }
            }).join('');

            lucide.createIcons();
        };
            
        // --- 購入モーダル関連のボタン ---
        $('#theme-purchase-confirm').addEventListener('click', handlePurchase);
        $('#theme-purchase-cancel').addEventListener('click', () => {
            $('#theme-purchase-modal').style.display = 'none';
        });

        $('#background-purchase-confirm').addEventListener('click', handlePurchase);
        $('#background-purchase-cancel').addEventListener('click', () => {
            $('#background-purchase-modal').style.display = 'none';
        });

        // --- ポイント詳細モーダルを閉じるボタン ---
        $('#close-point-modal-btn').addEventListener('click', () => {
            $('#point-details-modal').style.display = 'none';
        });

        // --- カウントダウンモーダル関連のボタン ---
        $('#add-countdown-btn').addEventListener('click', () => openCountdownModal());
        $('#countdown-save-btn').addEventListener('click', saveCountdown);
        $('#countdown-cancel-btn').addEventListener('click', () => {
            $('#countdown-modal').style.display = 'none';
        });
        $('#countdown-delete-btn').addEventListener('click', deleteCountdown);
        $('#countdown-notification-toggle').addEventListener('change', (e) => {
            $('#countdown-notification-details').style.display = e.target.checked ? 'block' : 'none';
        });
            
            init();
        });
    </script>
</body>
</html>
