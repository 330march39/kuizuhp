<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚¯ã‚¤ã‚ºHP</title>

    <!-- PWAé–¢é€£ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ã‚¯ã‚¤ã‚ºHP">
    <meta name="theme-color" content="#4f46e5">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/4f46e5/ffffff?text=Q">

    <!-- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ãƒ•ã‚©ãƒ³ãƒˆ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class' // ã“ã“ã§ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã®åˆ¶å¾¡æ–¹æ³•ã‚’'class'ã«æŒ‡å®šã—ã¾ã™
      }
    </script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-color-hover: #4338ca;
        }
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; -webkit-tap-highlight-color: transparent; }
        .page { display: none; }
        .page.active { display: block; }
        #focus-page.page.active { display: flex; }
        #focus-page { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid var(--primary-color); width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .primary-bg { background-color: var(--primary-color); }
        .primary-bg-hover:hover { background-color: var(--primary-color-hover); }
        .primary-text { color: var(--primary-color); }
        .toggle-checkbox { appearance: none; width: 40px; height: 20px; background: #ccc; border-radius: 20px; position: relative; cursor: pointer; transition: background .3s; }
        .toggle-checkbox:before { content: ''; position: absolute; width: 16px; height: 16px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: transform .3s; }
        .toggle-checkbox:checked { background: var(--primary-color); }
        .toggle-checkbox:checked:before { transform: translateX(20px); }
        #theme-purchase-modal, #background-purchase-modal { z-index: 60; }

        /* ãƒŸãƒ‹ã‚¿ã‚¤ãƒãƒ¼ */
        #mini-timer-container {
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.4s;
            transform: translateY(150%);
            opacity: 0;
            pointer-events: none;
        }
        #mini-timer-container.visible {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
        #mini-timer-progress-bar {
            transition: width 0.5s linear;
        }
        /* é›†ä¸­ãƒ¢ãƒ¼ãƒ‰èƒŒæ™¯ */
        .focus-view-bg {
            background-size: cover;
            background-position: center;
            transition: background-image 0.5s ease-in-out;
        }
        
        #app-container {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        .break-icon-grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* ğŸ‘ˆ 3 ã‚’ 4 ã«å¤‰æ›´ */
            gap: 0.5rem; /* ğŸ‘ˆ éš™é–“ã‚’ 8px ã«ç‹­ã‚ã¾ã™ (ä»»æ„ã§ã™ãŒæ¨å¥¨) */
            width: 100%;
        }

        .break-content-btn {
            background-color: rgba(255, 255, 255, 0.1);
            color: #edfcff;
            padding: 0.75rem; /* ğŸ‘ˆ 16px ã‹ã‚‰ 12px ã«å¤‰æ›´ */
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center; /* ğŸ‘ˆ flex-start ã‹ã‚‰ center ã«å¤‰æ›´ (æœ€é‡è¦) */
            justify-content: flex-start; /* ğŸ‘ˆ center ã‹ã‚‰ flex-start ã«å¤‰æ›´ (ä¸Šã‹ã‚‰é…ç½®) */
            /* font-weight: bold; */ /* ğŸ‘ˆ ã“ã®è¡Œã¯å‰Šé™¤ï¼ˆspanå´ã§æŒ‡å®šï¼‰ */
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 100%;
            /* é«˜ã•ã‚’å‡ä¸€ã«ã™ã‚‹ãŸã‚ (ä»»æ„) */
            min-height: 100px;
        }
        .break-content-btn span {
            font-size: 0.75rem; /* 12px */
            font-weight: bold;
            line-height: 1.1;
            text-align: center;
            word-break: break-word; /* è‹±èªãªã©ãŒã¯ã¿å‡ºãŸå ´åˆã«å‚™ãˆã‚‹ */
        }
        .break-content-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        .sortable-ghost {
            opacity: 0.4;
            background-color: #e2e8f0; /* light gray */
        }
        .dark .sortable-ghost {
            background-color: #374151; /* dark gray */
        }
        .task-item .task-text-input {
            border-bottom: 1px solid transparent;
            transition: all 0.2s;
        }
        .task-item:hover .task-text-input {
            background-color: rgba(0,0,0,0.03);
        }
        .dark .task-item:hover .task-text-input {
            background-color: rgba(255,255,255,0.05);
        }
        /* ä¼‘æ†©è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¢ã‚¤ãƒ†ãƒ  */
        .break-settings-item {
            display: flex;
            align-items: center;
            padding: 0.75rem; /* p-3 */
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem; /* rounded-lg */
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #e5e7eb; /* text-gray-200 */
        }
        .break-settings-handle {
            cursor: move; /* "cursor-move" */
            margin-right: 0.75rem; /* mr-3 */
            color: #9ca3af; /* text-gray-400 */
        }
        .break-settings-item span {
            flex-grow: 1; /* "flex-grow" */
            text-align: left;
        }
        /* 1. ãƒšãƒ¼ã‚¸å…¨ä½“ã®ãƒ†ã‚­ã‚¹ãƒˆé¸æŠã‚’ç¦æ­¢ */
        body {
            -webkit-user-select: none; /* Safari/Chrome */
            -moz-user-select: none;    /* Firefox */
            -ms-user-select: none;     /* IE */
            user-select: none;         /* æ¨™æº– */
        }
        
        /* 2. input ã‚„ textarea ã¯é¸æŠã§ãã‚‹ã‚ˆã†ã«è¨±å¯ã™ã‚‹ï¼ˆã‚³ãƒ”ãƒšãªã©ã«å¿…è¦ï¼‰ */
        input, 
        textarea {
            -webkit-user-select: text; /* Safari/Chrome */
            -moz-user-select: text;    /* Firefox */
            -ms-user-select: text;     /* IE */
            user-select: text;         /* æ¨™æº– */
        }
        
        /* 3. ç”»åƒã‚„SVGã‚¢ã‚¤ã‚³ãƒ³ã®é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆä¿å­˜ãªã©ï¼‰ã‚’ç¦æ­¢ (ä¸»ã«iOS) */
        img, svg {
            -webkit-touch-callout: none;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 overflow-hidden h-screen antialiased">

    <div id="app-container" class="h-full w-full flex flex-col max-w-lg mx-auto shadow-2xl">
        
        <header class="bg-white dark:bg-gray-800/80 backdrop-blur-sm z-30 p-4 flex items-center justify-between border-b border-gray-200 dark:border-gray-700 sticky top-0">
            <h1 id="header-title" class="text-xl font-bold text-gray-900 dark:text-white">ãƒ›ãƒ¼ãƒ </h1>
            <button id="lp-button" class="flex items-center space-x-2 bg-yellow-400/20 text-yellow-600 dark:text-yellow-400 rounded-full px-3 py-1 hover:bg-yellow-400/30 transition-colors">
                <i data-lucide="star" class="w-4 h-4 fill-current"></i>
                <span id="lp-display" class="font-bold text-sm">0 LP</span>
            </button>
        </header>

        <main class="flex-grow overflow-y-auto pb-20">
            <div id="home-page" class="page active p-4 space-y-6">
                <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm text-center">
                    <p id="today-date" class="text-lg font-semibold text-gray-600 dark:text-gray-300"></p>
                </div>

                 <div>
                    <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 flex items-center mb-3">
                        <i data-lucide="check-square" class="w-5 h-5 mr-2 primary-text"></i> ä»Šæ—¥ã®äºˆå®š
                    </h2>
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm">
                        <div id="home-task-list" class="space-y-2">
                            <p class="text-center text-sm text-gray-500">ä»Šæ—¥ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                        </div>
                        <div class="flex items-center space-x-2 mt-4 pt-3 border-t border-gray-200 dark:border-gray-600">
                            <span id="new-task-number" class="font-bold w-6 text-center text-gray-500 dark:text-gray-400">1</span>
                            <input type="text" id="new-task-input" placeholder="æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ  (Enterã§ç¢ºå®š)" class="flex-grow bg-transparent p-1 border-b-2 border-gray-300 dark:border-gray-600 focus:border-indigo-500 focus:outline-none transition-colors">
                        </div>
                    </div>
                </div>
                
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 flex items-center"><i data-lucide="calendar-clock" class="w-5 h-5 mr-2 primary-text"></i> ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³</h2>
                        <button id="add-countdown-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                    <div id="countdown-list" class="space-y-3"></div>
                </div>
                
                 
            </div>

            <div id="study-page" class="page p-4">
                <div class="mb-6">
                    <h2 class="text-lg font-semibold mb-3 text-gray-700 dark:text-gray-300 flex items-center"><i data-lucide="pin" class="w-5 h-5 mr-2 primary-text"></i> ãƒ”ãƒ³ç•™ã‚</h2>
                    <div id="pinned-quizzes" class="grid grid-cols-1 gap-3"></div>
                </div>
                <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-lg font-semibold mb-3 text-gray-700 dark:text-gray-300 flex items-center"><i data-lucide="book-marked" class="w-5 h-5 mr-2 primary-text"></i> ã™ã¹ã¦ã®ã‚¯ã‚¤ã‚º</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="filter-container" class="flex space-x-2 mb-4 overflow-x-auto pb-2"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="all-quizzes" class="grid grid-cols-1 gap-3"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div> Â  Â  Â  Â  Â  Â  
            <div id="focus-page" class="page relative flex flex-col h-full">
                
                <div id="focus-main-view" class="flex flex-col h-full p-4">
                    <div class="flex-shrink-0 mb-4 space-y-4">
                        <button id="show-quest-btn" class="w-full p-3 rounded-lg font-bold text-lg shadow-md flex items-center justify-center space-x-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" data-mode="quest">
                            <i data-lucide="award" class="w-6 h-6"></i>
                            <span>ã‚¯ã‚¨ã‚¹ãƒˆ</span>
                        </button>
                        
                        <div class="flex bg-gray-200 dark:bg-gray-700 rounded-lg p-1">
                            <button class="focus-mode-btn flex-1 p-2 rounded-md text-sm font-semibold" data-mode="timer">ã‚¿ã‚¤ãƒãƒ¼</button>
                            <button class="focus-mode-btn flex-1 p-2 rounded-md text-sm font-semibold" data-mode="stopwatch">ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒ</button>
                        </div>
                    </div>
            
                    <div id="timer-view" class="focus-view-bg flex-grow flex flex-col items-center justify-center text-center relative text-white rounded-lg">
                        <div class="absolute inset-0 bg-black/50 rounded-lg"></div>
                        <div class="relative z-10 p-4">
                            <div id="timer-settings-container">
                                <div class="flex items-center justify-center space-x-2 mb-6">
                                    <button class="time-add-btn bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full" data-time="60">1åˆ†</button>
                                    <button class="time-add-btn bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full" data-time="300">5åˆ†</button>
                                    <button class="time-add-btn bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full" data-time="1800">30åˆ†</button>
                                    <button class="time-add-btn bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full" data-time="3600">60åˆ†</button>
                                    <button id="timer-reset-btn" class="bg-white/20 hover:bg-white/30 w-10 h-10 rounded-full flex items-center justify-center">
                                        <i data-lucide="rotate-cw" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="focus-timer-display" class="text-7xl font-bold tabular-nums mb-6">30:00</div>
                            <button id="focus-start-btn" class="primary-bg primary-bg-hover text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg flex items-center mx-auto"><i data-lucide="play" class="w-6 h-6 mr-2"></i>ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                            <div id="focus-controls" class="hidden flex flex-wrap items-center justify-center gap-4">
                                <button id="focus-pause-btn" class="bg-gray-500/70 hover:bg-gray-600/70 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg flex items-center"><i data-lucide="pause" class="w-6 h-6 mr-2"></i>ä¸€æ™‚åœæ­¢</button>
                                <button id="focus-end-btn" class="bg-red-500/70 hover:bg-red-600/70 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg flex items-center"><i data-lucide="stop-circle" class="w-6 h-6 mr-2"></i>çµ‚äº†</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="stopwatch-view" class="focus-view-bg hidden flex-grow flex-col items-center justify-center text-center relative text-white rounded-lg">
                        <div class="absolute inset-0 bg-black/50 rounded-lg"></div>
                        <div class="relative z-10 p-4">
                            <div id="stopwatch-display" class="text-7xl font-bold tabular-nums mb-6">00:00</div>
                            <button id="stopwatch-start-btn" class="primary-bg primary-bg-hover text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg flex items-center mx-auto"><i data-lucide="play" class="w-6 h-6 mr-2"></i>ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                            <div id="stopwatch-controls" class="hidden flex flex-wrap items-center justify-center gap-4">
                                <button id="stopwatch-pause-btn" class="bg-gray-500/70 hover:bg-gray-600/70 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg flex items-center"><i data-lucide="pause" class="w-6 h-6 mr-2"></i>ä¸€æ™‚åœæ­¢</button>
                                <button id="stopwatch-end-btn" class="bg-red-500/70 hover:bg-red-600/70 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg flex items-center"><i data-lucide="flag" class="w-6 h-6 mr-2"></i>è¨˜éŒ²ã—ã¦çµ‚äº†</button>
                            </div>
                        </div>
                    </div>
                </div>
            
                <div id="quest-view" class="hidden absolute inset-0 z-10 flex-col p-4">
                    
                    <div class="flex-shrink-0 flex items-center justify-between mb-4">
                        <button id="quest-back-btn" class="p-2 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full">
                            <i data-lucide="chevron-left" class="w-6 h-6"></i>
                        </button>
                        <h2 class="text-xl font-bold text-gray-900 dark:text-white">ã‚¯ã‚¨ã‚¹ãƒˆè¨­å®š</h2>
                        <div class="w-10"></div> </div>
                    
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm mb-4">
                        <button id="load-tasks-btn" class="w-full mb-2 primary-bg primary-bg-hover text-white py-2 px-4 rounded-lg font-bold flex items-center justify-center space-x-2">
                            <i data-lucide="check-square" class="w-5 h-5"></i>
                            <span>ã€Œä»Šæ—¥ã®äºˆå®šã€ã‚’èª­ã¿è¾¼ã‚€</span>
                        </button>
                        <hr class="my-3 border-gray-200 dark:border-gray-600">
                        
                        <div class="flex items-center space-x-2 text-sm">
                            <input type="number" id="break-interval-input" value="2" class="w-16 p-1 border rounded dark:bg-gray-800 dark:border-gray-600">
                            <span>ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã”ã¨ã«</span>
                            <input type="number" id="break-duration-input" value="5" class="w-16 p-1 border rounded dark:bg-gray-800 dark:border-gray-600">
                            <span>åˆ†ä¼‘æ†©</span>
                        </div>
                        <button id="add-breaks-btn" class="mt-2 text-sm bg-gray-200 dark:bg-gray-600 px-3 py-1 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition">ä¼‘æ†©ã‚’è‡ªå‹•æŒ¿å…¥</button>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm flex-grow overflow-y-auto pb-20"> <div id="quest-plan-list" class="space-y-2">
                            </div>
                        
                        <div class="flex justify-between mt-4">
                            <button id="add-section-btn" class="text-sm bg-gray-200 dark:bg-gray-600 px-3 py-1 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition">ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ </button>
                            <button id="add-break-btn" class="text-sm bg-gray-200 dark:bg-gray-600 px-3 py-1 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition">ä¼‘æ†©è¿½åŠ </button>
                        </div>
                    </div>
                    
                    <div class="fixed bottom-16 left-0 right-0 max-w-lg mx-auto p-4">
                        <button id="start-quest-btn" class="w-full primary-bg primary-bg-hover text-white py-3 px-4 rounded-lg font-bold text-lg shadow-md hover:scale-105 transition-transform transform flex items-center justify-center space-x-2">
                            <i data-lucide="play" class="w-6 h-6"></i>
                            <span>ã‚¯ã‚¨ã‚¹ãƒˆã‚’é–‹å§‹ã™ã‚‹</span>
                        </button>
                    </div>
            
                </div>
            </div>
            <div id="my-chart-page" class="page p-4 space-y-6">
                <div>
                    <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 flex items-center mb-3"><i data-lucide="bar-chart-3" class="w-5 h-5 mr-2 primary-text"></i> é€±é–“å­¦ç¿’ãƒ¬ãƒãƒ¼ãƒˆ</h2>
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow"><canvas id="study-time-chart"></canvas></div>
                </div>
                <div>
                    <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 flex items-center mb-3"><i data-lucide="pie-chart" class="w-5 h-5 mr-2 primary-text"></i> æ•™ç§‘åˆ¥ ç†è§£åº¦ã‚«ãƒ«ãƒ†</h2>
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow"><canvas id="subject-radar-chart"></canvas></div>
                </div>
                
            </div>

            <div id="settings-page" class="page p-4 space-y-4">
                <div id="notification-settings-card" class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                    <h3 class="font-semibold mb-2">é€šçŸ¥è¨­å®š</h3>
                    <button id="notification-permission-btn" class="w-full primary-bg primary-bg-hover text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center mb-4"><i data-lucide="bell-ring" class="w-5 h-5 mr-2"></i>ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã‚’è¨±å¯</button>
                    </div>
                <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                     <h3 class="font-semibold mb-2">ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’é¸æŠ</h3>
                     <div id="theme-selector" class="grid grid-cols-4 gap-4"></div>
                </div>
                <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                    <h3 class="font-semibold mb-2">å£ç´™ã‚’é¸æŠ</h3>
                    <div id="background-selector" class="grid grid-cols-3 gap-4"></div>
                    <hr class="my-4 border-gray-200 dark:border-gray-600">
                    <div class="flex items-center justify-between">
                        <p class="font-semibold">å£ç´™ã‚’ã‚¢ãƒ—ãƒªå…¨ä½“ã«é©ç”¨</p>
                        <input type="checkbox" id="background-scope-toggle" class="toggle-checkbox">
                    </div>
                </div>
            </div>
        </main>

        <div id="mini-timer-container" class="fixed bottom-20 left-0 right-0 max-w-lg mx-auto px-4 z-20">
             <div id="mini-timer-bar" class="w-full bg-gray-800/90 backdrop-blur-sm rounded-lg shadow-lg flex items-center p-2 space-x-3 cursor-pointer">
                <div class="flex items-center space-x-3 flex-grow min-w-0">
                    <i data-lucide="timer" class="w-5 h-5 primary-text flex-shrink-0"></i>
                    <span id="mini-timer-text" class="text-sm font-bold tabular-nums text-white truncate"></span>
                </div>
                <div class="w-1/3 h-1.5 bg-gray-600 rounded-full overflow-hidden flex-shrink-0">
                    <div id="mini-timer-progress-bar" class="h-full primary-bg rounded-full"></div>
                </div>
                <button id="close-mini-timer-btn" class="p-1 text-gray-400 hover:text-white flex-shrink-0">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <nav class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto h-16 bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm border-t border-gray-200 dark:border-gray-700 flex justify-around items-center shadow-top z-20">
            <button class="tab-btn flex flex-col items-center justify-center w-full h-full primary-text" data-page="home-page" data-title="ãƒ›ãƒ¼ãƒ "><i data-lucide="home" class="w-6 h-6"></i><span class="text-xs mt-1">ãƒ›ãƒ¼ãƒ </span></button>
            <button class="tab-btn flex flex-col items-center justify-center w-full h-full text-gray-500" data-page="study-page" data-title="å­¦ç¿’"><i data-lucide="book-marked" class="w-6 h-6"></i><span class="text-xs mt-1">å­¦ç¿’</span></button>
            <button class="tab-btn flex flex-col items-center justify-center w-full h-full text-gray-500" data-page="focus-page" data-title="é›†ä¸­"><i data-lucide="timer" class="w-6 h-6"></i><span class="text-xs mt-1">é›†ä¸­</span></button>
            <button class="tab-btn flex flex-col items-center justify-center w-full h-full text-gray-500" data-page="my-chart-page" data-title="ãƒã‚¤ã‚«ãƒ«ãƒ†"><i data-lucide="clipboard-list" class="w-6 h-6"></i><span class="text-xs mt-1">ãƒã‚¤ã‚«ãƒ«ãƒ†</span></button>
            <button class="tab-btn flex flex-col items-center justify-center w-full h-full text-gray-500" data-page="settings-page" data-title="è¨­å®š"><i data-lucide="settings" class="w-6 h-6"></i><span class="text-xs mt-1">è¨­å®š</span></button>
        </nav>
    </div>

    <!-- ===== ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
    <div id="quiz-modal" class="fixed inset-0 bg-black/70 z-50 flex-col hidden"><div class="w-full h-full max-w-lg mx-auto bg-gray-100 dark:bg-gray-900 flex flex-col"><header class="p-3 flex items-center justify-between shadow-md bg-white dark:bg-gray-800"><h2 id="quiz-modal-title" class="truncate font-bold"></h2><button class="close-modal-btn p-1" data-modal="quiz-modal"><i data-lucide="x"></i></button></header><div class="flex-grow relative"><div class="absolute inset-0 flex items-center justify-center"><div id="loader"></div></div><iframe id="quiz-iframe" class="w-full h-full border-0 invisible" sandbox="allow-scripts allow-forms allow-popups"></iframe></div></div></div>
    <div id="assessment-modal" class="fixed inset-0 bg-black/70 z-50 items-center justify-center hidden p-4">
            <div class="bg-white dark:bg-gray-700 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
                <h2 class="text-xl font-bold mb-4">ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼</h2>
                <p class="mb-6">ã“ã®ã‚¯ã‚¤ã‚ºã®ç†è§£åº¦ã‚’è¨˜éŒ²ã—ã‚ˆã†</p>
                <div class="flex justify-around">
                    <button class="assessment-btn p-2 w-24 flex flex-col items-center" data-level="3"><i data-lucide="award" class="w-10 h-10 text-yellow-400 mb-1 mx-auto"></i><p>å®Œ ç’§</p></button>
                    <button class="assessment-btn p-2 w-24 flex flex-col items-center" data-level="2"><i data-lucide="thumbs-up" class="w-10 h-10 text-green-400 mb-1 mx-auto"></i><p>ã¾ã‚ã¾ã‚</p></button>
                    <button class="assessment-btn p-2 w-24 flex flex-col items-center" data-level="1"><i data-lucide="book-open-check" class="w-10 h-10 text-blue-400 mb-1 mx-auto"></i><p>è¦å¾©ç¿’</p></button>
                </div>
            </div>    </div><div id="theme-purchase-modal" class="fixed inset-0 bg-black/70 z-50 items-center justify-center hidden p-4">
    <div class="bg-white dark:bg-gray-700 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
        <h2 id="theme-purchase-title" class="text-xl font-bold mb-2"></h2>
        <div id="theme-preview" class="w-20 h-20 rounded-full mx-auto my-4 border-4 border-gray-200 dark:border-gray-600 shadow-inner"></div>
        <p id="theme-purchase-cost" class="mb-6"></p>
        <div class="flex justify-center space-x-4">
            <button id="theme-purchase-cancel" class="bg-gray-200 dark:bg-gray-600 px-6 py-2 rounded-lg">ã‚„ã‚ã‚‹</button>
            <button id="theme-purchase-confirm" class="primary-bg primary-bg-hover text-white px-6 py-2 rounded-lg transition-colors disabled:bg-gray-400 dark:disabled:bg-gray-500 disabled:cursor-not-allowed">äº¤æ›ã™ã‚‹</button>
        </div>
    </div>
</div>

<div id="background-purchase-modal" class="fixed inset-0 bg-black/70 z-50 items-center justify-center hidden p-4">
    <div class="bg-white dark:bg-gray-700 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
        <h2 id="background-purchase-title" class="text-xl font-bold mb-2"></h2>
        <div id="background-preview" class="w-5/6 aspect-[8/16] rounded-lg mx-auto my-4 bg-gray-200 dark:bg-gray-800 bg-cover bg-center shadow-inner"></div>
        <p id="background-purchase-cost" class="mb-6"></p>
        <div class="flex justify-center space-x-4">
            <button id="background-purchase-cancel" class="bg-gray-200 dark:bg-gray-600 px-6 py-2 rounded-lg">ã‚„ã‚ã‚‹</button>
            <button id="background-purchase-confirm" class="primary-bg primary-bg-hover text-white px-6 py-2 rounded-lg transition-colors disabled:bg-gray-400 dark:disabled:bg-gray-500 disabled:cursor-not-allowed">äº¤æ›ã™ã‚‹</button>
        </div>
    </div>
</div>
    
    <div id="countdown-modal" class="fixed inset-0 bg-black/70 z-50 items-center justify-center hidden p-4"><div class="bg-white dark:bg-gray-700 rounded-lg shadow-xl w-full max-w-sm p-6"><h2 id="countdown-modal-title" class="text-xl font-bold mb-4">ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¨­å®š</h2><div class="space-y-4"><input id="countdown-name" type="text" placeholder="ã‚¤ãƒ™ãƒ³ãƒˆå (ä¾‹: æœŸæœ«ãƒ†ã‚¹ãƒˆ)" class="w-full p-2 border rounded dark:bg-gray-800 dark:border-gray-600"><input id="countdown-date" type="date" class="w-full block p-2 border rounded dark:bg-gray-800 dark:border-gray-600"></div><div class="flex justify-between items-center mt-6"><button id="countdown-delete-btn" class="text-red-500 hover:text-red-700 font-semibold p-2 hidden"><i data-lucide="trash-2" class="w-5 h-5 inline-block mr-1"></i>å‰Šé™¤</button><div class="flex space-x-2"><button id="countdown-cancel-btn" class="bg-gray-200 dark:bg-gray-600 px-6 py-2 rounded-lg">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button id="countdown-save-btn" class="primary-bg primary-bg-hover text-white px-6 py-2 rounded-lg">ä¿å­˜</button></div></div></div></div>

    <div id="point-details-modal" class="fixed inset-0 bg-black/70 z-50 items-center justify-center hidden p-4"><div class="bg-white dark:bg-gray-700 rounded-lg shadow-xl w-full max-w-sm p-6 flex flex-col max-h-[90vh]"><div class="flex justify-between items-center mb-4 flex-shrink-0"><h2 class="text-xl font-bold">ãƒã‚¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2><button id="close-point-modal-btn" class="p-1"><i data-lucide="x"></i></button></div><div class="space-y-6 overflow-y-auto"><div class="text-center"><p class="text-sm text-gray-500">ç¾åœ¨ã®å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ</p><p class="text-4xl font-bold primary-text" id="modal-lp-display"></p></div><div><h3 class="font-semibold mb-2">ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼</h3><div id="modal-theme-selector" class="grid grid-cols-4 gap-4"></div></div><div><h3 class="font-semibold mb-2">å£ç´™</h3><div id="modal-background-selector" class="grid grid-cols-3 gap-2"></div></div></div></div></div>
    <div id="toast" class="fixed top-5 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-all duration-300 z-50 transform -translate-y-10"></div>
        
    <div id="quest-active-screen" class="hidden fixed inset-0 bg-gray-900 dark:bg-black text-gray-100 z-50 flex flex-col items-center justify-center p-4">
Â  Â  Â  Â  
        <div class="absolute top-6 right-6 flex items-center space-x-2 z-10">
            <button id="break-settings-btn" class="text-gray-400 p-2 rounded-full hover:bg-gray-700 transition-colors hidden">
                <i data-lucide="settings" class="w-7 h-7"></i>
            </button>
            <button id="end-quest-btn" class="text-gray-300 p-2 rounded-full hover:bg-gray-700 transition-colors">
                <i data-lucide="x" class="w-7 h-7"></i> </button>
        </div>
                
        <div id="quest-content-area" class="w-full h-full flex flex-col items-center justify-center">
            <div id="quest-section-view" class="hidden text-center">
                <h2 id="quest-section-title" class="text-2xl md:text-3xl font-bold mb-2 text-gray-400"></h2>
                <p class="text-7xl md:text-9xl font-mono font-extrabold" id="quest-timer">25:00</p>
                <p id="quest-progress" class="mt-4 text-lg text-gray-400"></p>
            </div>
    
            <div id="quest-break-view" class="hidden w-full h-full flex flex-col items-center pt-16 relative">
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center mb-8 flex-shrink-0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl md:text-3xl font-bold text-gray-400">â˜• ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¤ãƒ </h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-5xl md:text-7xl font-mono font-extrabold" id="break-timer">05:00</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

                <div class="w-full max-w-sm flex-grow overflow-y-auto pb-4">
    Â  Â  Â  Â  Â  Â  Â  Â  <div id="break-icon-grid" class="break-icon-grid-container">
    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
                </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  </div>
        </div>
    </div>
    
    <div id="iframe-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[60] flex flex-col">
        <div class="bg-gray-800 p-2 flex justify-end">
            <button id="close-iframe-btn" class="text-gray-300 p-1 rounded-full hover:bg-gray-700">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        <iframe id="break-iframe" class="w-full h-full" src="about:blank"></iframe>
    </div>
    
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[70] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-700 rounded-xl shadow-2xl p-6 w-full max-w-sm text-center">
            <h3 id="modal-title" class="text-lg font-bold text-gray-900 dark:text-white mb-4">ã‚¯ã‚¨ã‚¹ãƒˆã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ</h3>
            <div class="flex justify-center space-x-4">
                <button id="modal-cancel-btn" class="px-6 py-2 rounded-lg bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 font-semibold hover:bg-gray-300 dark:hover:bg-gray-500 transition">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="modal-confirm-btn" class="px-6 py-2 rounded-lg bg-red-500 text-white font-semibold hover:bg-red-600 transition">çµ‚äº†</button>
            </div>
        </div>
    </div>
    
    <div id="break-settings-modal" class="hidden fixed inset-0 bg-black/70 z-[70] flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-sm flex flex-col max-h-[80vh]">
Â  Â  Â  Â  Â  Â  <h3 class="text-lg font-bold text-white mb-2 text-center flex-shrink-0">ä¼‘æ†©ã‚¢ã‚¤ã‚³ãƒ³ã®ç·¨é›†</h3>
Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-400 mb-4 text-center flex-shrink-0">ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆã€ã‚¹ã‚¤ãƒƒãƒã§è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚</p>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="break-settings-list" class="space-y-2 overflow-y-auto py-2 mb-auto">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="break-settings-close-btn" class="mt-4 px-6 py-2 rounded-lg primary-bg primary-bg-hover text-white font-semibold transition flex-shrink-0">
Â  Â  Â  Â  Â  Â  Â  Â  é–‰ã˜ã‚‹
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const initialData = {
                quizzes: [
                    { id: 'math1', title: "æ•°å­¦ - æ­£è² ã®æ•°", subject: "æ•°å­¦", genre: "ä¸­1", tags: ['english1'], url: "https://docs.google.com/forms/d/e/1FAIpQLScsC0BFa_3gY-f-u4pW8Q22o_l3c0T-t_9c3z-q8pY6X-u8qQ/viewform?usp=sf_link" },
                    { id: 'english1', title: "è‹±èª - beå‹•è©", subject: "è‹±èª", genre: "ä¸­1", tags: ['math1', 'history1'], url: "https://docs.google.com/forms/d/e/1FAIpQLSfvtBwi1Tb1z6YEQOclBi4J7pxOc8lEILZ-OPZ4k6aebFJmTg/viewform" },
                    { id: 'science1', title: "ç†ç§‘ - æ¤ç‰©ã®ã¤ãã‚Š", subject: "ç†ç§‘", genre: "ä¸­1", tags: [], url: "https://docs.google.com/forms/d/e/1FAIpQLSfp-24sW_4xT8d_aK_b_nL5e-pX7a-j8vN-qA9rR_cT_uL-vQ/viewform?usp=sf_link" },
                    { id: 'japanese1', title: "å›½èª - æ•è‰å­", subject: "å›½èª", genre: "å¤å…¸", tags: ['history1'], url: "https://docs.google.com/forms/d/e/1FAIpQLSe-0P7p_L-rT9c-yS_eD-wA9iR_bO8kM-nL-u_V-iE7xS-tQ/viewform?usp=sf_link" },
                    { id: 'history1', title: "ç¤¾ä¼š - éŒå€‰æ™‚ä»£", subject: "ç¤¾ä¼š", genre: "æ­´å²", tags: ['japanese1'], url: "https://docs.google.com/forms/d/e/1FAIpQLSeLprqPbZCZv2ufQ2qYqltnRiUE1FsBYODa_eNwOVO1NqZwBw/viewform?usp=pp_url" },
                ],
                
                themes: {
                    default: { name: 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ', color: '#4f46e5', hover: '#4338ca', cost: 0 },
                    green: { name: 'ãƒ•ã‚©ãƒ¬ã‚¹ãƒˆ', color: '#16a34a', hover: '#15803d', cost: 100 },
                    red: { name: 'ã‚µãƒ³ã‚»ãƒƒãƒˆ', color: '#dc2626', hover: '#b91c1c', cost: 150 },
                    orange: { name: 'ãƒ“ã‚¿ãƒŸãƒ³', color: '#f97316', hover: '#ea580c', cost: 200 },
                    purple: { name: 'ãƒŸãƒƒãƒ‰ãƒŠã‚¤ãƒˆ', color: '#7c3aed', hover: '#6d28d9', cost: 250 },
                    pink: { name: 'ãƒã‚§ãƒªãƒ¼', color: '#db2777', hover: '#be185d', cost: 300 },
                    teal: { name: 'ã‚ªãƒ¼ã‚·ãƒ£ãƒ³', color: '#0d9488', hover: '#0f766e', cost: 350 },
                },
                backgrounds: {
                    default: { name: 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ', url: '', cost: 0 , tone: 'system' },
                    sky: { name: 'é’ç©ºã¨æµã‚Œæ˜Ÿ', url: 'okumono_hosisoratate8.png', cost: 500, tone: 'light' },
                    night: { name: 'æ‰‹æ›¸ãã‚†ã‚‹ãƒ‰ãƒƒãƒˆ', url: 'https://sozaino.site/wp-content/uploads/2022/01/yurudot32.png', cost: 700, tone: 'light' },
                    sdotb: { name: 'ã‚·ãƒ£ãƒ¯ãƒ¼ãƒ‰ãƒƒãƒˆ(ãƒ–ãƒ«ãƒ¼)', url: 'https://sozaino.site/wp-content/uploads/2020/11/sai-4.png', cost: 700, tone: 'light' },
                    utyuu: { name: 'å£®å¤§ãªå®‡å®™', url: 'https://sozaino.site/wp-content/uploads/2021/02/utyuu.jpg', cost: 700, tone: 'dark' },
                    jyanguru: { name: 'ã‚¸ãƒ£ãƒ³ã‚°ãƒ«', url: 'https://sozaino.site/wp-content/uploads/2025/07/okumono_jungle1.png', cost: 700, tone: 'dark' },
                    wapop: { name: 'å’Œãƒãƒƒãƒ—ï¼ˆãƒ”ãƒ³ã‚¯ï¼‰', url: 'okumono_wapop3.png', cost: 700, tone: 'dark' },
                }
            };

            let state;
            let chartInstances = {};
            let focusTimer = { interval: null, defaultTime: 0, timeLeft: 0, isRunning: false, isPaused: false };
            let stopwatch = { interval: null, startTime: 0, elapsedTime: 0, isRunning: false, isPaused: false };
            let miniTimerTemporarilyHidden = false;
            let quizTimer = { startTime: null };

            const $ = (s) => document.querySelector(s);
            const $$ = (s) => document.querySelectorAll(s);
            
            let homeTaskListEl, newTaskInput, newTaskNumberEl;

            let quest = {
                plan: [], // { id, type: 'section' | 'break', text?, duration }
                active: false,
                currentIndex: -1,
                timerInterval: null,
                timeLeft: 0,
                breakWindow: null
            };

            // ã‚¯ã‚¨ã‚¹ãƒˆç”¨ DOMè¦ç´ 
            const questView = $('#quest-view');
            const questPlanListEl = $('#quest-plan-list');
            const breakSettingsListEl = $('#break-settings-list');
            const startQuestBtn = $('#start-quest-btn');
            const addBreaksBtn = $('#add-breaks-btn');
            const addSectionBtn = $('#add-section-btn');
            const addBreakBtn = $('#add-break-btn');
            
            const questActiveScreen = $('#quest-active-screen');
            const questSectionView = $('#quest-section-view');
            const questBreakView = $('#quest-break-view');
            const questSectionTitle = $('#quest-section-title');
            const questTimerEl = $('#quest-timer');
            const breakTimerEl = $('#break-timer');
            const questProgressEl = $('#quest-progress');
            const endQuestBtn = $('#end-quest-btn');

            const confirmationModal = $('#confirmation-modal');
            const modalConfirmBtn = $('#modal-confirm-btn');
            const modalCancelBtn = $('#modal-cancel-btn');

            const iframeOverlay = $('#iframe-overlay');
            const breakIframe = $('#break-iframe');
            const closeIframeBtn = $('#close-iframe-btn');
            const breakIconGrid = $('#break-icon-grid');
            
            const loadState = () => {
Â  Â  Â  Â  Â  Â  Â  Â  const defaultState = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  profile: {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lp: 0,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  unlockedThemes: ['default'],Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  activeTheme: 'default',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  unlockedBackgrounds: ['default'],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  activeBackground: 'default',
                        tasksLastUpdated: null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
                    tasks: [],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  progress: {},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pinnedQuizzes: [],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  countdowns: [],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  focus: {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalTime: 0,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mode: 'timer',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isRunning: false, // å®Ÿè¡Œä¸­ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startTime: null,Â  // é–‹å§‹æ™‚åˆ»ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  duration: 0Â  Â  Â  Â // ã‚¿ã‚¤ãƒãƒ¼ã®ç·æ™‚é–“
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  studyLog: {},Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  settings: { backgroundScopeGlobal: true , manualDarkMode: false },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastLogin: null,
                    breakIcons: [
                        { id: 'x', name: 'X (Twitter)', icon: 'message-circle', url: 'https://x.com', openMode: 'external', visible: true },
                        { id: 'instagram', name: 'Instagram', icon: 'instagram', url: 'https://www.instagram.com/', openMode: 'external', visible: true },
                        { id: 'youtube', name: 'YouTube', icon: 'youtube', url: 'https://www.youtube.com/', openMode: 'external', visible: true },
                        { id: 'scratch1', name: 'ï¾ï¾ï¾—ï¾ï¾ƒï½¨ï½±', icon: 'gamepad-2', url: 'https://scratch.mit.edu/projects/543610448/fullscreen/', openMode: 'external', visible: true },
                        { id: 'scratch2', name: 'ï¾Œï¾ï¾˜ï½»ï¾ï½°ï½½ï¾', icon: 'gamepad-2', url: 'https://scratch.mit.edu/projects/415836558/fullscreen/', openMode: 'external', visible: true }
                    ],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // --- â–¼â–¼â–¼ ä¿®æ­£ç®‡æ‰€ â–¼â–¼â–¼ ---
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // 1. èª­ã¿è¾¼ã¿å…ˆã®å¤‰æ•°ã‚’ `let` ã§å®£è¨€
Â  Â  Â  Â  Â  Â  Â  Â  let loaded = {};
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 2. ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const savedData = localStorage.getItem('quizAppUltimateV8');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 3. ãƒ‡ãƒ¼ã‚¿ãŒ null ã‚„ç©ºæ–‡å­—ã§ãªã„å ´åˆã®ã¿ã€JSONã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹ï¼ˆè§£æï¼‰ã™ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (savedData) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loaded = JSON.parse(savedData);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 4. ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒç ´æï¼‰ã—ãŸå ´åˆ
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™:", e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 5. ç ´æã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã€`loaded` ã¯ç©ºã®ã¾ã¾ã«ã™ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('quizAppUltimateV8');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // 6. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€èª­ã¿è¾¼ã‚“ã å€¤ã§ä¸Šæ›¸ãï¼ˆãƒã‚¹ãƒˆã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚‚å®‰å…¨ã«ãƒãƒ¼ã‚¸ï¼‰
Â  Â  Â  Â  Â  Â  Â  Â  // (ã“ã“ã¯å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜)
Â  Â  Â  Â  Â  Â  Â  Â  state = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...defaultState,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...loaded,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  profile: { ...defaultState.profile, ...(loaded.profile || {}) },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  focus: { ...defaultState.focus, ...(loaded.focus || {}) },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  settings: { ...defaultState.settings, ...(loaded.settings || {}) },
                    breakIcons: loaded.breakIcons || defaultState.breakIcons
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  // --- â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–² ---

Â  Â  Â  Â  Â  Â  Â  Â  // 3. ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹å‡¦ç† (å…ƒã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãã®ã¾ã¾æµç”¨)
Â  Â  Â  Â  Â  Â  Â  Â  if(state.lastLogin !== new Date().toDateString()){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addLP(10000, 'ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹', false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.lastLogin = new Date().toDateString();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saveState(); // stateãŒå®Œå…¨ã«æ§‹ç¯‰ã•ã‚ŒãŸå¾Œã«ä¿å­˜
Â  Â  Â  Â  Â  Â  Â  Â  }

                // 4. ä»Šæ—¥ã®äºˆå®šãƒªã‚»ãƒƒãƒˆå‡¦ç†
Â  Â  Â  Â  Â  Â  Â  Â  const today = new Date().toDateString();
Â  Â  Â  Â  Â  Â  Â  Â  if (state.profile.tasksLastUpdated !== today) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('æ—¥ä»˜ãŒå¤‰ã‚ã£ãŸãŸã‚ã€ã‚¿ã‚¹ã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.tasks = []; // ã‚¿ã‚¹ã‚¯ã‚’ç©ºã«ã™ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.profile.tasksLastUpdated = today; // æ›´æ–°æ—¥ã‚’ä»Šæ—¥ã«è¨­å®š
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
            
            const saveState = () => localStorage.setItem('quizAppUltimateV8', JSON.stringify(state));
            
           // æ—¢å­˜ã® updateAppearance é–¢æ•°ã‚’ã€ã“ã®æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ã§å®Œå…¨ã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚
            
            const updateAppearance = () => {
Â  Â  Â  Â  Â  Â  Â  Â  const appContainer = $('#app-container');
Â  Â  Â  Â  Â  Â  Â  Â  const activeBgId = state.profile.activeBackground;
Â  Â  Â  Â  Â  Â  Â  Â  const activeBg = initialData.backgrounds[activeBgId] || initialData.backgrounds['default'];
Â  Â  Â  Â  Â  Â  Â  Â  const isGlobal = state.settings.backgroundScopeGlobal;
Â  Â  Â  Â  Â  Â  Â  Â  const hasImage = activeBg && activeBg.url;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // --- 1. ãƒ†ãƒ¼ãƒæ±ºå®šãƒ­ã‚¸ãƒƒã‚¯ ---
Â  Â  Â  Â  Â  Â  Â  Â  let effectiveTone = activeBg.tone;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (effectiveTone === 'system') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  effectiveTone = 'dark';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  effectiveTone = 'light';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // --- 2. æ±ºå®šã—ãŸãƒ†ãƒ¼ãƒã‚’HTMLè¦ç´ ã«é©ç”¨ (ä¿®æ­£æ¸ˆã¿ã®ãƒ­ã‚¸ãƒƒã‚¯) ---
Â  Â  Â  Â  Â  Â  Â  Â  if (effectiveTone === 'dark') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.documentElement.classList.add('dark');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.documentElement.setAttribute('data-theme', 'dark');
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.documentElement.classList.remove('dark');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.documentElement.setAttribute('data-theme', 'light');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // --- 3. èƒŒæ™¯ç”»åƒã®é©ç”¨ãƒ­ã‚¸ãƒƒã‚¯ ---
Â  Â  Â  Â  Â  Â  Â  Â  if (isGlobal && hasImage) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appContainer.style.backgroundImage = `url(${activeBg.url})`;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appContainer.style.backgroundImage = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };

            const updateLpDisplay = () => {
                $('#lp-display').textContent = `${state.profile.lp} LP`;
                if ($('#point-details-modal').style.display === 'flex') {
                    $('#modal-lp-display').textContent = state.profile.lp;
                }
            };

            const renderEngine = {
                pages: {
                    'home-page': () => {
                        const today = new Date();
                        $('#today-date').textContent = `${today.getFullYear()}å¹´ ${today.getMonth() + 1}æœˆ ${today.getDate()}æ—¥ (${'æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ'[today.getDay()]}æ›œæ—¥)`;

                        const countdownContainer = $('#countdown-list');
                        countdownContainer.innerHTML = state.countdowns.length ? state.countdowns.map(cd => {
                            const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                            const targetStart = new Date(cd.date);
                            targetStart.setHours(0,0,0,0);
                            const diffTime = targetStart - todayStart;
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            const dayText = diffDays > 0 ? `ã‚ã¨ <span class="text-2xl font-bold primary-text">${diffDays}</span> æ—¥` : diffDays === 0 ? `<span class="text-xl font-bold text-red-500">ä»Šæ—¥ã§ã™ï¼</span>` : `<span class="text-gray-500">çµ‚äº†</span>`;
                            return `<div class="bg-white dark:bg-gray-700 rounded-lg shadow-sm p-3 flex items-center justify-between"><div><h3 class="font-semibold text-gray-800 dark:text-gray-200">${cd.name}</h3><p class="text-sm text-gray-500 dark:text-gray-400">${cd.date.replace(/-/g, '/')}</p></div><div class="flex items-center"><div class="mr-4">${dayText}</div><button class="edit-countdown-btn p-2 text-gray-400 hover:text-gray-600" data-id="${cd.id}"><i data-lucide="edit" class="w-4 h-4"></i></button></div></div>`;
                        }).join('') : `<p class="text-sm text-gray-500 text-center">å³ä¸Šã®ã€Œ+ã€ãƒœã‚¿ãƒ³ã§ãƒ†ã‚¹ãƒˆãªã©ã®æ—¥ç¨‹ã‚’è¿½åŠ ã§ãã¾ã™ã€‚</p>`;
                        
                        renderHomeTasks();
                    },
                    'study-page': () => {
                        const pinnedContainer = $('#pinned-quizzes');
                        const pinnedSectionContainer = pinnedContainer.parentElement;
                    
                        if (state.pinnedQuizzes.length > 0) {
                            pinnedSectionContainer.style.display = 'block';
                            const pinnedQuizzes = state.pinnedQuizzes.map(id => initialData.quizzes.find(q => q.id === id)).filter(Boolean);
                            pinnedContainer.innerHTML = pinnedQuizzes.map(q => createQuizCard(q, true)).join('');
                        } else {
                            pinnedSectionContainer.style.display = 'none';
                        }
                    
                        const allContainer = $('#all-quizzes');
                        const subjects = ['all', ...new Set(initialData.quizzes.map(q => q.subject))];
                        const activeFilter = $('#filter-container .active')?.dataset.filter || 'all';
                        $('#filter-container').innerHTML = subjects.map(s => `<button class="filter-btn ${s === activeFilter ? 'active primary-bg text-white' : 'bg-gray-200 dark:bg-gray-600'} px-4 py-1.5 rounded-full text-sm font-medium whitespace-nowrap" data-filter="${s}">${s === 'all' ? 'ã™ã¹ã¦' : s}</button>`).join('');
                    
                        const quizzes = initialData.quizzes.filter(q => activeFilter === 'all' || q.subject === activeFilter);
                        allContainer.innerHTML = quizzes.map(q => createQuizCard(q, state.pinnedQuizzes.includes(q.id))).join('');
                    },
                    // å¤‰æ›´å¾Œ
                  'focus-page': () => {
                      updateFocusModeUI();
                        const activeBg = initialData.backgrounds[state.profile.activeBackground] || initialData.backgrounds['default'];
                        const hasImage = activeBg && activeBg.url;
                        const isGlobal = state.settings.backgroundScopeGlobal;
                        
                        $$('.focus-view-bg').forEach(el => {
                            // ã€Œå…¨ä½“é©ç”¨ã€ãŒã‚ªãƒ•ã§ã€ã‹ã¤ç”»åƒãŒã‚ã‚‹å ´åˆã®ã¿ã€é›†ä¸­ãƒ¢ãƒ¼ãƒ‰ã®è¦ç´ ã«ç›´æ¥èƒŒæ™¯ã‚’è¨­å®š
                            if (!isGlobal && hasImage) {
                                el.style.backgroundImage = `url(${activeBg.url})`;
                            } else {
                                // ã€Œå…¨ä½“é©ç”¨ã€ãŒã‚ªãƒ³ã®å ´åˆã¯ã€#app-containerã®èƒŒæ™¯ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«è‡ªèº«ã®èƒŒæ™¯ã‚’æ¶ˆã™
                                el.style.backgroundImage = 'none';
                            }
                        });
                    },
                    'my-chart-page': () => {
                        const activeTheme = initialData.themes[state.profile.activeTheme] || initialData.themes['default'];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const activeThemeColor = activeTheme.color;
                        const rgb = hexToRgb(activeThemeColor);
                        const chartAreaColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.2)`;
                        const chartBarColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.5)`;
                        const chartBorderColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 1)`;
                        const subjects = [...new Set(initialData.quizzes.map(q => q.subject))];
                        const radarData = subjects.map(sub => {
                            const quizzesInSub = initialData.quizzes.filter(q => q.subject === sub);
                            const totalLevels = quizzesInSub.reduce((acc, q) => acc + (state.progress[q.id]?.level || 0), 0);
                            const completedCount = quizzesInSub.filter(q => state.progress[q.id]).length;
                            return completedCount > 0 ? (totalLevels / completedCount) / 3 * 100 : 0;
                        });
                        renderChart('subject-radar-chart', 'radar', { labels: subjects, datasets: [{ label: 'ç†è§£åº¦ (%)', data: radarData, backgroundColor: chartAreaColor, borderColor: chartBorderColor, borderWidth: 2 }] }, { scales: { r: { beginAtZero: true, max: 100 } } });

                    
                        const labels = [];
                        const data = [];
                        for (let i = 6; i >= 0; i--) {
                            const d = new Date();
                            d.setDate(d.getDate() - i);
                            const day = d.toISOString().split('T')[0];
                            labels.push(`${d.getMonth()+1}/${d.getDate()}`);
                            const log = state.studyLog[day] || { focus: 0, quiz: 0 };
                            data.push((log.focus + log.quiz) / 60); // in minutes
                        }
                        renderChart('study-time-chart', 'bar', { labels, datasets: [{ label: 'å­¦ç¿’æ™‚é–“ (åˆ†)', data, backgroundColor: chartBarColor, borderColor: chartBorderColor, borderWidth: 1 }] }, { scales: { y: { beginAtZero: true } } });
                    },
                    'settings-page': () => {
                        
                        const notifCard = $('#notification-settings-card');
                        if (notifCard) {
                            if ('Notification' in window && Notification.permission === 'granted') {
                                notifCard.style.display = 'none'; // ã‚«ãƒ¼ãƒ‰ã”ã¨éè¡¨ç¤º
                            } else {
                                notifCard.style.display = 'block'; // è¡¨ç¤º
                            }   
                        }
                        
                        $('#theme-selector').innerHTML = state.profile.unlockedThemes.map(id => {
                            const theme = initialData.themes[id];
                            const isActive = state.profile.activeTheme === id;
                            return `<div class="text-center">
                                <button class="theme-btn w-12 h-12 rounded-full border-4 ${isActive ? 'border-blue-500' : 'border-transparent'} relative" style="background-color: ${theme.color}" data-theme="${id}"></button>
                                <p class="text-xs mt-1">${theme.name}</p>
                            </div>`;
                        }).join('') || `<p class="text-sm text-gray-500">ãƒã‚¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‹ã‚‰ãƒ†ãƒ¼ãƒã‚’äº¤æ›ã§ãã¾ã™ã€‚</p>`;

                        $('#background-selector').innerHTML = state.profile.unlockedBackgrounds.map(id => {
                            const bg = initialData.backgrounds[id];
                            const isActive = state.profile.activeBackground === id;
                             return `<div class="text-center">
                                <button class="background-btn w-full h-20 rounded-lg border-4 ${isActive ? 'border-blue-500' : 'border-transparent'} relative bg-gray-500 bg-cover bg-center" style="background-image: ${bg.url ? `url(${bg.url})` : 'none'}" data-bg="${id}"></button>
                                <p class="text-xs mt-1">${bg.name}</p>
                            </div>`;
                        }).join('') || `<p class="text-sm text-gray-500">ãƒã‚¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‹ã‚‰èƒŒæ™¯ã‚’äº¤æ›ã§ãã¾ã™ã€‚</p>`;
                    }
                },
                renderAll: () => {
                    for(const pageId in renderEngine.pages){
                        if($(`#${pageId}`).classList.contains('active')){
                            renderEngine.pages[pageId]();
                        }
                    }
                    updateLpDisplay();
                    const activeTheme = initialData.themes[state.profile.activeTheme] || initialData.themes['default'];
                    document.documentElement.style.setProperty('--primary-color', activeTheme.color);
                    document.documentElement.style.setProperty('--primary-color-hover', activeTheme.hover);
                }
            };
            
           const createQuizCard = (quiz, isPinned) => {
Â  Â  Â  Â  Â  Â  Â  Â  if(!quiz) return '';
Â  Â  Â  Â  Â  Â  Â  Â  const progress = state.progress[quiz.id];
Â  Â  Â  Â  Â  Â  Â  Â  const levelIcons = { 1: 'book-open-check', 2: 'thumbs-up', 3: 'award'};
Â  Â  Â  Â  Â  Â  Â  Â  return `<div class="bg-white dark:bg-gray-700 rounded-lg shadow-sm p-3 flex items-center justify-between quiz-card" data-id="${quiz.id}"><div class="flex items-center min-w-0"><div class="w-5 h-5 mr-3 flex-shrink-0">${progress ? `<i data-lucide="${levelIcons[progress.level]}" class="text-yellow-500"></i>` : ``}</div><div class="truncate"><h3 class="font-semibold text-gray-800 dark:text-gray-200 truncate">${quiz.title}</h3><p class="text-sm text-gray-500 dark:text-gray-400">${quiz.subject} - ${quiz.genre}</p></div></div><button class="pin-btn p-2 -mr-2 flex-shrink-0" data-id="${quiz.id}"><i data-lucide="pin" class="w-5 h-5 ${isPinned ? 'primary-text fill-current' : 'text-gray-400'}"></i></button></div>`;
Â  Â  Â  Â  Â  Â  };
            
            const renderChart = (canvasId, type, data, options) => {
                const ctx = $(`#${canvasId}`).getContext('2d');
                if(chartInstances[canvasId]) chartInstances[canvasId].destroy();
                chartInstances[canvasId] = new Chart(ctx, { type, data, options });
            };

            const showToast = (message) => {
                const toast = $('#toast'); toast.textContent = message; toast.classList.remove('opacity-0', '-translate-y-10');
                setTimeout(() => toast.classList.add('opacity-0', '-translate-y-10'), 2000);
            };

            const addLP = (amount, reason, show = true) => {
                state.profile.lp += amount;
                if(show) showToast(`${reason}ã§ ${amount} LP ç²å¾—ï¼`);
                updateLpDisplay();
            };
            
            const formatTime = (s) => {
                const totalSeconds = Math.floor(s);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                if (hours > 0) return `${hours}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
                return `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
            };

            // ã€è¿½åŠ ã€‘ã‚¿ã‚¤ãƒãƒ¼ã«æ™‚é–“ã‚’åŠ ç®—ã™ã‚‹é–¢æ•°
            const addTimerTime = (seconds) => {
                if (focusTimer.isRunning) return; // å®Ÿè¡Œä¸­ã¯æ™‚é–“ã‚’å¤‰æ›´ã§ããªã„ã‚ˆã†ã«ã™ã‚‹
                focusTimer.timeLeft += seconds;
                $('#focus-timer-display').textContent = formatTime(focusTimer.timeLeft);
            };
            
            // ã€è¿½åŠ ã€‘ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹é–¢æ•°
            const resetTimerDisplay = () => {
                if (focusTimer.isRunning) return;
                focusTimer.timeLeft = 0;
                $('#focus-timer-display').textContent = formatTime(0);
            };
            
            const formatStopwatchTime = (s) => {
                const totalSeconds = s;
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = Math.floor(totalSeconds % 60);
                // const ms = ... ã®è¡Œã‚’å‰Šé™¤
                return `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`; // è¿”ã‚Šå€¤ã‹ã‚‰msã‚’å‰Šé™¤
            };

            const hexToRgb = (hex) => {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : null;
            };

            const logStudyTime = (type, seconds) => {
                const today = new Date().toISOString().split('T')[0];
                if (!state.studyLog[today]) state.studyLog[today] = { focus: 0, quiz: 0 };
                state.studyLog[today][type] += seconds;
            };

            const renderHomeTasks = () => {
                if (!homeTaskListEl) return; // initå‰ã¯å®Ÿè¡Œã—ãªã„
    
                if (!state.tasks || state.tasks.length === 0) {
                    homeTaskListEl.innerHTML = `<p class="text-center text-sm text-gray-500">ä»Šæ—¥ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>`;
                } else {
                    homeTaskListEl.innerHTML = ''; // ä¸€æ—¦ã‚¯ãƒªã‚¢
                    state.tasks.forEach((task, index) => {
                        const taskEl = document.createElement('div');
                        taskEl.className = 'flex items-center space-x-2 group task-item';
                        taskEl.dataset.id = task.id;
                        taskEl.innerHTML = `
                            <span class="font-bold w-6 text-center text-gray-600 dark:text-gray-400">${index + 1}</span>
                            <input type="text" value="${task.text}" class="task-text-input flex-grow bg-transparent p-1 focus:outline-none rounded">
                            <button class="task-handle cursor-move text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-opacity">
                                <i data-lucide="grip-vertical" class="w-5 h-5"></i>
                            </button>
                            <button class="delete-task-btn text-gray-400 hover:text-red-500 transition-opacity">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        `;
                        homeTaskListEl.appendChild(taskEl);
                        
                        // ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
                        taskEl.querySelector('.task-text-input').addEventListener('change', (e) => {
                            const taskToUpdate = state.tasks.find(t => t.id == taskEl.dataset.id);
                            if (taskToUpdate) {
                                taskToUpdate.text = e.target.value;
                                saveState();
                            }
                        });
                    });
                }
                newTaskNumberEl.textContent = state.tasks.length + 1;
                lucide.createIcons();
            };

            document.body.addEventListener('click', e => {
                const quizCard = e.target.closest('.quiz-card');
                if (quizCard && !e.target.closest('.pin-btn')) {
                    const quiz = initialData.quizzes.find(q => q.id === quizCard.dataset.id);
                    $('#quiz-modal-title').textContent = quiz.title;
                    
                    // â˜…â˜…â˜… ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’å†è¡¨ç¤ºã™ã‚‹å‡¦ç†ã‚’è¿½åŠ  â˜…â˜…â˜…
                    $('#loader').parentElement.style.display = 'flex'; 
                
                    $('#quiz-iframe').classList.add('invisible');
                    $('#quiz-modal').dataset.currentQuiz = quiz.id;
                    $('#quiz-modal').style.display = 'flex';
                    quizTimer.startTime = Date.now();
                    setTimeout(() => {
                        $('#quiz-iframe').src = quiz.url;
                        $('#quiz-iframe').onload = () => {
                            $('#loader').parentElement.style.display = 'none'; 
                            $('#quiz-iframe').classList.remove('invisible');
                        };
                    }, 100);
                }
                const pinBtn = e.target.closest('.pin-btn');
                if(pinBtn) {
                    const quizId = pinBtn.dataset.id;
                    state.pinnedQuizzes.includes(quizId) ? state.pinnedQuizzes = state.pinnedQuizzes.filter(id => id !== quizId) : state.pinnedQuizzes.push(quizId);
                    saveState(); renderEngine.pages['study-page'](); lucide.createIcons();
                }
                
                const filterBtn = e.target.closest('.filter-btn');
                if(filterBtn) {
                     $$('#filter-container .filter-btn').forEach(b => {
                         b.classList.remove('active', 'primary-bg', 'text-white');
                         b.classList.add('bg-gray-200', 'dark:bg-gray-600');
                     });
                     filterBtn.classList.add('active', 'primary-bg', 'text-white');
                     filterBtn.classList.remove('bg-gray-200', 'dark:bg-gray-600');
                     renderEngine.pages['study-page']();
                     lucide.createIcons();
                }

                const closeModalBtn = e.target.closest('.close-modal-btn');
                if (closeModalBtn) {
                    const modal = $(`#${closeModalBtn.dataset.modal}`);
                    modal.style.display = 'none';
                    if (closeModalBtn.dataset.modal === 'quiz-modal') {
                        $('#assessment-modal').dataset.quizId = modal.dataset.currentQuiz;
                        $('#assessment-modal').style.display = 'flex';
                        if(quizTimer.startTime) {
                            const elapsed = Math.round((Date.now() - quizTimer.startTime) / 1000);
                            logStudyTime('quiz', elapsed);
                            quizTimer.startTime = null;
                            saveState();
                        }
                    }
                }
                
                const assessmentBtn = e.target.closest('.assessment-btn');
                if(assessmentBtn) {
                    const level = parseInt(assessmentBtn.dataset.level);
                    const quizId = $('#assessment-modal').dataset.quizId;
                    state.progress[quizId] = { level, date: new Date().toISOString() };
                    addLP(level * 5, 'ã‚¯ã‚¤ã‚ºè©•ä¾¡');
                    saveState();
                    renderEngine.renderAll();
                    $('#assessment-modal').style.display = 'none';
                }

                const themeBtn = e.target.closest('.theme-btn');
                if(themeBtn){
                    const themeId = themeBtn.dataset.theme;
                    if(state.profile.unlockedThemes.includes(themeId)) {
                        state.profile.activeTheme = themeId;
                        saveState();
                        renderEngine.renderAll();
                    } else {
                        const theme = initialData.themes[themeId];
                        const confirmBtn = $('#theme-purchase-confirm');
                        
                        $('#theme-purchase-title').textContent = `ã€Œ${theme.name}ã€ã‚’äº¤æ›ã—ã¾ã™ã‹ï¼Ÿ`;
                        $('#theme-purchase-cost').textContent = `å¿…è¦ãªãƒã‚¤ãƒ³ãƒˆ: ${theme.cost} LP`;
                        
                        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                        $('#theme-preview').style.backgroundColor = theme.color;
                
                        // ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                        if (state.profile.lp >= theme.cost) {
                            confirmBtn.disabled = false;
                        } else {
                            confirmBtn.disabled = true;
                        }
                
                        confirmBtn.dataset.itemId = themeId;
                        confirmBtn.dataset.itemType = 'theme';
                        $('#theme-purchase-modal').style.display = 'flex';
                    }
                }

                const backgroundBtn = e.target.closest('.background-btn');
                if(backgroundBtn){
                    const bgId = backgroundBtn.dataset.bg;
                    if(state.profile.unlockedBackgrounds.includes(bgId)) {
                        state.profile.activeBackground = bgId;
                        saveState();
                        updateAppearance();
                        renderEngine.pages['settings-page']();
                        lucide.createIcons();
                    } else {
                        const bg = initialData.backgrounds[bgId];
                        const confirmBtn = $('#background-purchase-confirm');
                
                        $('#background-purchase-title').textContent = `ã€Œ${bg.name}ã€ã‚’äº¤æ›ã—ã¾ã™ã‹ï¼Ÿ`;
                        $('#background-purchase-cost').textContent = `å¿…è¦ãªãƒã‚¤ãƒ³ãƒˆ: ${bg.cost} LP`;
                
                        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                        const previewEl = $('#background-preview');
                        if (bg.url) {
                            previewEl.style.backgroundImage = `url(${bg.url})`;
                            previewEl.classList.remove('hidden');
                        } else {
                            previewEl.classList.add('hidden'); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãªã©ç”»åƒãŒãªã„å ´åˆã¯éè¡¨ç¤º
                        }
                        
                        // ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                        if (state.profile.lp >= bg.cost) {
                            confirmBtn.disabled = false;
                        } else {
                            confirmBtn.disabled = true;
                        }
                
                        confirmBtn.dataset.itemId = bgId;
                        confirmBtn.dataset.itemType = 'background';
                        $('#background-purchase-modal').style.display = 'flex';
                    }
                }

                const editCountdownBtn = e.target.closest('.edit-countdown-btn');
                if(editCountdownBtn){
                    const id = editCountdownBtn.dataset.id;
                    openCountdownModal(id);
                }

                // â–¼â–¼â–¼ é›†ä¸­ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ï¼ˆã‚¿ã‚¤ãƒãƒ¼/SWï¼‰ã®ãƒªã‚¹ãƒŠãƒ¼ä¿®æ­£ â–¼â–¼â–¼
Â  Â  Â  Â  Â  Â  Â  Â  const focusModeBtn = e.target.closest('.focus-mode-btn');
Â  Â  Â  Â  Â  Â  Â  Â  if(focusModeBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const mode = focusModeBtn.dataset.mode;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.focus.mode = mode; // 'timer' ã‹ 'stopwatch' ãŒå…¥ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateFocusModeUI(); // UIã‚’æ›´æ–°
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  // â–²â–²â–² ä¿®æ­£ã“ã“ã¾ã§ â–²â–²â–²

Â  Â  Â  Â  Â  Â  Â  Â  // â–¼â–¼â–¼ ã‚¯ã‚¨ã‚¹ãƒˆè¡¨ç¤ºãƒœã‚¿ãƒ³ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’ã€Œæ–°è¦è¿½åŠ ã€ â–¼â–¼â–¼
Â  Â  Â  Â  Â  Â  Â  Â  const showQuestBtn = e.target.closest('#show-quest-btn');
Â  Â  Â  Â  Â  Â  Â  Â  if (showQuestBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  $('#focus-main-view').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  $('#quest-view').style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ã‚¯ã‚¨ã‚¹ãƒˆãƒ—ãƒ©ãƒ³ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderQuestPlan();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lucide.createIcons();
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // â–¼â–¼â–¼ ã‚¯ã‚¨ã‚¹ãƒˆæˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’ã€Œæ–°è¦è¿½åŠ ã€ â–¼â–¼â–¼
Â  Â  Â  Â  Â  Â  Â  Â  const questBackBtn = e.target.closest('#quest-back-btn');
Â  Â  Â  Â  Â  Â  Â  Â  if (questBackBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  $('#focus-main-view').style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  $('#quest-view').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // å¿µã®ãŸã‚ã‚¿ã‚¤ãƒãƒ¼/SWã®è¡¨ç¤ºã‚’æ›´æ–°
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateFocusModeUI();
Â  Â  Â  Â  Â  Â  Â  Â  }

                // æ™‚é–“åŠ ç®—ãƒœã‚¿ãƒ³ã®å‡¦ç†
                const timeAddBtn = e.target.closest('.time-add-btn');
                if(timeAddBtn) {
                    const time = parseInt(timeAddBtn.dataset.time);
                    addTimerTime(time);
                }
                
                // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®å‡¦ç†
                const timerResetBtn = e.target.closest('#timer-reset-btn');
                if(timerResetBtn) {
                    resetTimerDisplay();
                }
                // â˜…æ–°è¦è¿½åŠ â˜… ä¼‘æ†©è¨­å®šãƒœã‚¿ãƒ³ï¼ˆã‚¯ã‚¨ã‚¹ãƒˆä¸­ï¼‰
                const breakSettingsBtn = e.target.closest('#break-settings-btn');
                if (breakSettingsBtn) {
                    openBreakSettingsModal();
                }
    
                // â˜…æ–°è¦è¿½åŠ â˜… ä¼‘æ†©è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                const breakSettingsCloseBtn = e.target.closest('#break-settings-close-btn');
                if (breakSettingsCloseBtn) {
                    $('#break-settings-modal').style.display = 'none';
                    // å¤‰æ›´ã‚’å³åº§ã«åæ˜ 
                    renderBreakIcons();
                }
            });
            
            /* å¤‰æ›´å¾Œ (æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¨ã—ã¦è¿½åŠ ) */
            $('#background-scope-toggle').addEventListener('change', (e) => {
                state.settings.backgroundScopeGlobal = e.target.checked;
                saveState();
                updateAppearance();
                // é›†ä¸­ã‚¿ãƒ–ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã«å‚™ãˆã¦å†æç”»
                if ($('#focus-page').classList.contains('active')) {
                    renderEngine.pages['focus-page']();
                }
            });
            
            $('#lp-button').addEventListener('click', () => {
                // 1. LPãƒã‚¤ãƒ³ãƒˆã®è¡¨ç¤ºã‚’æ›´æ–°
                $('#modal-lp-display').textContent = state.profile.lp;
                
                // 2. ãƒ†ãƒ¼ãƒã¨å£ç´™ã®ãƒªã‚¹ãƒˆã‚’æç”»ï¼ˆé–¢æ•°å‘¼ã³å‡ºã—ï¼‰
                renderPointModalContent(); 
                
                // 3. ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                $('#point-details-modal').style.display = 'flex';
                lucide.createIcons();
            });

            function handlePurchase(e) {
                const { itemId, itemType } = e.target.dataset;
                const itemData = initialData[itemType + 's'][itemId];
            
                if (state.profile.lp >= itemData.cost) {
                    addLP(-itemData.cost, `ã‚¢ã‚¤ãƒ†ãƒ ã€Œ${itemData.name}ã€äº¤æ›`);
                    state.profile[`unlocked${itemType.charAt(0).toUpperCase() + itemType.slice(1)}s`].push(itemId);
                    showToast(`ã€Œ${itemData.name}ã€ã‚’è§£æ”¾ã—ã¾ã—ãŸï¼`);
                    saveState();
                    renderPointModalContent();
                    if ($('#settings-page').classList.contains('active')) {
                        renderEngine.pages['settings-page']();
                    }
                } else { // â† ifæ–‡ã®ä¸­ã«æ­£ã—ãå…¥ã‚Œã‚‹
                    showToast('LPãŒè¶³ã‚Šã¾ã›ã‚“ï¼');
                }
                $(`#${itemType}-purchase-modal`).style.display = 'none';
            }
            
            // --- Focus Page Logic ---
            const updateMiniTimer = () => {
                if (miniTimerTemporarilyHidden) {
                    $('#mini-timer-container').classList.remove('visible');
                    return;
                }
                const container = $('#mini-timer-container');
                const bar = $('#mini-timer-bar');
                if ((focusTimer.isRunning || stopwatch.isRunning) && !$('#focus-page').classList.contains('active')) {
                    container.classList.add('visible');
                    if(focusTimer.isRunning){
                        const progress = (focusTimer.defaultTime - focusTimer.timeLeft) / focusTimer.defaultTime * 100;
                        $('#mini-timer-text').textContent = formatTime(focusTimer.timeLeft);
                        $('#mini-timer-progress-bar').style.width = `${progress}%`;
                    } else { // stopwatch
                         $('#mini-timer-text').textContent = formatStopwatchTime(stopwatch.elapsedTime);
                         $('#mini-timer-progress-bar').style.width = `100%`;
                    }
                } else {
                    container.classList.remove('visible');
                }
            };
            
            const timerTick = () => {
                focusTimer.timeLeft--;
                $('#focus-timer-display').textContent = formatTime(focusTimer.timeLeft);
                updateMiniTimer();
                if (focusTimer.timeLeft <= 0) {
                    clearInterval(focusTimer.interval);
                    // showToast ã¨ new Notification ã¯ Service Worker ãŒæ‹…å½“ã™ã‚‹ãŸã‚ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã¾ãŸã¯å‰Šé™¤
                    // showToast('é›†ä¸­ãƒ¢ãƒ¼ãƒ‰å®Œäº†ï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼');
                    // if (Notification.permission === 'granted') { ... }
            
                    const elapsed = focusTimer.defaultTime;
                    logStudyTime('focus', elapsed);
                    addLP(Math.floor(elapsed/60), 'ã‚¿ã‚¤ãƒãƒ¼å®Œäº†');
                    state.focus.totalTime += elapsed;
                    saveState();
                    resetTimerUI();
            
                    // ã€è¿½åŠ ã€‘Service Workerã«ã‚¿ã‚¤ãƒãƒ¼åœæ­¢ã‚’é€šçŸ¥ï¼ˆå®Œäº†æ™‚ï¼‰
                    if (navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({ command: 'stopTimer' });
                    }
                }
            };
            
            const stopwatchTick = () => {
                stopwatch.elapsedTime = (Date.now() - stopwatch.startTime) / 1000;
                $('#stopwatch-display').textContent = formatStopwatchTime(stopwatch.elapsedTime);
                updateMiniTimer();
            };

            const pauseFocusTimer = () => {
                if (!focusTimer.isRunning || focusTimer.isPaused) return;
                focusTimer.isPaused = true;
                clearInterval(focusTimer.interval);
                $('#focus-pause-btn').innerHTML = `<i data-lucide="play" class="w-6 h-6 mr-2"></i>å†é–‹`;
                lucide.createIcons();
            };

            const resumeFocusTimer = () => {
                if (!focusTimer.isRunning || !focusTimer.isPaused) return;
                focusTimer.isPaused = false;
                focusTimer.interval = setInterval(timerTick, 1000);
                $('#focus-pause-btn').innerHTML = `<i data-lucide="pause" class="w-6 h-6 mr-2"></i>ä¸€æ™‚åœæ­¢`;
                lucide.createIcons();
            };

            const pauseStopwatch = () => {
                if (!stopwatch.isRunning || stopwatch.isPaused) return;
                stopwatch.isPaused = true;
                clearInterval(stopwatch.interval);
                $('#stopwatch-pause-btn').innerHTML = `<i data-lucide="play" class="w-6 h-6 mr-2"></i>å†é–‹`;
                lucide.createIcons();
            };

            const resumeStopwatch = () => {
                if (!stopwatch.isRunning || !stopwatch.isPaused) return;
                stopwatch.isPaused = false;
                stopwatch.startTime = Date.now() - stopwatch.elapsedTime * 1000;
                stopwatch.interval = setInterval(stopwatchTick, 100);
                $('#stopwatch-pause-btn').innerHTML = `<i data-lucide="pause" class="w-6 h-6 mr-2"></i>ä¸€æ™‚åœæ­¢`;
                lucide.createIcons();
            };

            const updateFocusModeUI = () => {
Â  Â  Â  Â  Â  Â  Â  Â  const mode = state.focus.mode;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // ãƒ¡ã‚¤ãƒ³ãƒ“ãƒ¥ãƒ¼å†…ã®è¡¨ç¤ºåˆ‡æ›¿
Â  Â  Â  Â  Â  Â  Â  Â  $('#timer-view').style.display = (mode === 'timer') ? 'flex' : 'none';
Â  Â  Â  Â  Â  Â  Â  Â  $('#stopwatch-view').style.display = (mode === 'stopwatch') ? 'flex' : 'none';
Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // ãƒœã‚¿ãƒ³ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆå‡¦ç†
Â  Â  Â  Â  Â  Â  Â  Â  const timerBtn = $('.focus-mode-btn[data-mode="timer"]');
Â  Â  Â  Â  Â  Â  Â  Â  const stopwatchBtn = $('.focus-mode-btn[data-mode="stopwatch"]');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (mode === 'timer') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timerBtn.classList.add('primary-bg', 'text-white');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stopwatchBtn.classList.remove('primary-bg', 'text-white');
Â  Â  Â  Â  Â  Â  Â  Â  } else if (mode === 'stopwatch') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timerBtn.classList.remove('primary-bg', 'text-white');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stopwatchBtn.classList.add('primary-bg', 'text-white');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };

            const resetTimerUI = () => {
                clearInterval(focusTimer.interval);
                focusTimer.isRunning = false; focusTimer.isPaused = false;
                focusTimer.timeLeft = focusTimer.defaultTime; // defaultTimeã‹ã‚‰ãƒªã‚»ãƒƒãƒˆ
                $('#focus-timer-display').textContent = formatTime(focusTimer.defaultTime);
                $('#focus-start-btn').classList.remove('hidden');
                $('#focus-controls').classList.add('hidden');
                $('#timer-settings-container').classList.remove('hidden');
                updateMiniTimer();
            };

            const resetStopwatchUI = () => {
                clearInterval(stopwatch.interval);
                stopwatch.isRunning = false; stopwatch.isPaused = false;
                stopwatch.elapsedTime = 0;
                $('#stopwatch-display').textContent = formatStopwatchTime(0);
                $('#stopwatch-start-btn').classList.remove('hidden');
                $('#stopwatch-controls').classList.add('hidden');
                updateMiniTimer();
            };

            const endFocusTimer = () => {
                if (!focusTimer.isRunning) return;
                const elapsed = focusTimer.defaultTime - focusTimer.timeLeft;
                if (elapsed > 0) { logStudyTime('focus', elapsed); addLP(Math.floor(elapsed / 60), 'é›†ä¸­ãƒ¢ãƒ¼ãƒ‰'); state.focus.totalTime += elapsed; saveState(); }
                resetTimerUI();
            
                // ã€è¿½åŠ ã€‘Service Workerã«ã‚¿ã‚¤ãƒãƒ¼åœæ­¢ã‚’é€šçŸ¥
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({ command: 'stopTimer' });
                }
                // â–¼â–¼â–¼ã€è¿½åŠ ã€‘ã“ã“ã‹ã‚‰â–¼â–¼â–¼
                state.focus.isRunning = false;
                state.focus.startTime = null;
                saveState();
                // â–²â–²â–²ã€è¿½åŠ ã€‘ã“ã“ã¾ã§â–²â–²â–²
            };

            const endStopwatch = () => {
                if (!stopwatch.isRunning) return;
                const elapsed = Math.round(stopwatch.elapsedTime);
                if (elapsed > 0) { logStudyTime('focus', elapsed); addLP(Math.floor(elapsed / 60), 'ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒ'); state.focus.totalTime += elapsed; saveState(); }
                resetStopwatchUI();
                // â–¼â–¼â–¼ã€è¿½åŠ ã€‘ã“ã“ã‹ã‚‰â–¼â–¼â–¼
                state.focus.isRunning = false;
                state.focus.startTime = null;
                saveState();
                // â–²â–²â–²ã€è¿½åŠ ã€‘ã“ã“ã¾ã§â–²â–²â–²
            };
            
            const setTimer = (seconds) => {
                focusTimer.defaultTime = seconds; // defaultTimeã‚‚æ›´æ–°
                focusTimer.timeLeft = seconds;
                $('#focus-timer-display').textContent = formatTime(seconds);
            };

           $('#focus-start-btn').addEventListener('click', () => {
                if (focusTimer.timeLeft <= 0) {
                    showToast('æ™‚é–“ã‚’è¨­å®šã—ã¦ãã ã•ã„');
                    return;
                }
                focusTimer.defaultTime = focusTimer.timeLeft;
                focusTimer.isRunning = true;
                focusTimer.isPaused = false;
                state.focus.isRunning = true;
                state.focus.startTime = Date.now(); // ç¾åœ¨æ™‚åˆ»ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä¿å­˜
                state.focus.duration = focusTimer.timeLeft;
                saveState();
                focusTimer.interval = setInterval(timerTick, 1000);
                $('#focus-start-btn').classList.add('hidden');
                $('#focus-controls').classList.remove('hidden');
                $('#timer-settings-container').classList.add('hidden');
                updateMiniTimer();
            
                // ã€è¿½åŠ ã€‘Service Workerã«ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ã‚’é€šçŸ¥
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        command: 'startTimer',
                        timeLeft: focusTimer.timeLeft
                    });
                }
            });
            /* â–¼â–¼â–¼ è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆæ©Ÿèƒ½ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ â–¼â–¼â–¼ */

            // ã‚¯ã‚¨ã‚¹ãƒˆè¨­å®šãƒ“ãƒ¥ãƒ¼ã®ãƒœã‚¿ãƒ³
            addSectionBtn.addEventListener('click', () => {
                quest.plan.push({
                    id: Date.now(),
                    type: 'section',
                    text: 'æ–°ã—ã„ã‚»ã‚¯ã‚·ãƒ§ãƒ³',
                    duration: 25 * 60
                });
                renderQuestPlan();
            });

            addBreakBtn.addEventListener('click', () => {
                quest.plan.push({
                    id: Date.now(),
                    type: 'break',
                    duration: 5 * 60
                });
                renderQuestPlan();
            });

            addBreaksBtn.addEventListener('click', () => {
                const interval = parseInt($('#break-interval-input').value) || 2;
                const duration = parseInt($('#break-duration-input').value) || 5;
                const newPlan = [];
                let sectionCount = 0;
                
                // ä¼‘æ†©ã‚’é™¤ã„ãŸã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã¿ã®ãƒªã‚¹ãƒˆã‚’å…ƒã«ã™ã‚‹
                const sections = quest.plan.filter(item => item.type === 'section');

                sections.forEach((item, index) => {
                    newPlan.push(item);
                    sectionCount++;
                    // æœ€å¾Œã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ä»¥å¤–ã§ã€intervalã®å€æ•°ç•ªç›®ãªã‚‰ä¼‘æ†©ã‚’è¿½åŠ 
                    if (sectionCount % interval === 0 && index !== sections.length - 1) {
                        newPlan.push({
                            id: Date.now() + Math.random(),
                            type: 'break',
                            duration: duration * 60
                        });
                    }
                });
                
                quest.plan = newPlan;
                renderQuestPlan();
            });

            startQuestBtn.addEventListener('click', startQuest);

            // ã‚¯ã‚¨ã‚¹ãƒˆå®Ÿè¡Œç”»é¢ã®ãƒœã‚¿ãƒ³
            endQuestBtn.addEventListener('click', () => {
                confirmationModal.style.display = 'flex';
            });

            modalConfirmBtn.addEventListener('click', () => endQuest(false));
            modalCancelBtn.addEventListener('click', () => {
                confirmationModal.style.display = 'none';
            });

           // ä¼‘æ†©ä¸­ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ (ã‚¢ã‚¤ã‚³ãƒ³ãƒ›ãƒ¼ãƒ ç”»é¢)
Â  Â  Â  Â  Â  Â  if(breakIconGrid) {
Â  Â  Â  Â  Â  Â  Â  Â  breakIconGrid.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const btn = e.target.closest('.break-content-btn');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (btn && btn.dataset.url) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // â˜…ã“ã“ã‹ã‚‰å¤‰æ›´â˜…
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (btn.dataset.openMode === 'external') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // å¤–éƒ¨ã‚¿ãƒ–ã§é–‹ã (å¼·åˆ¶ã‚¯ãƒ­ãƒ¼ã‚ºä¸å¯)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.open(btn.dataset.url, '_blank');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // å¾“æ¥é€šã‚Šã‚¢ãƒ—ãƒªå†… (iframe) ã§é–‹ã (å¼·åˆ¶ã‚¯ãƒ­ãƒ¼ã‚ºå¯èƒ½)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  openIframe(btn.dataset.url);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // â˜…ã“ã“ã¾ã§å¤‰æ›´â˜…
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
            closeIframeBtn.addEventListener('click', closeIframe);

            /* â–²â–²â–² è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆæ©Ÿèƒ½ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ â–²â–²â–² */
            
            $('#focus-pause-btn').addEventListener('click', () => { if (focusTimer.isPaused) resumeFocusTimer(); else pauseFocusTimer(); });
            $('#focus-end-btn').addEventListener('click', endFocusTimer);

            $('#stopwatch-start-btn').addEventListener('click', () => {
                stopwatch.isRunning = true; stopwatch.isPaused = false;
                // ä¿®æ­£ï¼šä¿å­˜ã•ã‚ŒãŸæ™‚é–“ã§ã¯ãªãã€å¸¸ã«ç¾åœ¨ã®æ™‚åˆ»ã‹ã‚‰é–‹å§‹
                stopwatch.startTime = Date.now() - stopwatch.elapsedTime * 1000;
            
                // â–¼â–¼â–¼ã€è¿½åŠ ã€‘ã“ã“ã‹ã‚‰â–¼â–¼â–¼
                state.focus.isRunning = true;
                // ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒã®å ´åˆã€é–‹å§‹æ™‚åˆ»ã®ã¿ä¿å­˜
                state.focus.startTime = stopwatch.startTime; 
                saveState();
                stopwatch.interval = setInterval(stopwatchTick, 100);
                $('#stopwatch-start-btn').classList.add('hidden');
                $('#stopwatch-controls').classList.remove('hidden');
                updateMiniTimer();
            });
            $('#stopwatch-pause-btn').addEventListener('click', () => { if (stopwatch.isPaused) resumeStopwatch(); else pauseStopwatch(); });
            $('#stopwatch-end-btn').addEventListener('click', endStopwatch);
            
            $('#notification-permission-btn').addEventListener('click', async () => {
                if (!('Notification' in window)) { showToast('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚'); return; }
                const permission = await Notification.requestPermission();
                if (permission === 'granted') { showToast('é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸï¼'); new Notification('ã‚¯ã‚¤ã‚ºHPã¸ã‚ˆã†ã“ãï¼', { body: 'é€šçŸ¥è¨­å®šãŒã‚ªãƒ³ã«ãªã‚Šã¾ã—ãŸã€‚' }); $('#notification-settings-card').style.display = 'none';} 
                else { showToast('é€šçŸ¥ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ç«¯æœ«ã®è¨­å®šã‚¢ãƒ—ãƒªã‹ã‚‰å¤‰æ›´ã§ãã¾ã™ã€‚'); }
            });

            $$('.tab-btn').forEach(btn => btn.addEventListener('click', e => {
                const pageId = e.currentTarget.dataset.page;
                
                $$('.page').forEach(p => p.classList.remove('active'));
                $(`#${pageId}`).classList.add('active');
                
                $$('.tab-btn').forEach(b => b.classList.replace('primary-text', 'text-gray-500'));
                e.currentTarget.classList.replace('text-gray-500', 'primary-text');
                $('#header-title').textContent = e.currentTarget.dataset.title;
                if(renderEngine.pages[pageId]) { renderEngine.pages[pageId](); }
                if (pageId === 'focus-page') {
                    miniTimerTemporarilyHidden = false;
                }
                updateMiniTimer();
                lucide.createIcons();
            }));

            $('#mini-timer-bar').addEventListener('click', (e) => {
                if (e.target.closest('#close-mini-timer-btn')) return;
                document.querySelector('.tab-btn[data-page="focus-page"]').click();
            });

            $('#close-mini-timer-btn').addEventListener('click', () => {
                miniTimerTemporarilyHidden = true; // ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
                $('#mini-timer-container').classList.remove('visible'); // éè¡¨ç¤ºã«ã™ã‚‹
            });

            // --- Countdown Logic ---
            function openCountdownModal(id = null) {
                const modal = $('#countdown-modal');
                modal.dataset.editingId = id || '';
                const title = $('#countdown-modal-title');
                const deleteBtn = $('#countdown-delete-btn');
                const nameInput = $('#countdown-name');
                const dateInput = $('#countdown-date');
            
                if (id) {
                    title.textContent = 'ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã®ç·¨é›†';
                    deleteBtn.classList.remove('hidden');
                    const countdown = state.countdowns.find(c => c.id === id);
                    nameInput.value = countdown.name;
                    dateInput.value = countdown.date;
                    
                } else {
                    title.textContent = 'ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã®è¿½åŠ ';
                    deleteBtn.classList.add('hidden');
                    nameInput.value = '';
                    
                    const defaultDate = new Date();
                    defaultDate.setDate(defaultDate.getDate() + 14);
                    dateInput.value = defaultDate.toISOString().split('T')[0];

                }

                modal.style.display = 'flex';
                lucide.createIcons();

            }

            function saveCountdown() {
                const id = $('#countdown-modal').dataset.editingId;
                const name = $('#countdown-name').value.trim();
                const date = $('#countdown-date').value;

                if (!name || !date) {
                    showToast('ã‚¤ãƒ™ãƒ³ãƒˆåã¨æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }

                const countdownData = {
                    name,
                    date,
                };

                if (id) {
                    const index = state.countdowns.findIndex(c => c.id === id);
                    state.countdowns[index] = { ...state.countdowns[index], ...countdownData };
                } else {
                    countdownData.id = `cd_${Date.now()}`;
                    state.countdowns.push(countdownData);
                }

                state.countdowns.sort((a, b) => new Date(a.date) - new Date(b.date));
                saveState();
                renderEngine.pages['home-page']();
                lucide.createIcons();
                $('#countdown-modal').style.display = 'none';
            }
            
            function deleteCountdown() {
                // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¿½åŠ 
                if (!confirm('æœ¬å½“ã«ã“ã®ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                    return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã‚‰ã€ã“ã“ã§å‡¦ç†ã‚’çµ‚äº†
                }
            
                const id = $('#countdown-modal').dataset.editingId;
                state.countdowns = state.countdowns.filter(c => c.id !== id);
                saveState();
                renderEngine.pages['home-page']();
                lucide.createIcons();
                $('#countdown-modal').style.display = 'none';
            }

            /* â–¼â–¼â–¼ è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆæ©Ÿèƒ½ã®é–¢æ•°ç¾¤ â–¼â–¼â–¼ */

        // ã‚¯ã‚¨ã‚¹ãƒˆãƒ—ãƒ©ãƒ³ã®ãƒªã‚¹ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹é–¢æ•°
        function renderQuestPlan() {
            questPlanListEl.innerHTML = '';
            if (quest.plan.length === 0) {
                questPlanListEl.innerHTML = `<p class="text-center text-sm text-gray-500">ã€Œä»Šæ—¥ã®äºˆå®šã€ã‚’èª­ã¿è¾¼ã‚€ã‹ã€<br>ã€Œã‚»ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>`;
            }
            let sectionCounter = 1; // 1. ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’åˆæœŸåŒ–
            quest.plan.forEach((item, index) => {
                const itemEl = document.createElement('div');
                itemEl.className = 'flex items-center space-x-2 group bg-gray-100 dark:bg-gray-800 p-2 rounded-lg';
                itemEl.dataset.id = item.id;
                            
                let content = '';
                if (item.type === 'section') {
                    content = `
                        <span class="font-bold w-6 text-center">${sectionCounter}</span>
                        <input type="text" value="${item.text}" data-original-id="${item.originalTaskId || ''}" class="quest-item-text flex-grow bg-transparent p-1 rounded border border-transparent focus:border-gray-400 dark:focus:border-gray-500 focus:outline-none min-w-0 truncate">
                        <input type="number" value="${item.duration / 60}" class="quest-item-duration w-16 p-1 border rounded text-center dark:bg-gray-600 dark:border-gray-500">
                        <span class="text-sm">åˆ†</span>
                    `;
                    sectionCounter++; // 3. ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å ´åˆã®ã¿ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
                } else { // break
                    content = `
                        <span class="font-bold w-6 text-center">â˜•</span>
                        <span class="flex-grow p-1 text-gray-500 dark:text-gray-400 font-semibold">ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¤ãƒ </span>
                        <input type="number" value="${item.duration / 60}" class="quest-item-duration w-16 p-1 border rounded text-center dark:bg-gray-600 dark:border-gray-500">
                        <span class="text-sm">åˆ†</span>
                    `;
                }

                itemEl.innerHTML = `
                    ${content}
                    <button class="quest-handle cursor-move text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-opacity">
                        <i data-lucide="grip-vertical" class="w-5 h-5"></i>
                    </button>
                    <button class="delete-item-btn text-gray-400 hover:text-red-500 transition-opacity">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                `;
                questPlanListEl.appendChild(itemEl);

                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                itemEl.querySelector('.quest-item-text')?.addEventListener('change', (e) => {
                    item.text = e.target.value;
                    item.originalTaskId = e.target.dataset.originalId || null;
                });
                itemEl.querySelector('.quest-item-duration').addEventListener('change', (e) => {
                    item.duration = parseInt(e.target.value) * 60;
                });
                itemEl.querySelector('.delete-item-btn').addEventListener('click', () => {
                    quest.plan = quest.plan.filter(p => p.id !== item.id);
                    renderQuestPlan();
                });
            });
            lucide.createIcons();
        };

        // ã‚¯ã‚¨ã‚¹ãƒˆç”¨ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹ã™ã‚‹é–¢æ•°
        function startQuestTimer(duration, onTick, onEnd) {
            quest.timeLeft = duration;
            onTick(quest.timeLeft);
            quest.timerInterval = setInterval(() => {
                quest.timeLeft--;
                onTick(quest.timeLeft);
                if (quest.timeLeft <= 0) {
                    clearInterval(quest.timerInterval);
                    onEnd();
                }
            }, 1000);
        };

        // æ¬¡ã®ã‚¯ã‚¨ã‚¹ãƒˆã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè¡Œã™ã‚‹é–¢æ•°
        function runNextQuestStep() {
            quest.currentIndex++;
            if (quest.currentIndex >= quest.plan.length) {
                endQuest(true); // ã‚¯ã‚¨ã‚¹ãƒˆå®Œäº†
                return;
            }

            const currentStep = quest.plan[quest.currentIndex];
            
            // ã‚¢ãƒ—ãƒª2ã®ãƒˆãƒ¼ã‚¹ãƒˆé–¢æ•°ã¨Notification APIã‚’ä½¿ç”¨
Â  Â  Â  Â  Â  Â  const showQuestNotification = (title, body) => {
Â  Â  Â  Â  Â  Â  Â  Â  showToast(body);
Â  Â  Â  Â  Â  Â  Â  Â  if (Notification.permission === "granted") {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  new Notification(title, { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: body,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tag: 'quest-status'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };

            if (currentStep.type === 'section') {
                showQuestNotification('ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹', `ã€Œ${currentStep.text}ã€ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼`);
                questSectionView.style.display = 'block';
                questBreakView.style.display = 'none';
                $('#break-settings-btn').classList.add('hidden');
                questSectionTitle.textContent = currentStep.text;
                //questProgressEl.textContent = `${quest.currentIndex + 1} / ${quest.plan.length}`;
                // 1. ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—ã®ã‚¢ã‚¤ãƒ†ãƒ ã ã‘ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
Â  Â  Â  Â  Â  Â  Â  Â  const totalSections = quest.plan.filter(p => p.type === 'section').length;
Â  Â  Â  Â  Â  Â  Â  Â  // 2. ç¾åœ¨ã¾ã§ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒä½•ç•ªç›®ã‹ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
Â  Â  Â  Â  Â  Â  Â  Â  const currentSectionNumber = quest.plan.slice(0, quest.currentIndex + 1).filter(p => p.type === 'section').length;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // 3. ä¿®æ­£ã—ãŸãƒ­ã‚¸ãƒƒã‚¯ã§ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®š
Â  Â  Â  Â  Â  Â  Â  Â  questProgressEl.textContent = `${currentSectionNumber} / ${totalSections}`;
                
                startQuestTimer(
                    currentStep.duration,
                    (timeLeft) => { questTimerEl.textContent = formatTime(timeLeft); }, // æ—¢å­˜ã®formatTimeã‚’æµç”¨
                    () => {
                        const elapsed = currentStep.duration;
                        if (elapsed > 0) {
                            logStudyTime('focus', elapsed); // å­¦ç¿’ãƒ­ã‚°ã«è¨˜éŒ²
                            addLP(Math.floor(elapsed / 60), 'ã‚¯ã‚¨ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³'); // LPã‚’ä»˜ä¸
                            state.focus.totalTime += elapsed; // ç·é›†ä¸­æ™‚é–“ã«è¿½åŠ 
                            if (currentStep.originalTaskId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const taskId = parseInt(currentStep.originalTaskId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.tasks = state.tasks.filter(t => t.id !== taskId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log(`ã‚¿ã‚¹ã‚¯ID ${taskId} ã‚’å®Œäº†ã¨ã—ã¦å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
                            saveState(); // çŠ¶æ…‹ã‚’ä¿å­˜
                        }
                        showQuestNotification('ã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº†', 'ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ä¼‘æ†©ã«å…¥ã‚Šã¾ã™ã€‚');
                        runNextQuestStep();
                    }
                );
            } else { // break
Â  Â  Â  Â  Â  Â  Â  Â  showQuestNotification('ä¼‘æ†©æ™‚é–“', 'å°‘ã—ä¼‘ã¿ã¾ã—ã‚‡ã†ï¼');
Â  Â  Â  Â  Â  Â  Â  Â  questSectionView.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  questBreakView.style.display = 'block';
                $('#break-settings-btn').classList.remove('hidden');
                renderBreakIcons();
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // (breakContentSelector ã¨ breakSnsSelector ã®è¡Œã¯å‰Šé™¤)
Â  Â  Â  Â  Â  Â  Â  Â  startQuestTimer(
                    currentStep.duration,
                    (timeLeft) => {
                        breakTimerEl.textContent = formatTime(timeLeft);
                        if (timeLeft === 30) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showQuestNotification('ã¾ã‚‚ãªãä¼‘æ†©çµ‚äº†', '30ç§’å¾Œã«æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå§‹ã¾ã‚Šã¾ã™ã€‚');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
                    
                    () => {
                        showQuestNotification('ä¼‘æ†©çµ‚äº†', 'æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼');
                        
                        closeIframe();
                        runNextQuestStep();
                    }
                );
            }
            lucide.createIcons();
        };

        // ã‚¯ã‚¨ã‚¹ãƒˆã‚’é–‹å§‹ã™ã‚‹é–¢æ•°
        function startQuest() {
            if (quest.plan.length === 0) {
                showToast('ã‚¯ã‚¨ã‚¹ãƒˆã®äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            quest.active = true;
            quest.currentIndex = -1;
            questActiveScreen.style.display = 'flex';
            
            // ã‚¢ãƒ—ãƒª2ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã‚¿ãƒ–ãƒãƒ¼ã‚’éš ã™
            $('header').style.display = 'none';
            $('nav').style.display = 'none';
            $('#mini-timer-container').classList.remove('visible'); // ãƒŸãƒ‹ã‚¿ã‚¤ãƒãƒ¼ã‚‚éš ã™

            document.body.style.overflow = 'hidden';
            runNextQuestStep();
        };

        // ã‚¯ã‚¨ã‚¹ãƒˆã‚’çµ‚äº†ã™ã‚‹é–¢æ•°
        function endQuest(completed = false) {
            $('#break-settings-btn').classList.add('hidden');
            clearInterval(quest.timerInterval);
            if (!completed && quest.currentIndex >= 0 && quest.currentIndex < quest.plan.length) {
                const currentStep = quest.plan[quest.currentIndex];
                // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒ 'section' (å­¦ç¿’ä¸­) ã®å ´åˆã®ã¿è¨˜éŒ²
                if (currentStep.type === 'section') {
                    const elapsed = currentStep.duration - quest.timeLeft; // çµŒéæ™‚é–“
                    if (elapsed > 0) {
                        logStudyTime('focus', elapsed);
                        addLP(Math.floor(elapsed / 60), 'ã‚¯ã‚¨ã‚¹ãƒˆï¼ˆä¸­æ–­ï¼‰');
                        state.focus.totalTime += elapsed;
                        saveState();
                        showToast(`ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã® ${formatTime(elapsed)} ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚`);
                    }
                }
            }
            
            quest.active = false;
            questActiveScreen.style.display = 'none';

            // ã‚¢ãƒ—ãƒª2ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã‚¿ãƒ–ãƒãƒ¼ã‚’å†è¡¨ç¤º
            $('header').style.display = 'flex';
            $('nav').style.display = 'flex';

            document.body.style.overflow = 'auto';
            confirmationModal.style.display = 'none';
            closeIframe();
            if (completed) {
                showToast('ã‚¯ã‚¨ã‚¹ãƒˆå®Œäº†ï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼');
            }
        };

        // ä¼‘æ†©ç”¨iframeã‚’é–‹ã/é–‰ã˜ã‚‹é–¢æ•°
        function openIframe(url) {
            breakIframe.src = url;
            iframeOverlay.style.display = 'flex';
            lucide.createIcons(); // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’æç”»
        };

        function closeIframe() {
            breakIframe.src = 'about:blank';
            iframeOverlay.style.display = 'none';
        };
            
        // â˜…æ–°è¦è¿½åŠ â˜… ä¼‘æ†©ã‚¢ã‚¤ã‚³ãƒ³ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹é–¢æ•°
        function renderBreakIcons() {
            if (!breakIconGrid) return;
            // 1. stateã‹ã‚‰è¡¨ç¤ºãŒã‚ªãƒ³ã®ã‚¢ã‚¤ã‚³ãƒ³ã ã‘ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const visibleIcons = state.breakIcons.filter(icon => icon.visible);
            
            // 2. HTMLã‚’ç”Ÿæˆ
            breakIconGrid.innerHTML = visibleIcons.map(icon => `
                <button class="break-content-btn" data-url="${icon.url}" data-open-mode="${icon.openMode}" data-id="${icon.id}">
                    <i data-lucide="${icon.icon}" class="w-8 h-8 mb-1"></i>
                    <span>${icon.name}</span>
                </button>
            `).join('');
            
            lucide.createIcons(); // 3. ã‚¢ã‚¤ã‚³ãƒ³ã‚’å†æç”»
        }

        // â˜…æ–°è¦è¿½åŠ â˜… ä¼‘æ†©è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã®ä¸­èº«ã‚’æç”»ã™ã‚‹é–¢æ•°
        function renderBreakSettingsModal() {
            if (!breakSettingsListEl) return;
            
            // 1. stateã®å…¨ã‚¢ã‚¤ã‚³ãƒ³ãƒªã‚¹ãƒˆã‹ã‚‰HTMLã‚’ç”Ÿæˆ
            breakSettingsListEl.innerHTML = state.breakIcons.map(icon => `
                <div class="break-settings-item" data-id="${icon.id}">
                    <i data-lucide="grip-vertical" class="break-settings-handle"></i>
                    <span>${icon.name}</span>
                    <input type="checkbox" class="toggle-checkbox break-icon-toggle" ${icon.visible ? 'checked' : ''}>
                </div>
            `).join('');
            
            lucide.createIcons();
            
            // 2. ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            breakSettingsListEl.querySelectorAll('.break-icon-toggle').forEach(toggle => {
                toggle.addEventListener('change', (e) => {
                    const itemId = e.target.closest('.break-settings-item').dataset.id;
                    const icon = state.breakIcons.find(i => i.id === itemId);
                    if (icon) {
                        icon.visible = e.target.checked;
                        saveState(); // å¤‰æ›´ã‚’ä¿å­˜
                    }
                });
            });
            
            
        }

        // â˜…æ–°è¦è¿½åŠ â˜… ä¼‘æ†©è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãé–¢æ•°
        function openBreakSettingsModal() {
            renderBreakSettingsModal(); // 1. ä¸­èº«ã‚’æç”»
            $('#break-settings-modal').style.display = 'flex'; // 2. ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        }

        /* â–²â–²â–² è¿½åŠ : ã‚¯ã‚¨ã‚¹ãƒˆæ©Ÿèƒ½ã®é–¢æ•°ç¾¤ â–²â–²â–² */
        
            
            const restoreFocusState = () => {
            // ä¿å­˜ã•ã‚ŒãŸå®Ÿè¡Œä¸­ã®ã‚¿ã‚¤ãƒãƒ¼/SWãŒãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
            if (!state.focus.isRunning || !state.focus.startTime) {
                setTimer(1500); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®25åˆ†ã‚’ã‚»ãƒƒãƒˆ
                return;
            }
        
            const elapsed = Math.floor((Date.now() - state.focus.startTime) / 1000); // çµŒéæ™‚é–“ï¼ˆç§’ï¼‰
        
            // å¾©å…ƒã™ã‚‹ãƒ¢ãƒ¼ãƒ‰ã«åˆã‚ã›ã¦UIã‚’æ›´æ–°
            updateFocusModeUI();
        
            if (state.focus.mode === 'timer') {
                const timeLeft = state.focus.duration - elapsed;
        
                if (timeLeft <= 0) {
                    // å¾©å…ƒæ™‚ã«ã¯ã‚¿ã‚¤ãƒãƒ¼ãŒæ—¢ã«çµ‚äº†ã—ã¦ã„ã‚‹å ´åˆ
                    showToast('ã‚¿ã‚¤ãƒãƒ¼ã¯çµ‚äº†ã—ã¾ã—ãŸ');
                    logStudyTime('focus', state.focus.duration);
                    addLP(Math.floor(state.focus.duration / 60), 'ã‚¿ã‚¤ãƒãƒ¼å®Œäº†');
                    resetTimerUI();
                    // çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
                    state.focus.isRunning = false;
                    state.focus.startTime = null;
                    saveState();
                    setTimer(1500); // æ¬¡ã®ãŸã‚ã«ãƒªã‚»ãƒƒãƒˆ
                } else {
                    // ã‚¿ã‚¤ãƒãƒ¼ã‚’å¾©å…ƒ
                    focusTimer.timeLeft = timeLeft;
                    focusTimer.defaultTime = state.focus.duration;
                    focusTimer.isRunning = true;
        
                    $('#focus-timer-display').textContent = formatTime(timeLeft);
                    $('#focus-start-btn').classList.add('hidden');
                    $('#focus-controls').classList.remove('hidden');
                    $('#timer-settings-container').classList.add('hidden');
        
                    focusTimer.interval = setInterval(timerTick, 1000);
                    updateMiniTimer();
                }
            } else { // ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒã®å ´åˆ
                stopwatch.elapsedTime = elapsed;
                stopwatch.startTime = state.focus.startTime;
                stopwatch.isRunning = true;
        
                $('#stopwatch-display').textContent = formatStopwatchTime(elapsed);
                $('#stopwatch-start-btn').classList.add('hidden');
                $('#stopwatch-controls').classList.remove('hidden');
        
                stopwatch.interval = setInterval(stopwatchTick, 100);
                updateMiniTimer();
            }
        };

            const init = () => {
Â  Â  Â  Â  Â  Â  Â  Â  if ('serviceWorker' in navigator) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  navigator.serviceWorker.register('sw.js')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .then(registration => console.log('Service Workerç™»éŒ²æˆåŠŸ:', registration))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .catch(error => console.log('Service Workerç™»éŒ²å¤±æ•—:', error));
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  loadState();

                // 1. æ–°ã—ã„DOMè¦ç´ ã‚’å¤‰æ•°ã«å‰²ã‚Šå½“ã¦
                homeTaskListEl = $('#home-task-list');
                newTaskInput = $('#new-task-input');
                newTaskNumberEl = $('#new-task-number');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // ãƒšãƒ¼ã‚¸æç”»ã®å‰ã«ã‚¿ã‚¤ãƒãƒ¼ã®çŠ¶æ…‹ã‚’å¾©å…ƒãƒ»è¨­å®šã™ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  restoreFocusState();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // å…¨ã¦ã®ãƒšãƒ¼ã‚¸ã‚’æç”»
Â  Â  Â  Â  Â  Â  Â  Â  renderEngine.renderAll();
                
                // 2. Sortable.js ã®åˆæœŸåŒ– (ä»Šæ—¥ã®äºˆå®š)
                if (homeTaskListEl) {
                    Sortable.create(homeTaskListEl, {
                        handle: '.task-handle', // ä¸‰æœ¬ç·šã‚¢ã‚¤ã‚³ãƒ³ã§ãƒ‰ãƒ©ãƒƒã‚°
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        onEnd: (evt) => {
                            // state.tasks é…åˆ—ã‚’ä¸¦ã³æ›¿ãˆ
                            const item = state.tasks.splice(evt.oldIndex, 1)[0];
                            state.tasks.splice(evt.newIndex, 0, item);
                            saveState();
                            renderHomeTasks(); // ç•ªå·ã‚’æŒ¯ã‚Šç›´ã™ãŸã‚ã«å†æç”»
                        }
                    });

                    // 3. ã‚¿ã‚¹ã‚¯å‰Šé™¤ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (ã‚¤ãƒ™ãƒ³ãƒˆå§”ä»»)
                    homeTaskListEl.addEventListener('click', (e) => {
                        const deleteBtn = e.target.closest('.delete-task-btn');
                        if (deleteBtn) {
                            const taskItem = deleteBtn.closest('.task-item');
                            const taskId = parseInt(taskItem.dataset.id);
                            state.tasks = state.tasks.filter(t => t.id !== taskId);
                            saveState();
                            renderHomeTasks();
                        }
                    });
                }

                // 4. æ–°è¦ã‚¿ã‚¹ã‚¯è¿½åŠ  (Enterã‚­ãƒ¼)
                if (newTaskInput) {
                    newTaskInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && e.target.value.trim() !== '') {
                            state.tasks.push({ id: Date.now(), text: e.target.value.trim() });
                            e.target.value = '';
                            saveState();
                            renderHomeTasks();
                        }
                    });
                }

                 // Sortable.js ã®åˆæœŸåŒ– (ã‚¯ã‚¨ã‚¹ãƒˆãƒ—ãƒ©ãƒ³)
                    if (questPlanListEl) { // questPlanListEl ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§å®šç¾©æ¸ˆã¿
                        Sortable.create(questPlanListEl, {
                            handle: '.quest-handle', // ã‚¯ã‚¨ã‚¹ãƒˆã®ãƒãƒ³ãƒ‰ãƒ«
                            animation: 150,
                            ghostClass: 'sortable-ghost',
                            onEnd: (evt) => {
                                // quest.plan é…åˆ—ã‚’ä¸¦ã³æ›¿ãˆ
                                // (quest.plan ã¯ state ã«ä¿å­˜ã•ã‚Œãªã„ä¸€æ™‚çš„ãªã‚‚ã®)
                                const item = quest.plan.splice(evt.oldIndex, 1)[0];
                                quest.plan.splice(evt.newIndex, 0, item);
                                renderQuestPlan(); // ç•ªå·ã‚’æŒ¯ã‚Šç›´ã™ãŸã‚ã«å†æç”»
                            }
                        });
                    }
                // Sortable.js ã®åˆæœŸåŒ– (ä¼‘æ†©è¨­å®šãƒªã‚¹ãƒˆ)
Â  Â  Â  Â  Â  Â  Â  Â  if (breakSettingsListEl) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Sortable.create(breakSettingsListEl, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  handle: '.break-settings-handle',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  animation: 150,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ghostClass: 'sortable-ghost',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  delay: 100,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  delayOnTouchOnly: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  forceFallback: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onEnd: (evt) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ä¸¦ã³æ›¿ãˆå¾Œã®DOMã®é †ç•ªã‚’å…ƒã«IDã®é…åˆ—ã‚’ä½œæˆ
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const idOrder = Array.from(breakSettingsListEl.children).map(child => child.dataset.id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // state.breakIcons ã‚’ idOrder ã«åŸºã¥ã„ã¦ä¸¦ã³æ›¿ãˆã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.breakIcons.sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return idOrder.indexOf(a.id) - idOrder.indexOf(b.id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saveState(); // æ–°ã—ã„é †åºã‚’ä¿å­˜
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
                
                // 5. ã€Œä»Šæ—¥ã®äºˆå®šã€èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³
Â  Â  Â  Â  Â  Â  Â  Â  const loadTasksBtn = $('#load-tasks-btn');
Â  Â  Â  Â  Â  Â  Â  Â  if (loadTasksBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadTasksBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (state.tasks.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast('ã€Œä»Šæ—¥ã®äºˆå®šã€ã«ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quest.plan = []; // ãƒ—ãƒ©ãƒ³ã‚’ã‚¯ãƒªã‚¢
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // state.tasks ã‚’ quest.plan ã«ãƒãƒƒãƒ”ãƒ³ã‚°
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  quest.plan = state.tasks.map(task => ({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: Date.now() + Math.random(), // ã‚¯ã‚¨ã‚¹ãƒˆç”¨ã®ä¸€æ™‚ID
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type: 'section',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text: task.text,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  duration: 25 * 60, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ25åˆ†
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  originalTaskId: task.id // â˜…å…ƒã®ã‚¿ã‚¹ã‚¯IDã‚’ä¿æŒ
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast(`ã€Œä»Šæ—¥ã®äºˆå®šã€ã‹ã‚‰ ${state.tasks.length} ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ã‚¯ã‚¨ã‚¹ãƒˆãƒ—ãƒ©ãƒ³ã®UIã‚’å†æç”»
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderQuestPlan();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
                
Â  Â  Â  Â  Â  Â  Â  Â  // æœ€å¾Œã«å¤–è¦³ã‚’æ›´æ–°
Â  Â  Â  Â  Â  Â  Â  Â  $('#background-scope-toggle').checked = state.settings.backgroundScopeGlobal;
Â  Â  Â  Â  Â  Â  Â  Â  updateAppearance();
                // â–¼â–¼â–¼ å¤‰æ›´ï¼ˆinitã®æœ€å¾Œã«lucideã‚’1å›å®Ÿè¡Œï¼‰ â–¼â–¼â–¼
                lucide.createIcons();
Â  Â  Â  Â  Â  Â  };
            const renderPointModalContent = () => {
            const themeContainer = $('#modal-theme-selector');
            themeContainer.innerHTML = Object.entries(initialData.themes).map(([id, theme]) => {
                const isUnlocked = state.profile.unlockedThemes.includes(id);
                if (isUnlocked) {
                    return `<div class="text-center">
                        <button class="theme-btn w-12 h-12 rounded-full border-4 ${state.profile.activeTheme === id ? 'border-blue-500' : 'border-transparent'} relative" style="background-color: ${theme.color}" data-theme="${id}">
                            <div class="absolute inset-0 flex items-center justify-center rounded-full"><i data-lucide="check" class="w-6 h-6 text-white"></i></div>
                        </button>
                        <p class="text-xs mt-1">${theme.name}</p>
                    </div>`;
                } else {
                    return `<div class="text-center">
                        <button class="theme-btn w-12 h-12 rounded-full border-4 border-transparent relative" style="background-color: ${theme.color}" data-theme="${id}">
                            <div class="absolute inset-0 bg-black/60 flex flex-col items-center justify-center rounded-full text-white">
                                <i data-lucide="lock" class="w-5 h-5"></i>
                                <span class="text-[10px] font-bold">${theme.cost}</span>
                            </div>
                        </button>
                        <p class="text-xs mt-1">${theme.name}</p>
                    </div>`;
                }
            }).join('');

            const backgroundContainer = $('#modal-background-selector');
            backgroundContainer.innerHTML = Object.entries(initialData.backgrounds).map(([id, bg]) => {
                const isUnlocked = state.profile.unlockedBackgrounds.includes(id);
                const style = bg.url ? `background-image: url(${bg.url})` : 'background-color: #6b7280;';
                if (isUnlocked) {
                    return `<div class="text-center">
                        <button class="background-btn w-full h-20 rounded-lg border-4 ${state.profile.activeBackground === id ? 'border-blue-500' : 'border-transparent'} relative bg-cover bg-center" style="${style}" data-bg="${id}">
                             <div class="absolute inset-0 flex items-center justify-center rounded-md"><i data-lucide="check" class="w-8 h-8 text-white"></i></div>
                        </button>
                         <p class="text-xs mt-1">${bg.name}</p>
                    </div>`;
                } else {
                     return `<div class="text-center">
                        <button class="background-btn w-full h-20 rounded-lg border-4 border-transparent relative bg-cover bg-center" style="${style}" data-bg="${id}">
                             <div class="absolute inset-0 bg-black/60 flex flex-col items-center justify-center rounded-md text-white">
                                <i data-lucide="lock" class="w-6 h-6"></i>
                                <span class="text-sm font-bold">${bg.cost}</span>
                            </div>
                        </button>
                         <p class="text-xs mt-1">${bg.name}</p>
                    </div>`;
                }
            }).join('');

            lucide.createIcons();
        };
            
        // --- è³¼å…¥ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®ãƒœã‚¿ãƒ³ ---
        $('#theme-purchase-confirm').addEventListener('click', handlePurchase);
        $('#theme-purchase-cancel').addEventListener('click', () => {
            $('#theme-purchase-modal').style.display = 'none';
        });

        $('#background-purchase-confirm').addEventListener('click', handlePurchase);
        $('#background-purchase-cancel').addEventListener('click', () => {
            $('#background-purchase-modal').style.display = 'none';
        });

        // --- ãƒã‚¤ãƒ³ãƒˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ ---
        $('#close-point-modal-btn').addEventListener('click', () => {
            $('#point-details-modal').style.display = 'none';
        });

        // --- ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®ãƒœã‚¿ãƒ³ ---
        $('#add-countdown-btn').addEventListener('click', () => openCountdownModal());
        $('#countdown-save-btn').addEventListener('click', saveCountdown);
        $('#countdown-cancel-btn').addEventListener('click', () => {
            $('#countdown-modal').style.display = 'none';
        });
        $('#countdown-delete-btn').addEventListener('click', deleteCountdown);
            
            init();
        });
    </script>
</body>
</html>
