<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>クイズHP</title>

    <!-- PWA関連のメタデータ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="クイズHP">
    <meta name="application-name" content="クイズHP">
    <meta name="theme-color" content="#4a90e2">

    <!-- アイコン -->
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/4a90e2/ffffff?text=Q">

    <!-- 外部ライブラリとフォント -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* 基本スタイル */
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* PWAインストールボタンのスタイル */
        #install-button {
            display: none;
        }
        
        /* ページの表示/非表示を滑らかにする */
        .page {
            display: none;
        }
        .page.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* カスタムスクロールバー */
        ::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* iframeのローディングインジケーター */
        #loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #4a90e2;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 overflow-hidden h-screen">

    <div id="app-container" class="h-full w-full flex flex-col max-w-lg mx-auto bg-white dark:bg-gray-800 shadow-2xl">
        
        <!-- ヘッダー -->
        <header class="bg-white dark:bg-gray-800 shadow-md z-10 p-4 flex items-center justify-between border-b border-gray-200 dark:border-gray-700">
            <h1 id="header-title" class="text-xl font-bold text-gray-900 dark:text-white">ホーム</h1>
            <div id="header-icons" class="flex items-center space-x-4">
                 <button id="search-button" class="text-gray-600 dark:text-gray-300">
                    <i data-lucide="search" class="w-6 h-6"></i>
                </button>
            </div>
        </header>

        <!-- メインコンテンツ -->
        <main class="flex-grow overflow-y-auto pb-20">
            <!-- ホーム画面 -->
            <div id="home-page" class="page active p-4">
                <div id="pinned-section" class="mb-6">
                    <h2 class="text-lg font-semibold mb-3 text-gray-700 dark:text-gray-300 flex items-center">
                        <i data-lucide="pin" class="w-5 h-5 mr-2 text-blue-500"></i>
                        ピン留めしたクイズ
                    </h2>
                    <div id="pinned-quizzes" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                       <p id="no-pins-message" class="text-gray-500 dark:text-gray-400">クイズをピン留めして、すぐにアクセスしよう！</p>
                    </div>
                </div>
                <div>
                    <h2 class="text-lg font-semibold mb-3 text-gray-700 dark:text-gray-300 flex items-center">
                       <i data-lucide="book-marked" class="w-5 h-5 mr-2 text-blue-500"></i>
                        すべてのクイズ
                    </h2>
                    <div class="flex space-x-2 mb-4 overflow-x-auto pb-2">
                         <button class="filter-btn active bg-blue-500 text-white px-4 py-1.5 rounded-full text-sm font-medium" data-filter="all">すべて</button>
                         <button class="filter-btn bg-gray-200 dark:bg-gray-700 px-4 py-1.5 rounded-full text-sm font-medium" data-filter="国語">国語</button>
                         <button class="filter-btn bg-gray-200 dark:bg-gray-700 px-4 py-1.5 rounded-full text-sm font-medium" data-filter="数学">数学</button>
                         <button class="filter-btn bg-gray-200 dark:bg-gray-700 px-4 py-1.5 rounded-full text-sm font-medium" data-filter="英語">英語</button>
                         <button class="filter-btn bg-gray-200 dark:bg-gray-700 px-4 py-1.5 rounded-full text-sm font-medium" data-filter="理科">理科</button>
                         <button class="filter-btn bg-gray-200 dark:bg-gray-700 px-4 py-1.5 rounded-full text-sm font-medium" data-filter="社会">社会</button>
                    </div>
                    <div id="all-quizzes" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <!-- クイズカードはJSで生成 -->
                    </div>
                </div>
            </div>

            <!-- 教材ページ -->
            <div id="materials-page" class="page p-4">
                <h2 class="text-2xl font-bold mb-4">教材・資料</h2>
                <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                    <p class="text-gray-600 dark:text-gray-300">
                        ここは、クイズ以外の学習教材や資料を配置するページです。
                        <br><br>
                        例えば、重要な公式集のPDFへのリンクや、参考動画の埋め込みなどが考えられます。
                    </p>
                </div>
            </div>

            <!-- 設定ページ -->
            <div id="settings-page" class="page p-4">
                <h2 class="text-2xl font-bold mb-4">設定</h2>
                <div class="space-y-4">
                     <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                        <h3 class="font-semibold mb-2">通知設定</h3>
                        <button id="notification-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">
                            <i data-lucide="bell-ring" class="w-5 h-5 mr-2"></i>
                            通知を許可する
                        </button>
                    </div>
                    <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow">
                        <h3 class="font-semibold mb-2">アプリのインストール</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">このアプリをホーム画面に追加して、素早くアクセスできます。</p>
                        <button id="install-button" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center">
                            <i data-lucide="download-cloud" class="w-5 h-5 mr-2"></i>
                            ホーム画面に追加
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- タブバー -->
        <nav class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto h-16 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 flex justify-around items-center shadow-top z-20">
            <button class="tab-btn flex flex-col items-center justify-center text-blue-500" data-page="home-page" data-title="ホーム">
                <i data-lucide="home" class="w-6 h-6 mb-1"></i>
                <span class="text-xs font-medium">ホーム</span>
            </button>
            <button class="tab-btn flex flex-col items-center justify-center text-gray-500 dark:text-gray-400" data-page="materials-page" data-title="教材">
                <i data-lucide="folder" class="w-6 h-6 mb-1"></i>
                <span class="text-xs font-medium">教材</span>
            </button>
            <button class="tab-btn flex flex-col items-center justify-center text-gray-500 dark:text-gray-400" data-page="settings-page" data-title="設定">
                <i data-lucide="settings" class="w-6 h-6 mb-1"></i>
                <span class="text-xs font-medium">設定</span>
            </button>
        </nav>
    </div>

    <!-- クイズ表示用モーダル -->
    <div id="quiz-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex-col items-center justify-center hidden">
        <div class="w-full h-full max-w-lg bg-gray-100 dark:bg-gray-900 flex flex-col">
            <header class="bg-white dark:bg-gray-800 p-3 flex items-center justify-between shadow-md">
                <h2 id="quiz-title" class="text-lg font-bold text-gray-800 dark:text-gray-200 truncate">クイズを読み込み中...</h2>
                <button id="close-quiz-btn" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i data-lucide="x" class="w-6 h-6 text-gray-600 dark:text-gray-300"></i>
                </button>
            </header>
            <div class="flex-grow relative">
                <div id="loader-container" class="absolute inset-0 flex items-center justify-center bg-gray-100 dark:bg-gray-900">
                    <div id="loader"></div>
                </div>
                <iframe id="quiz-iframe" class="w-full h-full border-0" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
            </div>
        </div>
    </div>
    
    <!-- トースト通知 -->
    <div id="toast" class="fixed bottom-20 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50">
        <p id="toast-message"></p>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- データ定義 ---
            const quizzes = [
                // このデータは本来APIから取得しますが、今回はデモ用に直接定義します。
                // URLは実際のGoogle FormのURLに差し替えてください。
                { id: 1, title: "中学1年 数学 - 正負の数", subject: "数学", genre: "中1", url: "https://docs.google.com/forms/d/e/1FAIpQLSclW_A-1fwnE4bFpYp7qLgVwUa_3jX9sZ6cK8rB0oI1mN5n_Q/viewform?usp=sf_link" },
                { id: 2, title: "中学1年 英語 - be動詞", subject: "英語", genre: "中1", url: "https://docs.google.com/forms/d/e/1FAIpQLSclW_A-1fwnE4bFpYp7qLgVwUa_3jX9sZ6cK8rB0oI1mN5n_Q/viewform?usp=sf_link" },
                { id: 3, title: "中学2年 理科 - 化学反応", subject: "理科", genre: "中2", url: "https://docs.google.com/forms/d/e/1FAIpQLSclW_A-1fwnE4bFpYp7qLgVwUa_3jX9sZ6cK8rB0oI1mN5n_Q/viewform?usp=sf_link" },
                { id: 4, title: "高校1年 国語 - 古文基礎", subject: "国語", genre: "高1", url: "https://docs.google.com/forms/d/e/1FAIpQLSclW_A-1fwnE4bFpYp7qLgVwUa_3jX9sZ6cK8rB0oI1mN5n_Q/viewform?usp=sf_link" },
                { id: 5, title: "中学歴史 - 鎌倉時代", subject: "社会", genre: "歴史", url: "https://docs.google.com/forms/d/e/1FAIpQLSclW_A-1fwnE4bFpYp7qLgVwUa_3jX9sZ6cK8rB0oI1mN5n_Q/viewform?usp=sf_link" },
                { id: 6, title: "中学3年 数学 - 2次方程式", subject: "数学", genre: "中3", url: "https://docs.google.com/forms/d/e/1FAIpQLSclW_A-1fwnE4bFpYp7qLgVwUa_3jX9sZ6cK8rB0oI1mN5n_Q/viewform?usp=sf_link" },
                { id: 7, title: "高校2年 英語 - 関係代名詞", subject: "英語", genre: "高2", url: "https://docs.google.com/forms/d/e/1FAIpQLSclW_A-1fwnE4bFpYp7qLgVwUa_3jX9sZ6cK8rB0oI1mN5n_Q/viewform?usp=sf_link" },
            ];

            // --- DOM要素の取得 ---
            const allQuizzesContainer = document.getElementById('all-quizzes');
            const pinnedQuizzesContainer = document.getElementById('pinned-quizzes');
            const noPinsMessage = document.getElementById('no-pins-message');
            const headerTitle = document.getElementById('header-title');
            const quizModal = document.getElementById('quiz-modal');
            const quizIframe = document.getElementById('quiz-iframe');
            const quizTitle = document.getElementById('quiz-title');
            const loaderContainer = document.getElementById('loader-container');
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');

            // --- 状態管理 ---
            let pinnedQuizzes = JSON.parse(localStorage.getItem('pinnedQuizzes')) || [];
            let currentFilter = 'all';

            // --- PWA Service Worker & Manifest ---
            // manifest.jsonを動的に生成し、ファイルレスPWAを実現
            const manifest = {
                "name": "クイズHP",
                "short_name": "クイズHP",
                "start_url": ".",
                "display": "standalone",
                "background_color": "#f3f4f6",
                "theme_color": "#4a90e2",
                "description": "中学・高校の定期テスト対策クイズアプリ",
                "icons": [{
                    "src": "https://placehold.co/192x192/4a90e2/ffffff?text=Q",
                    "sizes": "192x192",
                    "type": "image/png"
                }, {
                    "src": "https://placehold.co/512x512/4a90e2/ffffff?text=Q",
                    "sizes": "512x512",
                    "type": "image/png"
                }]
            };
            const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
            const manifestURL = URL.createObjectURL(manifestBlob);
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = manifestURL;
            document.head.appendChild(link);

            // Service Workerを登録
            if ('serviceWorker' in navigator) {
                const swContent = `
                    const CACHE_NAME = 'quiz-hp-cache-v1';
                    const urlsToCache = [
                        '/',
                        '/index.html' // ルートをindex.htmlとしてキャッシュ
                    ];
                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache))
                        );
                    });
                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request).then(response => {
                                return response || fetch(event.request);
                            })
                        );
                    });
                `;
                const swBlob = new Blob([swContent], { type: 'application/javascript' });
                const swURL = URL.createObjectURL(swBlob);
                navigator.serviceWorker.register(swURL)
                    .then(registration => console.log('ServiceWorker registration successful with scope: ', registration.scope))
                    .catch(error => console.log('ServiceWorker registration failed: ', error));
            }
            
            // PWAインストールプロンプト
            let deferredPrompt;
            const installButton = document.getElementById('install-button');
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                installButton.style.display = 'flex';
                installButton.addEventListener('click', () => {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('User accepted the install prompt');
                        }
                        deferredPrompt = null;
                    });
                });
            });


            // --- レンダリング関数 ---
            const renderQuizzes = () => {
                // 全クイズ表示
                allQuizzesContainer.innerHTML = '';
                const filteredQuizzes = quizzes.filter(q => currentFilter === 'all' || q.subject === currentFilter);

                filteredQuizzes.forEach(quiz => {
                    const isPinned = pinnedQuizzes.includes(quiz.id);
                    const card = `
                        <div class="bg-white dark:bg-gray-700 rounded-lg shadow p-4 flex items-center justify-between quiz-card" data-url="${quiz.url}" data-title="${quiz.title}">
                            <div>
                                <h3 class="font-semibold text-gray-800 dark:text-gray-200">${quiz.title}</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">${quiz.subject} - ${quiz.genre}</p>
                            </div>
                            <button class="pin-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600" data-id="${quiz.id}">
                                <i data-lucide="pin" class="w-5 h-5 ${isPinned ? 'text-blue-500 fill-current' : 'text-gray-400'}"></i>
                            </button>
                        </div>
                    `;
                    allQuizzesContainer.insertAdjacentHTML('beforeend', card);
                });
                
                // ピン留めクイズ表示
                pinnedQuizzesContainer.innerHTML = '';
                if (pinnedQuizzes.length > 0) {
                    noPinsMessage.style.display = 'none';
                    const pinnedQuizObjects = pinnedQuizzes.map(id => quizzes.find(q => q.id === id)).filter(Boolean);
                    
                    pinnedQuizObjects.forEach(quiz => {
                        const card = `
                            <div class="bg-white dark:bg-gray-700 rounded-lg shadow p-4 flex items-center justify-between quiz-card" data-url="${quiz.url}" data-title="${quiz.title}">
                                <div>
                                    <h3 class="font-semibold text-gray-800 dark:text-gray-200">${quiz.title}</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">${quiz.subject} - ${quiz.genre}</p>
                                </div>
                                <button class="pin-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600" data-id="${quiz.id}">
                                    <i data-lucide="pin" class="w-5 h-5 text-blue-500 fill-current"></i>
                                </button>
                            </div>
                        `;
                        pinnedQuizzesContainer.insertAdjacentHTML('beforeend', card);
                    });
                } else {
                    noPinsMessage.style.display = 'block';
                }

                // アイコンを再描画
                lucide.createIcons();
            };
            
            // --- イベントハンドラ ---
            const handlePageChange = (e) => {
                const target = e.currentTarget;
                const pageId = target.dataset.page;
                const pageTitle = target.dataset.title;

                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');

                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('text-blue-500'));
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.add('text-gray-500', 'dark:text-gray-400'));
                
                target.classList.remove('text-gray-500', 'dark:text-gray-400');
                target.classList.add('text-blue-500');

                headerTitle.textContent = pageTitle;
            };

            const handleQuizClick = (e) => {
                const card = e.target.closest('.quiz-card');
                if (!card) return;

                // ピンボタンが押された場合はモーダルを開かない
                if (e.target.closest('.pin-btn')) {
                    e.stopPropagation();
                    const pinBtn = e.target.closest('.pin-btn');
                    togglePin(parseInt(pinBtn.dataset.id, 10));
                    return;
                }
                
                openQuiz(card.dataset.url, card.dataset.title);
            };

            const togglePin = (id) => {
                if (pinnedQuizzes.includes(id)) {
                    pinnedQuizzes = pinnedQuizzes.filter(pinnedId => pinnedId !== id);
                    showToast('ピン留めを解除しました');
                } else {
                    pinnedQuizzes.push(id);
                     showToast('クイズをピン留めしました！');
                }
                localStorage.setItem('pinnedQuizzes', JSON.stringify(pinnedQuizzes));
                renderQuizzes();
            };

            const openQuiz = (url, title) => {
                quizTitle.textContent = title;
                quizIframe.src = 'about:blank'; // Iframeをリセット
                loaderContainer.style.display = 'flex';
                quizIframe.style.visibility = 'hidden';
                quizModal.style.display = 'flex';
                
                // Google Formはiframe内での表示を拒否することがあるため、代替URLでデモ
                // 実際には、ご自身のGoogle FormのURLに差し替えてください
                // const embedUrl = url.replace('/viewform', '/viewform?embedded=true');
                quizIframe.src = url;

                quizIframe.onload = () => {
                    loaderContainer.style.display = 'none';
                    quizIframe.style.visibility = 'visible';
                };
            };
            
            const closeQuiz = () => {
                quizModal.style.display = 'none';
                quizIframe.src = 'about:blank';
            };
            
            const handleFilterClick = (e) => {
                const target = e.target.closest('.filter-btn');
                if (!target) return;
                
                currentFilter = target.dataset.filter;
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active', 'bg-blue-500', 'text-white');
                    btn.classList.add('bg-gray-200', 'dark:bg-gray-700');
                });
                target.classList.add('active', 'bg-blue-500', 'text-white');
                target.classList.remove('bg-gray-200', 'dark:bg-gray-700');
                
                renderQuizzes();
            }

            const showToast = (message) => {
                toastMessage.textContent = message;
                toast.classList.remove('opacity-0');
                setTimeout(() => {
                    toast.classList.add('opacity-0');
                }, 2000);
            };

            // --- 通知機能 ---
            const handleNotificationRequest = () => {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        showToast('通知が許可されました！');
                        new Notification("クイズHPへようこそ！", {
                            body: "新しいクイズが追加された時にお知らせします。",
                            icon: "https://placehold.co/192x192/4a90e2/ffffff?text=Q"
                        });
                    } else {
                        showToast('通知が拒否されました。');
                    }
                });
            };

            // --- イベントリスナーの設定 ---
            document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', handlePageChange));
            document.getElementById('all-quizzes').addEventListener('click', handleQuizClick);
            document.getElementById('pinned-quizzes').addEventListener('click', handleQuizClick);
            document.getElementById('close-quiz-btn').addEventListener('click', closeQuiz);
            document.querySelector('.flex.space-x-2').addEventListener('click', handleFilterClick);
            document.getElementById('notification-button').addEventListener('click', handleNotificationRequest);

            // --- 初期化処理 ---
            const init = () => {
                renderQuizzes();
                lucide.createIcons();
            };

            init();
        });
    </script>
</body>
</html>
